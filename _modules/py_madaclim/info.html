<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>py_madaclim.info &mdash; py-madaclim 0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            py-madaclim
          </a>
              <div class="version">
                0.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">py-madaclim</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">py_madaclim.info</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for py_madaclim.info</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">calendar</span> <span class="kn">import</span> <span class="n">month_name</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">import</span> <span class="nn">pyproj</span>

<span class="kn">from</span> <span class="nn">py_madaclim._constants</span> <span class="kn">import</span> <span class="n">Constants</span>


<div class="viewcode-block" id="MadaclimLayers"><a class="viewcode-back" href="../../py_madaclim.html#py_madaclim.info.MadaclimLayers">[docs]</a><span class="k">class</span> <span class="nc">MadaclimLayers</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that represents all of the information and data from the climate</span>
<span class="sd">    and environmental variable layers that can be found from the rasters of</span>
<span class="sd">    the Madaclim database.</span>

<span class="sd">    The main metadata retrieval tool for the Madaclim database. Access all layers information with the `all_layers` attribute.</span>
<span class="sd">    Also provides methods to filter, generate unique labels from the `all_layers` attr.</span>
<span class="sd">    Access the crs and band number from the climate and environmental rasters when they are provided in the constructor.</span>
<span class="sd">    Categorical data can be explored in details with the `categorical_layers` attribute and the value:category pairs with the `get_categorical_combinations`.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        clim_raster (pathlib.Path): The path to the Madaclim climate raster GeoTiff file. Defaults to None if not specified.</span>
<span class="sd">        env_raster (pathlib.Path): The path to the Madaclim environmental raster GeoTif file. Defaults to None if not specified.</span>
<span class="sd">        all_layers (pd.DataFrame): A DataFrame containing a complete and formatted version of all Madaclim layers.</span>
<span class="sd">        categorical_layers (pd.DataFrame):  A DataFrame containing the in depth information about the layers with categorical data.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clim_raster</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">env_raster</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes a new instance of the MadaclimLayers class.</span>

<span class="sd">        This constructor generates a DataFrame containing all Madaclim layers&#39; information though the `all_layers` attribute.</span>
<span class="sd">            If given the current climate or environmental raster from the Madaclim db, it will also get the CRS for each raster.</span>
<span class="sd">            The instance can also access various methods to extract relevant information from the Madaclim database.</span>

<span class="sd">        </span>
<span class="sd">        Examples:</span>
<span class="sd">            Instantiate the MadaclimLayers without the rasters</span>

<span class="sd">            &gt;&gt;&gt; from py_madaclim.info import MadaclimLayers</span>
<span class="sd">            &gt;&gt;&gt; mada_info = MadaclimLayers()</span>
<span class="sd">            &gt;&gt;&gt; print(mada_info)</span>
<span class="sd">            MadaclimLayers(</span>
<span class="sd">                all_layers = DataFrame(79 rows x 6 columns)</span>
<span class="sd">                categorical_layers = DataFrame(Layers 75, 76, 77, 78 with a total of 79 categories</span>
<span class="sd">                public methods -&gt; download_data, fetch_specific_layers, get_categorical_combinations</span>
<span class="sd">                        get_layers_labels, select_geoclim_type_layers</span>
<span class="sd">            )</span>
<span class="sd">            </span>
<span class="sd">            Full method access when instantiating with the rasters</span>

<span class="sd">            &gt;&gt;&gt; mada_info_rasters = MadaclimLayers(clim_raster=&quot;madaclim_current.tif&quot;, env_raster=&quot;madaclim_enviro.tif&quot;)</span>
<span class="sd">            &gt;&gt;&gt; print(mada_info_rasters)</span>
<span class="sd">            MadaclimLayers(</span>
<span class="sd">            all_layers = DataFrame(79 rows x 6 columns)</span>
<span class="sd">            categorical_layers = DataFrame(Layers 75, 76, 77, 78 with a total of 79 categories</span>
<span class="sd">            clim_raster = madaclim_current.tif</span>
<span class="sd">            clim_crs = EPSG:32738</span>
<span class="sd">            env_raster = madaclim_enviro.tif</span>
<span class="sd">            env_crs = EPSG:32738</span>
<span class="sd">            public methods -&gt; download_data, fetch_specific_layers, get_bandnums_from_layers</span>
<span class="sd">                    get_categorical_combinations, get_layers_labels, select_geoclim_type_layers</span>
<span class="sd">        )</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clim_raster</span> <span class="o">=</span> <span class="n">clim_raster</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env_raster</span> <span class="o">=</span> <span class="n">env_raster</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_clim_dataformat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_dataformat</span><span class="p">(</span><span class="n">Constants</span><span class="o">.</span><span class="n">CLIM_DATAFORMAT_FILE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clim_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_metadata</span><span class="p">(</span><span class="n">Constants</span><span class="o">.</span><span class="n">CLIM_METADATA_FILE</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_env_dataformat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_dataformat</span><span class="p">(</span><span class="n">Constants</span><span class="o">.</span><span class="n">ENV_DATAFORMAT_FILE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_metadata</span><span class="p">(</span><span class="n">Constants</span><span class="o">.</span><span class="n">ENV_METADATA_FILE</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_madaclim_layers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_categorical_layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_categorical_df</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">clim_raster</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;pathlib.Path: Get or set the path to the climate raster file.</span>

<span class="sd">        This property allows you to get the current path to the climate raster file, or set a new</span>
<span class="sd">            path. If setting a new path, the value must be a pathlib.Path object or a str. If the value</span>
<span class="sd">            is a str, it will be converted to a pathlib.Path object. The path must exist, otherwise a</span>
<span class="sd">            FileNotFoundError will be raised.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The current path to the climate raster file.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the new path is not a pathlib.Path object or str.</span>
<span class="sd">            ValueError: If the new path cannot be converted to a pathlib.Path object.</span>
<span class="sd">            FileNotFoundError: If the new path does not exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clim_raster</span>
    
    <span class="nd">@clim_raster</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">clim_raster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clim_raster</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Validate type</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;clim_raster must be a pathlib.Path object or str.&quot;</span><span class="p">)</span>

            <span class="c1"># Validate path and file</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not create a pathlib.Path object from </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> does not exists.&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_clim_raster</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">env_raster</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;pathlib.Path: Get or set the path to the environment raster file.</span>

<span class="sd">        This property allows you to get the current path to the environment raster file, or set a new</span>
<span class="sd">            path. If setting a new path, the value must be a pathlib.Path object or a str. If the value </span>
<span class="sd">            is a str, it will be converted to a pathlib.Path object. The path must exist, otherwise a </span>
<span class="sd">            FileNotFoundError will be raised.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The current path to the environment raster file.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the new path is not a pathlib.Path object or str.</span>
<span class="sd">            ValueError: If the new path cannot be converted to a pathlib.Path object.</span>
<span class="sd">            FileNotFoundError: If the new path does not exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_raster</span>

    <span class="nd">@env_raster</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">env_raster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_env_raster</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Validate type</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;env_raster must be a pathlib.Path object or str.&quot;</span><span class="p">)</span>
            
            <span class="c1"># Validate path and file</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not create a pathlib.Path object from </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> does not exists.&quot;</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">_env_raster</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">clim_crs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">CRS</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the Coordinate Reference System (CRS) from the Madaclim climate raster.</span>

<span class="sd">        This property first validates the `clim_raster` attribute, ensuring its integrity and existence. </span>
<span class="sd">            It then opens the raster file and retrieves the CRS in EPSG format. The EPSG code is used to </span>
<span class="sd">            create and return a pyproj CRS object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pyproj.crs.crs.CRS: The CRS object derived from the EPSG code of the climate raster.</span>

<span class="sd">        Example:</span>
<span class="sd">            Valid &#39;clim_raster&#39; attribute before accessing the &#39;clim_crs&#39; attr.</span>

<span class="sd">            &gt;&gt;&gt; mada_info = MadaclimLayers()</span>
<span class="sd">            &gt;&gt;&gt; mada_info.clim_crs</span>
<span class="sd">            Traceback (most recent call last):</span>
<span class="sd">                raise AttributeError(f&quot;Undefined attribute: &#39;{raster_attr_name}&#39;. You need to assign a valid pathlib.Path to the related raster attribute first.&quot;)</span>
<span class="sd">            AttributeError: Undefined attribute: &#39;clim_raster&#39;. You need to assign a valid pathlib.Path to the related raster attribute first.</span>
<span class="sd">            &gt;&gt;&gt; mada_info.clim_raster = Path(&quot;./madaclim_current.tif&quot;)</span>
<span class="sd">            &gt;&gt;&gt; print(mada_info.clim_crs)</span>
<span class="sd">            EPSG:32738</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Validate raster attr value, IO path, integrity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_raster</span><span class="p">(</span><span class="s2">&quot;clim_raster&quot;</span><span class="p">)</span>
        
        <span class="c1"># Get epsg from clim_raster</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clim_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">clim_raster</span><span class="p">:</span>
            <span class="n">clim_epsg</span> <span class="o">=</span> <span class="n">clim_raster</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">to_epsg</span><span class="p">()</span>  <span class="c1"># Get the EPSG code of the CRS</span>
            <span class="n">clim_crs</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="o">.</span><span class="n">from_epsg</span><span class="p">(</span><span class="n">clim_epsg</span><span class="p">)</span>  <span class="c1"># Create a pyproj CRS object</span>
        <span class="k">return</span> <span class="n">clim_crs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">env_crs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">CRS</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the Coordinate Reference System (CRS) from the Madaclim environmental raster.</span>

<span class="sd">        This property first validates the `env_raster` attribute, ensuring its integrity and existence. </span>
<span class="sd">        It then opens the raster file and retrieves the CRS in EPSG format. The EPSG code is used to </span>
<span class="sd">        create and return a pyproj CRS object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pyproj.crs.crs.CRS: The CRS object derived from the EPSG code of the environmental raster.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            Valid &#39;env_raster&#39; attribute before accessing the &#39;env_crs&#39; attr.</span>

<span class="sd">            &gt;&gt;&gt; mada_info = MadaclimLayers()</span>
<span class="sd">            &gt;&gt;&gt; mada_info.env_crs</span>
<span class="sd">            Traceback (most recent call last):</span>
<span class="sd">                raise AttributeError(f&quot;Undefined attribute: &#39;{raster_attr_name}&#39;. You need to assign a valid pathlib.Path to the related raster attribute first.&quot;)</span>
<span class="sd">            AttributeError: Undefined attribute: &#39;env_raster&#39;. You need to assign a valid pathlib.Path to the related raster attribute first.</span>
<span class="sd">            &gt;&gt;&gt; mada_info.env_raster = Path(&quot;./madaclim_current.tif&quot;)</span>
<span class="sd">            &gt;&gt;&gt; print(mada_info.env_crs)</span>
<span class="sd">            EPSG:32738</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Validate raster attr value, IO path, integrity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_raster</span><span class="p">(</span><span class="s2">&quot;env_raster&quot;</span><span class="p">)</span>
        
        <span class="c1"># Get epsg from env_raster</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">env_raster</span><span class="p">:</span>
            <span class="n">env_epsg</span> <span class="o">=</span> <span class="n">env_raster</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">to_epsg</span><span class="p">()</span>  <span class="c1"># Get the EPSG code of the CRS</span>
            <span class="n">env_crs</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="o">.</span><span class="n">from_epsg</span><span class="p">(</span><span class="n">env_epsg</span><span class="p">)</span>  <span class="c1"># Create a pyproj CRS object</span>
        <span class="k">return</span> <span class="n">env_crs</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the &#39;all_layers&#39; Dataframe using the private &#39;_get_madaclim_layers&#39; method.</span>

<span class="sd">        Contains all information about all the raster layers in the Madaclim db.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: A DataFrame containing a complete and formatted version of all Madaclim layers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_layers</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">categorical_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the &#39;categorical_layers&#39; Dataframe using the private &#39;_get_categorical_df&#39; method.</span>

<span class="sd">        Contains detailed information about the categorical layers from the rasters in the Madaclim db.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: A DataFrame containing information for each categorical value in each layer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_categorical_layers</span>
    
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prints the `MadaclimLayers` instance&#39;s attributes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: All the object&#39;s attributes as attr_name for keys and attr_value for values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">categ_layer_nums</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_categorical_layers</span><span class="p">[</span><span class="s1">&#39;layer_number&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        
        <span class="n">custom_public_methods</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">attr_passed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">attr_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="n">attr_passed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">attr_val</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">attr_passed</span> <span class="ow">and</span>
                <span class="nb">callable</span><span class="p">(</span><span class="n">attr_val</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span>
                    <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)):</span>
                <span class="n">custom_public_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="c1"># Remove raster specific methods if not present in instance</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">clim_raster</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_raster</span><span class="p">:</span>
            <span class="n">raster_specif_pub_meth</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;get_bandnums_from_layers&quot;</span><span class="p">]</span> 
            <span class="n">custom_public_methods</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">method</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">custom_public_methods</span> <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">raster_specif_pub_meth</span>
            <span class="p">]</span>
        
        <span class="n">clim_raster_info</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">clim_raster = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">clim_raster</span><span class="o">.</span><span class="n">name</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">clim_raster</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">clim_crs = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">clim_crs</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">clim_raster</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clim_raster</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">env_raster_info</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">env_raster = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env_raster</span><span class="o">.</span><span class="n">name</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">env_raster</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">env_crs = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env_crs</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">env_raster</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_raster</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="n">base_info</span> <span class="o">=</span> <span class="p">(</span>
            
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">all_layers = </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_layers</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_layers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> rows x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_layers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> columns)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">categorical_layers = </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_categorical_layers</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(Layers </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">categ_layer_nums</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;with a total of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_categorical_layers</span><span class="p">)</span><span class="si">}</span><span class="s2"> categories</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">clim_raster_info</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env_raster_info</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">public methods -&gt; </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">custom_public_methods</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">custom_public_methods</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">full_info</span> <span class="o">=</span> <span class="s2">&quot;MadaclimLayers(</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">base_info</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
        <span class="k">return</span> <span class="n">full_info</span>
    
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

<div class="viewcode-block" id="MadaclimLayers.select_geoclim_type_layers"><a class="viewcode-back" href="../../py_madaclim.html#py_madaclim.info.MadaclimLayers.select_geoclim_type_layers">[docs]</a>    <span class="k">def</span> <span class="nf">select_geoclim_type_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geoclim_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method that selects the desired geoclimatic type layers as a dataframe.</span>

<span class="sd">        Args:</span>
<span class="sd">            geoclim_type (str): The desired geoclimatic layers type to extract.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: A slice of the `all_layers` dataframe containing the desired geoclimatic type layers.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If geoclim_type is not a string.</span>
<span class="sd">            ValueError: If geoclim_type does not corresponds to a valid geoclim type.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_layers_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_layers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Validate geoclim_type</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geoclim_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;geoclim_type must be a string.&quot;</span><span class="p">)</span>
        
        <span class="n">possible_geoclim_types</span> <span class="o">=</span> <span class="n">all_layers_df</span><span class="p">[</span><span class="s2">&quot;geoclim_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> 
        <span class="k">if</span> <span class="n">geoclim_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">possible_geoclim_types</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;geoclim_type must be one of </span><span class="si">{</span><span class="n">possible_geoclim_types</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">select_df</span> <span class="o">=</span> <span class="n">all_layers_df</span><span class="p">[</span><span class="n">all_layers_df</span><span class="p">[</span><span class="s2">&quot;geoclim_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">geoclim_type</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">select_df</span></div>
    
<div class="viewcode-block" id="MadaclimLayers.get_layers_labels"><a class="viewcode-back" href="../../py_madaclim.html#py_madaclim.info.MadaclimLayers.get_layers_labels">[docs]</a>    <span class="k">def</span> <span class="nf">get_layers_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layers_subset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">as_descriptive_labels</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves unique layer labels based on the provided subset of layers.</span>

<span class="sd">        This method fetches the unique labels from the `all_layers` dataframe, </span>
<span class="sd">        given a subset of layers (specified as either layer numbers, a geoclim_type, or a single layer number).</span>
<span class="sd">        The layer labels can be returned in a descriptive format if `as_descriptive_labels` is set to True.</span>

<span class="sd">        Args:</span>
<span class="sd">            layers_subset (Optional[Union[str, List[int]]], optional): A list of layer numbers or a geoclim_type string </span>
<span class="sd">                to subset the labels from, or a single layer number as a string or int. Defaults to None, which will </span>
<span class="sd">                select all layers (no subset).</span>
<span class="sd">            as_descriptive_labels (bool, optional): If True, returns the descriptive layer labels. Otherwise, returns </span>
<span class="sd">                the &quot;layer_&lt;num&gt;&quot; format. Defaults to False.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If elements of `layers_subset` cannot be converted to int.</span>
<span class="sd">            ValueError: If `layers_subset` is a string not in `possible_geoclim_types`, cannot be converted to int, </span>
<span class="sd">                or if the &#39;layer_number&#39; and &#39;layer_name&#39; columns in the `all_layers` dataframe have non-unique entries.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of unique layer labels. These labels are either in the &quot;layer_&lt;num&gt;&quot; format or the descriptive format, </span>
<span class="sd">            based on `as_descriptive_labels`.</span>
<span class="sd">        </span>
<span class="sd">        Examples:</span>
<span class="sd">            Get labels for all layers</span>

<span class="sd">            &gt;&gt;&gt; mada_info = MadaclimLayers()</span>
<span class="sd">            &gt;&gt;&gt; all_layers = mada_info.get_layers_labels()</span>
<span class="sd">            &gt;&gt;&gt; len(all_layers)</span>
<span class="sd">            79</span>
<span class="sd">            &gt;&gt;&gt; # Basic format &#39;layer_&lt;num&gt;&#39;</span>
<span class="sd">            &gt;&gt;&gt; all_layers[:5]</span>
<span class="sd">            [&#39;layer_1&#39;, &#39;layer_2&#39;, &#39;layer_3&#39;, &#39;layer_4&#39;, &#39;layer_5&#39;]</span>

<span class="sd">            Specify a geoclim subset</span>

<span class="sd">            &gt;&gt;&gt; env_layers = mada_info.get_layers_labels(layers_subset=&quot;env&quot;)</span>
<span class="sd">            &gt;&gt;&gt; env_layers</span>
<span class="sd">            [&#39;layer_71&#39;, &#39;layer_72&#39;, &#39;layer_73&#39;, &#39;layer_74&#39;, &#39;layer_75&#39;, &#39;layer_76&#39;, &#39;layer_77&#39;, &#39;layer_78&#39;, &#39;layer_79&#39;]</span>
<span class="sd">            </span>
<span class="sd">            Extract more information</span>

<span class="sd">            &gt;&gt;&gt; informative_labels = mada_info.get_layers_labels(as_descriptive_labels=True)</span>
<span class="sd">            &gt;&gt;&gt; informative_labels[:2]</span>
<span class="sd">            [&#39;clim_1_tmin1_Monthly minimum temperature - January (°C x 10)&#39;, &#39;clim_2_tmin2_Monthly minimum temperature - February (°C x 10)&#39;]</span>

<span class="sd">            Specify a single layer or a subset of layers</span>

<span class="sd">            &gt;&gt;&gt; mada_info.get_layers_labels(37, as_descriptive_labels=True)</span>
<span class="sd">            [&#39;clim_37_bio1_Annual mean temperature (degrees)&#39;]</span>
<span class="sd">            &gt;&gt;&gt; mada_info.get_layers_labels([68, 75], as_descriptive_labels=True)</span>
<span class="sd">            [&#39;clim_68_pet_Annual potential evapotranspiration from the Thornthwaite equation (mm)&#39;, &#39;env_75_geo_Rock types (categ_vals: 1, 2, 4, 5, 6, 7, 9, 10, 11, 12, 13)&#39;]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_layers_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_layers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">layers_numbers</span> <span class="o">=</span> <span class="n">all_layers_df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="n">possible_geoclim_types</span> <span class="o">=</span> <span class="n">all_layers_df</span><span class="p">[</span><span class="s2">&quot;geoclim_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>


        <span class="c1"># Convert layers_subset to a list of ints for all inputs</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers_subset</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">layers_subset</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers_subset</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;layers_subet&#39; list elements must be int or can be converted to int.&quot;</span><span class="p">)</span>
            
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers_subset</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
            <span class="c1"># Extract layer num if layers_subset is a geoclim_type</span>
            <span class="k">if</span> <span class="n">layers_subset</span> <span class="ow">in</span> <span class="n">possible_geoclim_types</span><span class="p">:</span>
                <span class="n">layers_subset</span> <span class="o">=</span> <span class="n">all_layers_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_layers_df</span><span class="p">[</span><span class="s2">&quot;geoclim_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">layers_subset</span><span class="p">,</span> <span class="s2">&quot;layer_number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">layers_subset</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">layers_subset</span><span class="p">)]</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;layers_subset&#39; must be an int (or can be converted to int) or be one of </span><span class="si">{</span><span class="n">possible_geoclim_types</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">layers_subset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">layers_subset</span> <span class="o">=</span> <span class="n">layers_numbers</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;layers_subset&#39; must be a str, int or a list of str or ints.&quot;</span><span class="p">)</span>

        <span class="c1"># Validate layer number range for layer_numbers as in</span>
        <span class="n">min_layer</span><span class="p">,</span> <span class="n">max_layer</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">layers_numbers</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">layers_numbers</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">layer_number</span> <span class="ow">in</span> <span class="n">layers_subset</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">min_layer</span> <span class="o">&lt;=</span> <span class="n">layer_number</span> <span class="o">&lt;=</span> <span class="n">max_layer</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;layer_number must fall between </span><span class="si">{</span><span class="n">min_layer</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">max_layer</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">layer_number</span><span class="si">=}</span><span class="s2"> is not valid.&quot;</span><span class="p">)</span>
            
        <span class="c1"># Validate unique entries</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_layers_df</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_layers_df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_layers_df</span><span class="p">[</span><span class="s2">&quot;layer_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;layer_number&#39; and &#39;layer_name&#39; columns in the all_layers dataframe have non-unique entries.&quot;</span><span class="p">)</span>
        
         <span class="c1"># Fetch rows according to layers_subset</span>
        <span class="n">select_df</span> <span class="o">=</span> <span class="n">all_layers_df</span><span class="p">[</span><span class="n">all_layers_df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">layers_subset</span><span class="p">)]</span>
        
        <span class="c1"># Fetch layer_&lt;num&gt; and descriptive labels</span>
        <span class="n">sub_selection</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span>
                <span class="n">select_df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">],</span> 
                <span class="n">select_df</span><span class="p">[</span><span class="s2">&quot;geoclim_type&quot;</span><span class="p">],</span> 
                <span class="n">select_df</span><span class="p">[</span><span class="s2">&quot;layer_name&quot;</span><span class="p">],</span> 
                <span class="n">select_df</span><span class="p">[</span><span class="s2">&quot;layer_description&quot;</span><span class="p">],</span> 
                <span class="n">select_df</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">layers_description</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">geoclim</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">sub_selection</span><span class="p">:</span>
            <span class="c1"># Simplify units from &#39;all_layers&#39; for categorical</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;categ_vals: &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ele</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">unit</span><span class="p">])</span>
            <span class="n">layers_description</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;layer_</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">geoclim</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">)&quot;</span>
        
        <span class="k">if</span> <span class="n">as_descriptive_labels</span><span class="p">:</span>
            <span class="n">unique_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">layers_description</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unique_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">layers_description</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="k">return</span> <span class="n">unique_labels</span></div>
        

<div class="viewcode-block" id="MadaclimLayers.fetch_specific_layers"><a class="viewcode-back" href="../../py_madaclim.html#py_madaclim.info.MadaclimLayers.fetch_specific_layers">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_specific_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layers_labels</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]],</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetches specific layers from the `all_layers` DataFrame based on the given input and returns either the entire rows or </span>
<span class="sd">        certain columns as a dictionary. </span>

<span class="sd">        Args:</span>
<span class="sd">            layers_labels (Union[int, str, List[Union[int, str]]]): The layer labels to fetch. Can be a single int or str value,</span>
<span class="sd">                or a list of int or str values. The input can also be in the format &quot;layer_{num}&quot; or </span>
<span class="sd">                &quot;{geotype}_{num}_{name}_({description})&quot; (output from `get_layers_labels(as_descriptive_labels=True)` method).</span>
<span class="sd">            *args (str): Optional. One or more column names in `all_layers` DataFrame. If specified, only these columns</span>
<span class="sd">            will be returned as a dictionary.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[dict, pd.DataFrame]: If `args` is specified, returns a nested dictionary with the format:</span>
<span class="sd">                {</span>
<span class="sd">                    layer_&lt;num&gt;: {</span>
<span class="sd">                        &lt;arg1&gt;: &lt;value&gt;,</span>
<span class="sd">                        &lt;arg2&gt;: &lt;value&gt;,</span>
<span class="sd">                        ...</span>
<span class="sd">                    },</span>
<span class="sd">                    ...</span>
<span class="sd">                }</span>
<span class="sd">                Otherwise, returns a DataFrame with the specified layers.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If any value in layers_labels cannot be converted to an int or is not in the &quot;layer_{num}&quot; format.</span>
<span class="sd">            ValueError: If any layer_number does not fall between the minimum and maximum layer numbers.</span>
<span class="sd">            KeyError: If any value in args is not a column in `all_layers` DataFrame.</span>

<span class="sd">        Examples:</span>
<span class="sd">            Using a list of layer numbers</span>

<span class="sd">            &gt;&gt;&gt; mada_info = MadaclimLayers()</span>
<span class="sd">            &gt;&gt;&gt; mada_info.fetch_specific_layers([1, 15, 55, 71])</span>
<span class="sd">               geoclim_type  layer_number layer_name                      layer_description  is_categorical         units</span>
<span class="sd">            0          clim             1      tmin1  Monthly minimum temperature - January           False       °C x 10</span>
<span class="sd">            14         clim            15      tmax3    Monthly maximum temperature - March           False       °C x 10</span>
<span class="sd">            54         clim            55      bio19       Precipitation of coldest quarter           False  mm.3months-1</span>
<span class="sd">            70          env            71        alt                               Altitude           False        meters</span>

<span class="sd">            Using the output from `get_layers_labels` method</span>

<span class="sd">            &gt;&gt;&gt; bioclim_labels = [label for label in mada_info.get_layers_labels(as_descriptive_labels=True) if &quot;bio&quot; in label]</span>
<span class="sd">            &gt;&gt;&gt; bio1_bio2_labels = bioclim_labels[0:3]</span>
<span class="sd">            &gt;&gt;&gt; mada_info.fetch_specific_layers(bio1_bio2_labels)</span>
<span class="sd">            geoclim_type  layer_number layer_name                 layer_description  is_categorical                                       units</span>
<span class="sd">            36         clim            37       bio1           Annual mean temperature           False                                     degrees</span>
<span class="sd">            37         clim            38       bio2                Mean diurnal range           False  mean of monthly max temp - monthy min temp</span>

<span class="sd">            &gt;&gt;&gt; # Or from descriptive_labels as well</span>
<span class="sd">            &gt;&gt;&gt; pet_layers = [label for label in mada_info.get_layers_labels(as_descriptive_labels=True) if &quot;pet&quot; in label]</span>
<span class="sd">            &gt;&gt;&gt; len(pet_layers)</span>
<span class="sd">            13</span>
<span class="sd">            &gt;&gt;&gt; mada_info.fetch_specific_layers(pet_layers[-1])</span>
<span class="sd">               geoclim_type  layer_number layer_name                                  layer_description  is_categorical units</span>
<span class="sd">            67         clim            68        pet  Annual potential evapotranspiration from the T...           False    mm</span>
<span class="sd">            </span>
<span class="sd">            Fetch as dict with keys as layer_&lt;num&gt; and vals of choice using </span>

<span class="sd">            &gt;&gt;&gt; mada_info.fetch_specific_layers([55, 75], &quot;geoclim_type&quot;, &quot;layer_name&quot;, &quot;is_categorical&quot;)</span>
<span class="sd">            {</span>
<span class="sd">                </span>
<span class="sd">                &#39;layer_55&#39;: {</span>
<span class="sd">                    &#39;geoclim_type&#39;: &#39;clim&#39;,</span>
<span class="sd">                    &#39;layer_name&#39;: &#39;bio19&#39;,</span>
<span class="sd">                    &#39;is_categorical&#39;: False</span>
<span class="sd">                },</span>
<span class="sd">                &#39;layer_75&#39;: {</span>
<span class="sd">                    &#39;geoclim_type&#39;: &#39;env&#39;,</span>
<span class="sd">                    &#39;layer_name&#39;: &#39;geo&#39;,</span>
<span class="sd">                    &#39;is_categorical&#39;: True}</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">            &gt;&gt;&gt; # Only col names will be accepted as additionnal args</span>
<span class="sd">            &gt;&gt;&gt; bio1 = next((layer for layer in mada_info.get_layers_labels(as_descriptive_labels=True) if &quot;bio1&quot; in layer), None)</span>
<span class="sd">            &gt;&gt;&gt; mada_info.fetch_specific_layers(bio1, &quot;band_number&quot;)</span>
<span class="sd">            Traceback (most recent call last):</span>
<span class="sd">                if not min_layer &lt;= layer_number &lt;= max_layer:</span>
<span class="sd">                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
<span class="sd">            KeyError: &quot;Invalid args: [&#39;band_number&#39;]. Args must be one of a key of [&#39;geoclim_type&#39;, &#39;layer_number&#39;, &#39;layer_name&#39;, &#39;layer_description&#39;, &#39;is_categorical&#39;, &#39;units&#39;] or &#39;all&#39;&quot;</span>
<span class="sd">            &gt;&gt;&gt; # Get all keys with the `all` argument</span>
<span class="sd">            &gt;&gt;&gt; mada_info.fetch_specific_layers(bio1, &quot;all&quot;)</span>
<span class="sd">            {</span>
<span class="sd">                &#39;layer_37&#39;: {</span>
<span class="sd">                    &#39;geoclim_type&#39;: &#39;clim&#39;,</span>
<span class="sd">                    &#39;layer_number&#39;: 37,</span>
<span class="sd">                    &#39;layer_name&#39;: &#39;bio1&#39;,</span>
<span class="sd">                    &#39;layer_description&#39;: &#39;Annual mean temperature&#39;,</span>
<span class="sd">                    &#39;is_categorical&#39;: False,</span>
<span class="sd">                    &#39;units&#39;: &#39;degrees&#39;</span>
<span class="sd">                }</span>
<span class="sd">            }</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_layers_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_layers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>    <span class="c1"># Reference to all clim and env metadata df</span>

        <span class="c1"># Validate layers_labels</span>
        <span class="n">possible_layers_num_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_layers_labels</span><span class="p">()</span>
        <span class="n">possible_layers_desc_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_layers_labels</span><span class="p">(</span><span class="n">as_descriptive_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers_labels</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># Check if all elements are in unique label format</span>
            <span class="n">layers_num_format</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">layer_label</span> <span class="ow">in</span> <span class="n">possible_layers_num_format</span> <span class="k">for</span> <span class="n">layer_label</span> <span class="ow">in</span> <span class="n">layers_labels</span><span class="p">])</span>
            <span class="n">layers_desc_format</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">layer_label</span> <span class="ow">in</span> <span class="n">possible_layers_desc_format</span> <span class="k">for</span> <span class="n">layer_label</span> <span class="ow">in</span> <span class="n">layers_labels</span><span class="p">])</span>
            
            <span class="c1"># Save as list of ints for later filtering</span>
            <span class="k">if</span> <span class="n">layers_num_format</span> <span class="ow">or</span> <span class="n">layers_desc_format</span><span class="p">:</span>
                <span class="n">layers_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">layer_label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">layer_label</span> <span class="ow">in</span> <span class="n">layers_labels</span><span class="p">]</span>

            <span class="c1"># layers_labels as list of ints</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">layers_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers_labels</span><span class="p">]</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;layers_labels must be either a list of int values (or str that can be converted to int) or the output format from the &#39;get_layers_labels&#39; method.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Single layers_labels type check </span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers_labels</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">layers_labels</span> <span class="ow">in</span> <span class="n">possible_layers_num_format</span> <span class="ow">or</span> <span class="n">layers_labels</span> <span class="ow">in</span> <span class="n">possible_layers_desc_format</span><span class="p">:</span>    <span class="c1"># Check layer_&lt;num&gt; or desc str format</span>
                    <span class="n">layers_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">layers_labels</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;layers_labels must be in the output format from the &#39;get_layers_labels&#39; method if it is a string.&quot;</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers_labels</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">layers_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="n">layers_labels</span><span class="p">]</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;layers_labels must be an int if not in string format.&quot;</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;layers_labels must be either a single int value, a string that can be converted to an int, or in the output format from the &#39;get_layers_labels&#39; method.&quot;</span><span class="p">)</span>

        <span class="c1"># Validate layer number range for layer_numbers as in</span>
        <span class="n">min_layer</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">all_layers_df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">])</span>
        <span class="n">max_layer</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">all_layers_df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">layer_number</span> <span class="ow">in</span> <span class="n">layers_numbers</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">min_layer</span> <span class="o">&lt;=</span> <span class="n">layer_number</span> <span class="o">&lt;=</span> <span class="n">max_layer</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;layer_number must fall between </span><span class="si">{</span><span class="n">min_layer</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">max_layer</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">layer_number</span><span class="si">=}</span><span class="s2"> is not valid.&quot;</span><span class="p">)</span>
            
        <span class="c1"># Fetch rows according to layer selection</span>
        <span class="n">select_df</span> <span class="o">=</span> <span class="n">all_layers_df</span><span class="p">[</span><span class="n">all_layers_df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">layers_numbers</span><span class="p">)]</span>

        <span class="c1"># Validate args for presence in `all_layers` attr or for `all` possible keys</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">missing_args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">select_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">missing_args</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid args: </span><span class="si">{</span><span class="n">missing_args</span><span class="si">}</span><span class="s2">. Args must be one of a key of </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">select_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2"> or &#39;all&#39;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;all&quot;</span> <span class="ow">in</span> <span class="n">args</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot have additional arguments when &#39;all&#39; is specified&quot;</span><span class="p">)</span>
            
            <span class="n">cols</span> <span class="o">=</span> <span class="n">select_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s2">&quot;all&quot;</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">else</span> <span class="n">args</span>
            <span class="c1"># Return nested dicts with values of specified arg for the fetched layers</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">missing_args</span><span class="p">:</span>
                <span class="n">select_layers_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">layer_num</span> <span class="ow">in</span> <span class="n">layers_numbers</span><span class="p">:</span>
                    <span class="n">layer_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;layer_</span><span class="si">{</span><span class="n">layer_num</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">select_layers_dict</span><span class="p">[</span><span class="n">layer_label</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                        <span class="n">select_layers_dict</span><span class="p">[</span><span class="n">layer_label</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">select_df</span><span class="p">[</span><span class="n">select_df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">layer_num</span><span class="p">][</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>    
                <span class="k">return</span> <span class="n">select_layers_dict</span>
        
        <span class="k">else</span><span class="p">:</span>    <span class="c1"># Save whole row of df</span>
            <span class="k">return</span> <span class="n">select_df</span></div>

<div class="viewcode-block" id="MadaclimLayers.download_data"><a class="viewcode-back" href="../../py_madaclim.html#py_madaclim.info.MadaclimLayers.download_data">[docs]</a>    <span class="k">def</span> <span class="nf">download_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Downloads climate and environment raster files from the Madaclim website.</span>

<span class="sd">        This method downloads the climate and environment raster data from the Madaclim website</span>
<span class="sd">        and saves them to the specified directory. If no directory is specified, the data is saved</span>
<span class="sd">        to the current working directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            save_dir (Optional[pathlib.Path]): The directory where the data should be saved. If not specified,</span>
<span class="sd">                the data is saved to the current working directory.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If save_dir is not a directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">def</span> <span class="nf">download_single_file</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dir_savepath</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Downloads a single file from a URL and saves it to the specified directory.</span>

<span class="sd">            This function downloads a file from the specified URL and saves it to the specified directory</span>
<span class="sd">            with the specified filename. The download progress is printed to the console.</span>

<span class="sd">            Args:</span>
<span class="sd">                url (str): The URL of the file to download.</span>
<span class="sd">                dir_savepath (pathlib.Path): The directory where the file should be saved.</span>
<span class="sd">                filename (str): The name of the file to save.</span>

<span class="sd">            Returns:</span>
<span class="sd">                pathlib.Path: The path of the downloaded file.</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">try</span> <span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">####   Trying get request to Madaclim website...   ####&quot;</span><span class="p">)</span>
                
                <span class="c1"># Calculate file size in MB</span>
                <span class="n">total_size</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">]))</span><span class="o">/</span><span class="mi">1000000</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">total_size</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
                
                <span class="c1"># Download in chunks of 1 MB and save to disk</span>
                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span> <span class="p">:</span> 
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Server response OK from </span><span class="si">{</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">, starting to download </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dir_savepath</span> <span class="o">/</span> <span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span> <span class="p">:</span>
                        <span class="n">chunksize</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1000</span>
                        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="n">chunksize</span><span class="p">))</span> <span class="p">:</span>
                            <span class="n">percent</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">chunksize</span> <span class="o">/</span> <span class="p">(</span><span class="n">total_size</span><span class="o">*</span><span class="mi">1000000</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
                            <span class="n">now_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                            <span class="n">current_speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">chunksize</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">now_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000000</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Progress for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">percent</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> % completed of </span><span class="si">{</span><span class="n">total_size</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> MB downloaded [ current speed of  </span><span class="si">{</span><span class="n">current_speed</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> MB/s ]&quot;</span><span class="p">,</span>
                                <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Progress for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> : 100.00 % completed of </span><span class="si">{</span><span class="n">total_size</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> MB downloaded [ average speed of  </span><span class="si">{</span><span class="n">total_size</span><span class="o">/</span><span class="p">(</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> MB/s ]&quot;</span><span class="p">,</span>
                            <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="nb">print</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Done downloading </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds !&quot;</span><span class="p">)</span>
                            
            <span class="k">except</span> <span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> cannot be downloaded. Status code : </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dir_savepath</span> <span class="o">/</span> <span class="n">filename</span>
        
        <span class="c1"># Validate save target directory</span>
        <span class="n">save_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span> <span class="k">if</span> <span class="n">save_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">save_dir</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">save_dir</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find directory: </span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Download rasters</span>
        <span class="n">download_single_file</span><span class="p">(</span>    <span class="c1"># Climate raster</span>
            <span class="n">url</span><span class="o">=</span><span class="n">Constants</span><span class="o">.</span><span class="n">MADACLIM_URLS</span><span class="p">[</span><span class="s2">&quot;clim_raster&quot;</span><span class="p">],</span>
            <span class="n">dir_savepath</span><span class="o">=</span><span class="n">save_dir</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">Constants</span><span class="o">.</span><span class="n">DEFAULT_CLIM_RASTER_FILENAME</span>
        <span class="p">)</span>

        <span class="n">download_single_file</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">Constants</span><span class="o">.</span><span class="n">MADACLIM_URLS</span><span class="p">[</span><span class="s2">&quot;env_raster&quot;</span><span class="p">],</span>
            <span class="n">dir_savepath</span><span class="o">=</span><span class="n">save_dir</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">Constants</span><span class="o">.</span><span class="n">DEFAULT_ENV_RASTER_FILENAME</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="MadaclimLayers.get_bandnums_from_layers"><a class="viewcode-back" href="../../py_madaclim.html#py_madaclim.info.MadaclimLayers.get_bandnums_from_layers">[docs]</a>    <span class="k">def</span> <span class="nf">get_bandnums_from_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layers_labels</span> <span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves band numbers corresponding to the provided layers&#39; labels.</span>

<span class="sd">        This method accepts labels for a subset of layers (specified as either layer numbers, &quot;layer_&lt;num&gt;&quot; format, or descriptive labels)</span>
<span class="sd">        and returns the corresponding band numbers from the `all_layers` dataframe. If the input is in the descriptive label format or &quot;layer_&lt;num&gt;&quot; format,</span>
<span class="sd">        it should match the output of the `get_layers_labels` method.</span>

<span class="sd">        Args:</span>
<span class="sd">            layers_labels (Union[int, str, List[Union[int, str]]]): A list of layer labels in various formats, or a single layer label.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If elements of `layers_labels` cannot be converted to int or if they do not match the format produced by the `get_layers_labels` method.</span>
<span class="sd">            ValueError: If the derived layer numbers do not fall within the valid range of layer numbers in the `all_layers` dataframe.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[int]: A list of band numbers corresponding to the provided layer labels.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; mada_info = MadaclimLayers(clim_raster=&quot;madaclim_current.tif&quot;, env_raster=&quot;madaclim_enviro.tif&quot;)</span>
<span class="sd">            &gt;&gt;&gt; last_20 = mada_info.get_layers_labels()[-20:]</span>
<span class="sd">            &gt;&gt;&gt; band_nums = mada_info.get_bandnums_from_layers(last_20)</span>
<span class="sd">            &gt;&gt;&gt; band_nums</span>
<span class="sd">            [60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 1, 2, 3, 4, 5, 6, 7, 8, 9]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_layers_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_layers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>    <span class="c1"># Reference to all clim and env metadata df</span>

        <span class="c1"># Validate layers_labels</span>
        <span class="n">possible_layers_num_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_layers_labels</span><span class="p">()</span>
        <span class="n">possible_layers_desc_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_layers_labels</span><span class="p">(</span><span class="n">as_descriptive_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers_labels</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># Check if all elements are in unique label format</span>
            <span class="n">layers_num_format</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">layer_label</span> <span class="ow">in</span> <span class="n">possible_layers_num_format</span> <span class="k">for</span> <span class="n">layer_label</span> <span class="ow">in</span> <span class="n">layers_labels</span><span class="p">])</span>
            <span class="n">layers_desc_format</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">layer_label</span> <span class="ow">in</span> <span class="n">possible_layers_desc_format</span> <span class="k">for</span> <span class="n">layer_label</span> <span class="ow">in</span> <span class="n">layers_labels</span><span class="p">])</span>
            
            <span class="c1"># Save as list of ints for later filtering</span>
            <span class="k">if</span> <span class="n">layers_num_format</span> <span class="ow">or</span> <span class="n">layers_desc_format</span><span class="p">:</span>
                <span class="n">layers_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">layer_label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">layer_label</span> <span class="ow">in</span> <span class="n">layers_labels</span><span class="p">]</span>

            <span class="c1"># layers_labels as list of ints</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">layers_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers_labels</span><span class="p">]</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;layers_labels must be either a list of int values (or str that can be converted to int) or the output format from the &#39;get_layers_labels&#39; method.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Single layers_labels type check </span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">layers_labels</span> <span class="ow">in</span> <span class="n">possible_layers_num_format</span><span class="p">:</span>    <span class="c1"># Check layer_&lt;num&gt; str format</span>
                <span class="n">layers_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">layers_labels</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">layers_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">layers_labels</span><span class="p">)]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;layers_labels must be either a single int value (or a str that can be converted to an int) or in the output format from the &#39;get_layers_labels&#39; method.&quot;</span><span class="p">)</span>
  
        <span class="c1"># Validate layer number range for layer_numbers as in</span>
        <span class="n">min_layer</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">all_layers_df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">])</span>
        <span class="n">max_layer</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">all_layers_df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">layer_number</span> <span class="ow">in</span> <span class="n">layers_numbers</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">min_layer</span> <span class="o">&lt;=</span> <span class="n">layer_number</span> <span class="o">&lt;=</span> <span class="n">max_layer</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;layer_number must fall between </span><span class="si">{</span><span class="n">min_layer</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">max_layer</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">layer_number</span><span class="si">=}</span><span class="s2"> is not valid.&quot;</span><span class="p">)</span>
            
        <span class="c1"># Fetch rows and geoclim type(s) according to selected layers</span>
        <span class="n">select_df</span> <span class="o">=</span> <span class="n">all_layers_df</span><span class="p">[</span><span class="n">all_layers_df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">layers_numbers</span><span class="p">)]</span>
        <span class="n">geoclim_types</span> <span class="o">=</span> <span class="n">select_df</span><span class="p">[</span><span class="s2">&quot;geoclim_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        
        <span class="c1"># Get band num according to geoclim_type</span>
        <span class="n">total_clim_layers</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_layers_df</span><span class="p">[</span><span class="s2">&quot;geoclim_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;clim&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">band_nums</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">geoclim_type</span> <span class="ow">in</span> <span class="n">geoclim_types</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_raster</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">geoclim_type</span><span class="si">}</span><span class="s2">_raster&quot;</span><span class="p">)</span>    <span class="c1"># Validate raster attr val, IO path and integrity</span>
            <span class="k">if</span> <span class="n">geoclim_type</span> <span class="o">==</span> <span class="s2">&quot;clim&quot;</span><span class="p">:</span>
                <span class="n">band_nums</span> <span class="o">+=</span> <span class="n">select_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_df</span><span class="p">[</span><span class="s2">&quot;geoclim_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">geoclim_type</span><span class="p">,</span> <span class="s2">&quot;layer_number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">band_nums</span> <span class="o">+=</span> <span class="p">(</span><span class="n">select_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_df</span><span class="p">[</span><span class="s2">&quot;geoclim_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">geoclim_type</span><span class="p">,</span> <span class="s2">&quot;layer_number&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">total_clim_layers</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">band_nums</span></div>
    
<div class="viewcode-block" id="MadaclimLayers.get_categorical_combinations"><a class="viewcode-back" href="../../py_madaclim.html#py_madaclim.info.MadaclimLayers.get_categorical_combinations">[docs]</a>    <span class="k">def</span> <span class="nf">get_categorical_combinations</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">layers_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">as_descriptive_keys</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary representation of the specified categorical layers corresponding the the categorical value encoding.</span>

<span class="sd">        Args:</span>
<span class="sd">            layers_labels (Optional[Union[int, str, List[Union[int, str]]]]): The layer labels to fetch. Can be a single </span>
<span class="sd">                integer or string value, or a list of integer or string values. The input can also be in the format </span>
<span class="sd">                &quot;layer_{num}&quot; or &quot;{geotype}_{num}_{name}_({unit})&quot; (output from `get_layers_labels(as_descriptive_labels=True)` method).</span>
<span class="sd">                If `layers_labels` is `None`, all categorical layers are fetched.</span>
<span class="sd">            as_descriptive_keys(bool):  If True, returns the descriptive layer labels. Otherwise, returns </span>
<span class="sd">                the &quot;layer_&lt;num&gt;&quot; format. Defaults to False</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If `layers_labels` is not a list of integers or strings, a single integer or a string </span>
<span class="sd">            that can be converted to an integer, or in the output format from the &#39;get_layers_labels&#39; method.</span>
<span class="sd">            ValueError: If a layer number in `layers_labels` is not a valid categorical layer number.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[dict, Dict[str, Dict[int, str]]]: A dictionary of the specified categorical layers. </span>
<span class="sd">            If multiple layers were specified, the dictionary keys are &#39;layer_{num}&#39;, and the values are dictionaries </span>
<span class="sd">            with layer values as keys and their corresponding categories as values.</span>
<span class="sd">            If a single layer was specified, the dictionary keys are the categorical values, and the values are the </span>
<span class="sd">            categories themselves. </span>

<span class="sd">        Examples:</span>
<span class="sd">            If multiple layers specified, it returns:</span>

<span class="sd">            &gt;&gt;&gt; madaclim_info = MadaclimLayers()</span>
<span class="sd">            &gt;&gt;&gt; &gt;&gt;&gt; madaclim_info.get_categorical_combinations([75, 76])</span>
<span class="sd">            {</span>
<span class="sd">                &#39;layer_75&#39;: {</span>
<span class="sd">                    1: &#39;N-Bemarivo&#39;,</span>
<span class="sd">                    2: &#39;S-Bemarivo,_N-Mangoro&#39;,</span>
<span class="sd">                    ...</span>
<span class="sd">                },</span>
<span class="sd">                &#39;layer_76&#39;: {</span>
<span class="sd">                    1: &#39;Bare_Rocks&#39;,</span>
<span class="sd">                    2: &#39;Raw_Lithic_Mineral_Soils&#39;,</span>
<span class="sd">                    ...</span>
<span class="sd">                },</span>
<span class="sd">                ...</span>
<span class="sd">            }</span>

<span class="sd">            If a single layer is specified, it returns:</span>

<span class="sd">            &gt;&gt;&gt; madaclim_info.get_categorical_combinations(&quot;layer_76&quot;)</span>
<span class="sd">            {</span>
<span class="sd">                &#39;layer_76: {</span>
<span class="sd">                    1: &#39;Bare_Rocks&#39;,</span>
<span class="sd">                    2: &#39;Raw_Lithic_Mineral_Soils&#39;,</span>
<span class="sd">                ...</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">            </span>
<span class="sd">            For more descriptive keys (same output from as_descriptive_labels)</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; madaclim_info.get_categorical_combinations(&quot;layer_76&quot;, as_descriptive_keys=True)</span>
<span class="sd">            {</span>
<span class="sd">                &#39;env_76_soi_Soil types (categ_vals: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23)&#39;: {</span>
<span class="sd">                    1: &#39;Bare_Rocks&#39;,</span>
<span class="sd">                    2: &#39;Raw_Lithic_Mineral_Soils&#39;,</span>
<span class="sd">                ...</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cat_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_categorical_layers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Validate layers_labels</span>
        <span class="n">possible_layers_num_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_layers_labels</span><span class="p">()</span>
        <span class="n">possible_layers_desc_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_layers_labels</span><span class="p">(</span><span class="n">as_descriptive_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers_labels</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># Check if all elements are in unique label format</span>
            <span class="n">layers_num_format</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">layer_label</span> <span class="ow">in</span> <span class="n">possible_layers_num_format</span> <span class="k">for</span> <span class="n">layer_label</span> <span class="ow">in</span> <span class="n">layers_labels</span><span class="p">])</span>
            <span class="n">layers_desc_format</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">layer_label</span> <span class="ow">in</span> <span class="n">possible_layers_desc_format</span> <span class="k">for</span> <span class="n">layer_label</span> <span class="ow">in</span> <span class="n">layers_labels</span><span class="p">])</span>
            
            <span class="c1"># Save as list of ints for later filtering</span>
            <span class="k">if</span> <span class="n">layers_num_format</span> <span class="ow">or</span> <span class="n">layers_desc_format</span><span class="p">:</span>
                <span class="n">layers_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">layer_label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">layer_label</span> <span class="ow">in</span> <span class="n">layers_labels</span><span class="p">]</span>

            <span class="c1"># layers_labels as list of ints</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">layers_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers_labels</span><span class="p">]</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;layers_labels must be either a list of int values (or str that can be converted to int) or the output format from the &#39;get_layers_labels&#39; method.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Single layers_labels type check </span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers_labels</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">layers_labels</span> <span class="ow">in</span> <span class="n">possible_layers_num_format</span> <span class="ow">or</span> <span class="n">layers_labels</span> <span class="ow">in</span> <span class="n">possible_layers_desc_format</span><span class="p">:</span>    <span class="c1"># Check layer_&lt;num&gt; or desc str format</span>
                <span class="n">layers_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">layers_labels</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;layers_labels must be in the output format from the &#39;get_layers_labels&#39; method if it is a string.&quot;</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers_labels</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">layers_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="n">layers_labels</span><span class="p">]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;layers_labels must be an int if not in string format.&quot;</span><span class="p">)</span>
            
        <span class="k">elif</span> <span class="n">layers_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">layers_numbers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cat_df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;layers_labels must be either a single int value, a string that can be converted to an int, or in the output format from the &#39;get_layers_labels&#39; method.&quot;</span><span class="p">)</span>
            
        <span class="c1"># Validate layer number range for layer_numbers as in</span>
        <span class="n">all_cat_layers_num</span> <span class="o">=</span> <span class="n">cat_df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">layer_number</span> <span class="ow">in</span> <span class="n">layers_numbers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">layer_number</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_cat_layers_num</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;layer_number must be one of the categorical layers: </span><span class="si">{</span><span class="n">all_cat_layers_num</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">layer_number</span><span class="si">=}</span><span class="s2"> is not valid.&quot;</span><span class="p">)</span>
            
        <span class="n">select_cat_df</span> <span class="o">=</span> <span class="n">cat_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cat_df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">layers_numbers</span><span class="p">)]</span>    <span class="c1"># Fetch validated layers</span>

        <span class="n">categorical_dict</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c1"># Nested container dict</span>
        <span class="k">for</span> <span class="n">layer_number</span> <span class="ow">in</span> <span class="n">layers_numbers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">as_descriptive_keys</span><span class="p">:</span>
                <span class="n">categorical_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_layers_labels</span><span class="p">(</span><span class="n">layer_number</span><span class="p">,</span> <span class="n">as_descriptive_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">categorical_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_layers_labels</span><span class="p">(</span><span class="n">layer_number</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">categorical_dict</span><span class="p">[</span><span class="n">categorical_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;raster_value&quot;</span><span class="p">]):</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span> 
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">select_cat_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_cat_df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">layer_number</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">categorical_dict</span></div>
    
    <span class="c1">#! Deprecated: Unefficient method with raster.read I/O operation for each band</span>
    <span class="k">def</span> <span class="nf">_get_band_from_layer_number</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer_number</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">geoclim_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the band number in a raster file corresponding to a given layer number and geoclim type.</span>

<span class="sd">        Args:</span>
<span class="sd">            layer_number (Union[str, int]): The layer number to find the corresponding band number for.</span>
<span class="sd">            geoclim_type (str): The geoclim type, either &quot;clim&quot; or &quot;env&quot;.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If geoclim_type is not a string.</span>
<span class="sd">            ValueError: If geoclim_type is not one of the possible geoclim types (&quot;clim&quot; or &quot;env&quot;).</span>
<span class="sd">            ValueError: If layer_number is out of range for the selected geoclim raster.</span>
<span class="sd">            ValueError: If the band number could not be retrieved for the given layer number.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The band number in the raster file corresponding to the given layer number and geoclim type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Validate geoclim_type</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geoclim_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;geoclim_type must be a string.&quot;</span><span class="p">)</span>
        
        <span class="n">possible_geoclim_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;clim&quot;</span><span class="p">,</span> <span class="s2">&quot;env&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">geoclim_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">possible_geoclim_types</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;geoclim_type must be one of </span><span class="si">{</span><span class="n">possible_geoclim_types</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Validate layer_number according to geoclim type</span>
        <span class="n">select_geoclim_layers_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_geoclim_type_layers</span><span class="p">(</span><span class="n">geoclim_type</span><span class="p">)[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">layer_number</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">select_geoclim_layers_range</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer_number</span><span class="si">=}</span><span class="s2"> is out of range for the selected geoclim raster of </span><span class="si">{</span><span class="n">geoclim_type</span><span class="si">}</span><span class="s2">. Choose between </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">select_geoclim_layers_range</span><span class="p">)</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">select_geoclim_layers_range</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Get the number of bands for the selected geoclim_type raster</span>
        <span class="k">if</span> <span class="n">geoclim_type</span> <span class="o">==</span> <span class="s2">&quot;clim&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_raster</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">geoclim_type</span><span class="si">}</span><span class="s2">_raster&quot;</span><span class="p">)</span>    <span class="c1"># Validate raster before I/O</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clim_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">clim_raster</span><span class="p">:</span>
                <span class="n">raster_bands</span> <span class="o">=</span> <span class="n">clim_raster</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">geoclim_type</span> <span class="o">==</span> <span class="s2">&quot;env&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_raster</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">geoclim_type</span><span class="si">}</span><span class="s2">_raster&quot;</span><span class="p">)</span>    <span class="c1"># Validate raster before I/O</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">env_raster</span><span class="p">:</span>
                <span class="n">raster_bands</span> <span class="o">=</span> <span class="n">env_raster</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Return the band number according to the layer number</span>
        <span class="n">band_number</span> <span class="o">=</span> <span class="n">layer_number</span> <span class="o">-</span> <span class="n">select_geoclim_layers_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">band_number</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">raster_bands</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not retrieve </span><span class="si">{</span><span class="n">band_number</span><span class="si">=}</span><span class="s2"> for </span><span class="si">{</span><span class="n">layer_number</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">band_number</span>

    <span class="k">def</span> <span class="nf">_get_madaclim_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Private method that will generate the `all_layers` attributes based on the format and metada files from the Madaclim db by accessing their corresponding attributes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: A DataFrame containing a complete and formatted version of all Madaclim layers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">def</span> <span class="nf">split_layers</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">layers_col_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Split &quot;Layers&quot; column and create new rows</span>

<span class="sd">            Args:</span>
<span class="sd">                row (pd.Series): Row of data from a DataFrame</span>
<span class="sd">                layers_col_name (str): Name of the column to split</span>

<span class="sd">            Returns:</span>
<span class="sd">                pd.DataFrame: DataFrame with split rows</span>

<span class="sd">            Examples:</span>
<span class="sd">                &gt;&gt;&gt; df = pd.DataFrame({&quot;A&quot;: [&quot;x1-3&quot;, &quot;y4&quot;], &quot;B&quot;: [&quot;foo&quot;, &quot;bar&quot;]})</span>
<span class="sd">                &gt;&gt;&gt; result = df.apply(split_repeating_vars, axis=1, col_to_split=&quot;A&quot;, col_to_keep=&quot;B&quot;)</span>
<span class="sd">                &gt;&gt;&gt; df_result = pd.concat(result.tolist(), axis=0).reset_index(drop=True)</span>
<span class="sd">                &gt;&gt;&gt; print(df_result)</span>
<span class="sd">                    A    B</span>
<span class="sd">                0   x1  foo</span>
<span class="sd">                1   x2  foo</span>
<span class="sd">                2   x3  foo</span>
<span class="sd">                3   y4  bar</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="n">layers_col_name</span><span class="p">]:</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">layers_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
                <span class="n">index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">layers_col_name</span><span class="p">])]</span>
            
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Climate variable&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;Climate variable&quot;</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">),</span>
                <span class="s2">&quot;data_type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;data_type&quot;</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="p">}</span>
            
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">split_repeating_vars</span><span class="p">(</span><span class="n">row</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">col_to_split</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">col_to_keep</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Split a column containing repeating values into separate rows.</span>

<span class="sd">            This function takes a row of data from a DataFrame and splits the value in the column specified by `col_to_split` if it contains a hyphen. The function returns a new DataFrame with rows for each value in the specified range and with values from the column specified by `col_to_keep`. The month name is appended to the `col_to_keep` values.</span>

<span class="sd">            Args:</span>
<span class="sd">                row (pd.Series): A row of data from a DataFrame.</span>
<span class="sd">                col_to_split (str): The name of the column to split.</span>
<span class="sd">                col_to_keep (str): The name of the column to keep.</span>

<span class="sd">            Returns:</span>
<span class="sd">                pd.DataFrame: A DataFrame with split rows.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            
            <span class="c1"># Extract the range and layername to a new smaller df of len(range(start, end))</span>
            <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="n">col_to_split</span><span class="p">]:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">col_to_split</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>
                <span class="n">end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">col_to_split</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;[a-z]*&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">col_to_split</span><span class="p">])</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
                        
                <span class="c1"># Create a DataFrame with the split values and the description column</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">col_to_split</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">month</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span>
                                <span class="n">col_to_keep</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="n">col_to_keep</span><span class="p">]</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">month_name</span><span class="p">[</span><span class="n">month</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">+</span><span class="mi">1</span><span class="p">)]})</span>
                <span class="k">return</span> <span class="n">df</span>
            
            <span class="c1"># When no changes to changes to row</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">col_to_split</span><span class="p">:</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">col_to_split</span><span class="p">]],</span> <span class="n">col_to_keep</span><span class="p">:</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">col_to_keep</span><span class="p">]]})</span>
                <span class="k">return</span> <span class="n">df</span>
            
        <span class="k">def</span> <span class="nf">add_layer_numbers_bio_monthly</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Adds layer numbers to bio_monthly dataframe.</span>

<span class="sd">            This function takes the bio_monthly ddf and adds a new column</span>
<span class="sd">            &quot;layer_number&quot; that assigns a layer number to each row based on the value</span>
<span class="sd">            of the &quot;layer_name&quot; column.</span>

<span class="sd">            Args:</span>
<span class="sd">                df (pd.DataFrame): The bio_monthly dataframe.</span>

<span class="sd">            Returns:</span>
<span class="sd">                pd.DataFrame: The input dataframe with an additional &quot;layer_number&quot; column.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            
            <span class="c1"># Get the geoclim feature name and sub df for each layer_name categories</span>
            <span class="n">monthly_features</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">categories_layer_name</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;layer_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s2">&quot;(^[a-zA-Z]+)&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

            <span class="c1"># Add layer number to bio_monthly df</span>
            <span class="n">current_start_layer</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">layer_name</span> <span class="ow">in</span> <span class="n">categories_layer_name</span><span class="p">:</span>
                
                <span class="c1"># Extract common base layer name</span>
                <span class="n">category_feature_val</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;layer_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">layer_name</span><span class="p">)][</span><span class="s2">&quot;layer_description&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; - &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">monthly_features</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer_name</span><span class="si">}</span><span class="s2">_cat_feature&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">category_feature_val</span>
                
                <span class="c1"># Get df associated with common category</span>
                <span class="n">category_feature_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;layer_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">layer_name</span><span class="p">)])</span>
                <span class="n">monthly_features</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer_name</span><span class="si">}</span><span class="s2">_df&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">category_feature_df</span>

                <span class="c1"># Assign layer number according to current category</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;layer_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">layer_name</span><span class="p">),</span> <span class="s2">&quot;layer_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">current_start_layer</span><span class="p">,</span> <span class="n">current_start_layer</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">category_feature_df</span><span class="p">))</span>
                <span class="n">current_start_layer</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">category_feature_df</span><span class="p">)</span>

            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">df</span>
        
        <span class="k">def</span> <span class="nf">get_env_layer_name</span><span class="p">(</span><span class="n">row</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Generate an environment layer name based on the `geoclim_feature` field in the given row.</span>
<span class="sd">            </span>
<span class="sd">            Args:</span>
<span class="sd">                row (pd.Series): A row of the DataFrame.</span>
<span class="sd">            </span>
<span class="sd">            Returns:</span>
<span class="sd">                str: The generated environment layer name.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">sourceless_unitless</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;geoclim_feature&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; (&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sless_uless_list</span> <span class="o">=</span> <span class="n">sourceless_unitless</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sless_uless_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sless_uless_list</span><span class="p">[</span><span class="mi">2</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sless_uless_list</span><span class="p">[</span><span class="mi">3</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sless_uless_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sless_uless_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sless_uless_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">sourceless_unitless</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        
        <span class="k">def</span> <span class="nf">meta_merge_clim_df</span><span class="p">(</span><span class="n">clim_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">meta_dfs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Merges a the original clim_df dataframe with multiple metadata dataframes.</span>

<span class="sd">            Args:</span>
<span class="sd">                clim_df (pd.DataFrame): A climate dataframe with a &quot;layer_number&quot; column.</span>
<span class="sd">                meta_dfs (List[pd.DataFrame]): A list of metadata dataframes with a &quot;layer_number&quot; column.</span>

<span class="sd">            Returns:</span>
<span class="sd">                pd.DataFrame: The concatenated merged dataframe.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            
            <span class="n">merge_result_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">meta_df</span> <span class="ow">in</span> <span class="n">meta_dfs</span><span class="p">:</span>
                <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">clim_df</span><span class="p">,</span> <span class="n">meta_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;layer_number&quot;</span><span class="p">)</span>
                <span class="n">merge_result_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_df</span><span class="p">)</span>
            
            <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">merge_result_dfs</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">merged_df</span>
        
        <span class="c1"># Define your function to extract units</span>
        <span class="k">def</span> <span class="nf">extract_units</span><span class="p">(</span><span class="n">row</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Extract units from the `layer_description` field if the `units` field is None.</span>
<span class="sd">            Otherwise, return the value in the `units` field.</span>
<span class="sd">            </span>
<span class="sd">            Args:</span>
<span class="sd">                row (pd.Series): A row of the DataFrame.</span>
<span class="sd">                </span>
<span class="sd">            Returns:</span>
<span class="sd">                Union[str, list]: The extracted units or the original value in the `units` field.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\((.*?)\)&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;layer_description&quot;</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">match</span> <span class="k">else</span> <span class="s2">&quot;No units&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> 

            
        <span class="k">def</span> <span class="nf">remove_units_from_desc</span><span class="p">(</span><span class="n">row</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Remove units from the `layer_description` field if `units` field is not a list.</span>
<span class="sd">            Otherwise, return the original `layer_description`.</span>
<span class="sd">            </span>
<span class="sd">            Args:</span>
<span class="sd">                row (pd.Series): A row of the DataFrame.</span>
<span class="sd">                </span>
<span class="sd">            Returns:</span>
<span class="sd">                str: The processed `layer_description` without units if `units` is not a list, </span>
<span class="sd">                    otherwise the original `layer_description`.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>  <span class="c1"># Apply only non-categorical (null) entries</span>
                <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;layer_description&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39; \(.*?\)&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;layer_description&quot;</span><span class="p">])</span>
        
        
        <span class="c1"># Extract climate data and format it using the metadata</span>
        <span class="n">df_clim</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clim_dataformat</span><span class="p">[</span><span class="s2">&quot;table_0&quot;</span><span class="p">])</span>
        <span class="n">df_clim</span><span class="p">[</span><span class="s2">&quot;data_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;clim&quot;</span>    <span class="c1"># Tag for latter id in merge</span>

        <span class="c1"># Split the layers to get initial layer_num for all clim-related layers</span>
        <span class="n">df_clim</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">df_clim</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">split_layers</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Layers&quot;</span><span class="p">,</span> <span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">df_clim</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">,</span> <span class="s2">&quot;geoclim_feature&quot;</span><span class="p">,</span> <span class="s2">&quot;geoclim_type&quot;</span><span class="p">]</span>

        <span class="c1"># Formatting + add layers to the monthly bioclim metadata</span>
        <span class="n">bio_monthly_feats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clim_metadata</span><span class="p">[</span><span class="s2">&quot;table_0&quot;</span><span class="p">])</span>
        <span class="n">bio_monthly_feats</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;layer_name&quot;</span><span class="p">,</span> <span class="s2">&quot;layer_description&quot;</span><span class="p">]</span>
        
        <span class="n">bio_monthly_feats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>    <span class="c1"># Split according to range</span>
            <span class="n">bio_monthly_feats</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">split_repeating_vars</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;layer_name&quot;</span><span class="p">,</span> <span class="s2">&quot;layer_description&quot;</span><span class="p">,</span> <span class="p">))</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
            <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">bio_monthly_feats</span> <span class="o">=</span> <span class="n">add_layer_numbers_bio_monthly</span><span class="p">(</span><span class="n">bio_monthly_feats</span><span class="p">)</span>    <span class="c1"># Append layer numbers</span>

        <span class="c1"># Formatting + add layers to the other bioclim metadata (non-monthly)</span>
        <span class="n">bioclim_feats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clim_metadata</span><span class="p">[</span><span class="s2">&quot;table_1&quot;</span><span class="p">])</span>
        <span class="n">bioclim_feats</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;layer_name&quot;</span><span class="p">,</span> <span class="s2">&quot;layer_description&quot;</span><span class="p">]</span>

        <span class="n">current_start_layer</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bio_monthly_feats</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>    <span class="c1"># Save the current state of the layer number for clim_df</span>
        <span class="n">bioclim_feats</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">current_start_layer</span><span class="p">,</span> <span class="n">current_start_layer</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">bioclim_feats</span><span class="p">))</span>

        <span class="c1"># Formatting + add layers to monthly and annual evapotranspiration metadata</span>
        <span class="n">evap_feats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clim_metadata</span><span class="p">[</span><span class="s2">&quot;table_2&quot;</span><span class="p">])</span>
        <span class="n">evap_feats</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;layer_name&quot;</span><span class="p">,</span> <span class="s2">&quot;layer_description&quot;</span><span class="p">]</span>
        
        <span class="n">evap_feats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>    <span class="c1"># Split monthly evapo data</span>
            <span class="n">evap_feats</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">split_repeating_vars</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;layer_name&quot;</span><span class="p">,</span> <span class="s2">&quot;layer_description&quot;</span><span class="p">,</span> <span class="p">))</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
            <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">current_start_layer</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bioclim_feats</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>    <span class="c1"># Save the current state of the layer number for clim_df</span>
        <span class="n">evap_feats</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">current_start_layer</span><span class="p">,</span> <span class="n">current_start_layer</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">evap_feats</span><span class="p">))</span>

        <span class="c1"># Formatting + add layers to the bioclim water-related metadata</span>
        <span class="n">biowater_feats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clim_metadata</span><span class="p">[</span><span class="s2">&quot;table_3&quot;</span><span class="p">])</span>
        <span class="n">biowater_feats</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;layer_name&quot;</span><span class="p">,</span> <span class="s2">&quot;layer_description&quot;</span><span class="p">]</span>
        
        <span class="n">current_start_layer</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">evap_feats</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>    <span class="c1"># Save the current state of the layer number for clim_df</span>
        <span class="n">biowater_feats</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">current_start_layer</span><span class="p">,</span> <span class="n">current_start_layer</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">biowater_feats</span><span class="p">))</span>

        <span class="c1"># Merge meta_dfs with original clim_df for class attribute</span>
        <span class="n">meta_dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">bio_monthly_feats</span><span class="p">,</span> <span class="n">bioclim_feats</span><span class="p">,</span> <span class="n">evap_feats</span><span class="p">,</span> <span class="n">biowater_feats</span><span class="p">]</span>
        <span class="n">df_clim</span> <span class="o">=</span> <span class="n">meta_merge_clim_df</span><span class="p">(</span><span class="n">df_clim</span><span class="p">,</span> <span class="n">meta_dfs</span><span class="p">)</span>
        <span class="n">df_clim</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>


        <span class="c1"># Extract environmental data and format it using its related metadata</span>
        <span class="n">df_env</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_env_dataformat</span><span class="p">[</span><span class="s2">&quot;table_0&quot;</span><span class="p">])</span>
        <span class="n">df_env</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">,</span> <span class="s2">&quot;geoclim_feature&quot;</span><span class="p">]</span>
        <span class="n">df_env</span><span class="p">[</span><span class="s2">&quot;geoclim_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;env&quot;</span>    <span class="c1"># Tag for latter id in merge</span>

        <span class="n">current_start_layer</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">df_clim</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>    <span class="c1"># Save the current state of the layer number according to the final clim_df</span>
        <span class="n">df_env</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">current_start_layer</span><span class="p">,</span> <span class="n">current_start_layer</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_env</span><span class="p">))</span>

        <span class="c1"># Generate layer_name since absent from metadata</span>
        <span class="n">df_env</span><span class="p">[</span><span class="s2">&quot;layer_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_env</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_env_layer_name</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Assign dummy var int-val to information for all categorical data layers</span>
        <span class="n">env_meta_geol</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_env_metadata</span><span class="p">[</span><span class="s2">&quot;table_0&quot;</span><span class="p">])</span>    <span class="c1"># env-raster band num 5 == &#39;geology&#39;</span>
        <span class="n">geology_categorical</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">env_meta_geol</span><span class="p">[</span><span class="s2">&quot;Raster value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">rock_type</span> <span class="o">=</span> <span class="n">env_meta_geol</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">env_meta_geol</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">1</span><span class="p">]][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">rock_type</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rock_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span>
            <span class="n">rock_vals_type</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">rock_type</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">geology_categorical</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rock_vals_type</span><span class="p">)</span>

        <span class="n">env_meta_soil_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_metadata</span><span class="p">[</span><span class="s2">&quot;table_1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;source&quot;</span><span class="p">]</span>
        <span class="n">env_meta_soil</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">env_meta_soil_vals</span><span class="p">))</span>    <span class="c1"># env-raster band num 6 == &#39;soil&#39;</span>
        <span class="n">soil_categorical</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">soil</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">soil</span> <span class="ow">in</span> <span class="n">env_meta_soil</span><span class="p">]</span>

        <span class="n">env_meta_vege_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_metadata</span><span class="p">[</span><span class="s2">&quot;table_2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;source&quot;</span><span class="p">]</span>
        <span class="n">env_meta_vegetation</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">env_meta_vege_vals</span><span class="p">))</span>    <span class="c1"># env-raster band num 7 == &#39;vegetation&#39;</span>
        <span class="n">vege_categorical</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vege</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">vege</span> <span class="ow">in</span> <span class="n">env_meta_vegetation</span><span class="p">]</span>
        
        <span class="n">env_meta_watersheds_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_metadata</span><span class="p">[</span><span class="s2">&quot;table_3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;source&quot;</span><span class="p">]</span>
        <span class="n">env_meta_watersheds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">env_meta_watersheds_vals</span><span class="p">))</span>    <span class="c1"># env-raster band num 7 == &#39;vegetation&#39;</span>
        <span class="n">watersheds_categorical</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">watershed</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">watershed</span> <span class="ow">in</span> <span class="n">env_meta_watersheds</span><span class="p">]</span>
        
        <span class="c1"># put placeholder nones for desc and units</span>
        <span class="n">df_env</span><span class="p">[</span><span class="s2">&quot;layer_description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">df_env</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Add categorical values to units col</span>
        <span class="n">df_env</span><span class="o">.</span><span class="n">at</span><span class="p">[(</span><span class="n">df_env</span><span class="p">[</span><span class="s2">&quot;layer_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;geo&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(),</span> <span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geology_categorical</span>
        <span class="n">df_env</span><span class="o">.</span><span class="n">at</span><span class="p">[(</span><span class="n">df_env</span><span class="p">[</span><span class="s2">&quot;layer_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;soi&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(),</span> <span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">soil_categorical</span>
        <span class="n">df_env</span><span class="o">.</span><span class="n">at</span><span class="p">[(</span><span class="n">df_env</span><span class="p">[</span><span class="s2">&quot;layer_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;veg&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(),</span> <span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vege_categorical</span>
        <span class="n">df_env</span><span class="o">.</span><span class="n">at</span><span class="p">[(</span><span class="n">df_env</span><span class="p">[</span><span class="s2">&quot;layer_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;wat&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(),</span> <span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">watersheds_categorical</span>
        
        <span class="c1"># Add layer_description entries to &#39;null&#39; categoricals</span>
        <span class="n">df_env</span><span class="o">.</span><span class="n">at</span><span class="p">[(</span><span class="n">df_env</span><span class="p">[</span><span class="s2">&quot;layer_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;geo&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(),</span> <span class="s2">&quot;layer_description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">env_meta_geol</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">df_env</span><span class="o">.</span><span class="n">at</span><span class="p">[(</span><span class="n">df_env</span><span class="p">[</span><span class="s2">&quot;layer_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;soi&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(),</span> <span class="s2">&quot;layer_description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_env_metadata</span><span class="p">[</span><span class="s2">&quot;table_1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">df_env</span><span class="o">.</span><span class="n">at</span><span class="p">[(</span><span class="n">df_env</span><span class="p">[</span><span class="s2">&quot;layer_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;veg&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(),</span> <span class="s2">&quot;layer_description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_env_metadata</span><span class="p">[</span><span class="s2">&quot;table_2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">df_env</span><span class="o">.</span><span class="n">at</span><span class="p">[(</span><span class="n">df_env</span><span class="p">[</span><span class="s2">&quot;layer_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;wat&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(),</span> <span class="s2">&quot;layer_description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_env_metadata</span><span class="p">[</span><span class="s2">&quot;table_3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Add description to None numerical environmental vars</span>
        <span class="n">env_meta_others</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_env_metadata</span><span class="p">[</span><span class="s2">&quot;table_4&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">env_meta_others</span><span class="p">:</span>
            <span class="n">df_env</span><span class="o">.</span><span class="n">at</span><span class="p">[(</span><span class="n">df_env</span><span class="p">[</span><span class="s2">&quot;layer_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(),</span> <span class="s2">&quot;layer_description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span>
    
        <span class="c1"># Concat both clim and env final dfs</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_clim</span><span class="p">,</span> <span class="n">df_env</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>

        <span class="c1"># Extract the units to final col except unitless + categorical</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">extract_units</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
        
        <span class="c1"># Remove units from layer_description</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;layer_description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">remove_units_from_desc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;layer_description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;layer_description&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># Add categorical col for easier id</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;is_categorical&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span>


        <span class="c1"># Reorder cols</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;geoclim_type&quot;</span><span class="p">,</span> <span class="s2">&quot;layer_number&quot;</span><span class="p">,</span> <span class="s2">&quot;layer_name&quot;</span><span class="p">,</span> <span class="s2">&quot;layer_description&quot;</span><span class="p">,</span> <span class="s2">&quot;is_categorical&quot;</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">_get_categorical_df</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private method to extract the categorical data from the metadata of all layers of a raster database </span>
<span class="sd">        related to climate and environment of Madagascar. It returns a DataFrame where each row represents a </span>
<span class="sd">        distinct category within each categorical layer.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: A DataFrame containing information for each categorical value in each layer. The DataFrame</span>
<span class="sd">                has the following columns:</span>
<span class="sd">                - &#39;geoclim_type&#39;: Type of geoclimatic data.</span>
<span class="sd">                - &#39;layer_number&#39;: Numeric identifier of the layer.</span>
<span class="sd">                - &#39;layer_name&#39;: Name of the layer.</span>
<span class="sd">                - &#39;layer_description&#39;: Description of the layer.</span>
<span class="sd">                - &#39;value&#39;: Numeric identifier of the category within the layer.</span>
<span class="sd">                - &#39;category&#39;: Description of the category within the layer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract categorical only from all layers</span>
        <span class="n">all_layers_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_layers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cat_df</span> <span class="o">=</span> <span class="n">all_layers_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_layers_df</span><span class="p">[</span><span class="s2">&quot;is_categorical&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>

        <span class="c1"># Split units list into separate val, category columns</span>
        <span class="n">cat_df</span> <span class="o">=</span> <span class="n">cat_df</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s2">&quot;units&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="s2">&quot;is_categorical&quot;</span><span class="p">])</span>
        <span class="n">cat_df</span><span class="p">[[</span><span class="s2">&quot;raster_value&quot;</span><span class="p">,</span> <span class="s2">&quot;category&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cat_df</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cat_df</span> <span class="o">=</span> <span class="n">cat_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;units&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cat_df</span>

    <span class="k">def</span> <span class="nf">_load_dataformat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse the json dataformat (either clim or env) file into a dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            filepath (pathlib.Path): Path to the dataformat file.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If filepath is not a path to an existing file.</span>
<span class="sd">            ValueError: If json file cannot be parsed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing the data format information contained in the dataformat file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;.json dataformat file not found: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse json dataformat file: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_load_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse the json metadata (either clim or env) file into a dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            filepath (pathlib.Path): Path to the metadata file.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If filepath is not a path to an existing file.</span>
<span class="sd">            ValueError: If json file cannot be parsed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing the metadata contained in the metadata file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;.json dataformat file not found: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse json dataformat file: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_validate_raster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raster_attr_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates the specified raster attribute.</span>

<span class="sd">        This method checks whether the specified raster attribute exists, whether the corresponding raster file exists, </span>
<span class="sd">        and whether the raster file can be opened without any IO errors.</span>

<span class="sd">        Args:</span>
<span class="sd">            raster_attr_name (str): Name of the raster attribute to be validated.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the specified raster attribute is not defined.</span>
<span class="sd">            FileExistsError: If the corresponding raster file does not exist.</span>
<span class="sd">            IOError: If the raster file cannot be opened due to IO errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>    
        <span class="n">raster_to_check</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raster_attr_name</span><span class="p">)</span>    <span class="c1"># Fetch current value of raster attr</span>

        <span class="k">if</span> <span class="n">raster_to_check</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Undefined attribute: &#39;</span><span class="si">{</span><span class="n">raster_attr_name</span><span class="si">}</span><span class="s2">&#39;. You need to assign a valid pathlib.Path to the related raster attribute first.&quot;</span><span class="p">)</span>

        <span class="c1"># Check if raster file exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">raster_to_check</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find &#39;</span><span class="si">{</span><span class="n">raster_attr_name</span><span class="si">}</span><span class="s2">&#39; file: </span><span class="si">{</span><span class="n">raster_to_check</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
        <span class="c1"># Catch any IO errors</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_to_check</span><span class="p">)</span> <span class="k">as</span> <span class="n">raster_file</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">RasterioIOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not open &#39;</span><span class="si">{</span><span class="n">raster_attr_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">raster_to_check</span><span class="si">}</span><span class="s2">. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Tahiri Lab.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>