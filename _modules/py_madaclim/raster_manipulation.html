<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>py_madaclim.raster_manipulation &mdash; py-madaclim 0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            py-madaclim
          </a>
              <div class="version">
                0.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">py-madaclim</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">py_madaclim.raster_manipulation</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for py_madaclim.raster_manipulation</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">py_madaclim</span>
<span class="kn">from</span> <span class="nn">py_madaclim._constants</span> <span class="kn">import</span> <span class="n">Constants</span>
<span class="kn">from</span> <span class="nn">py_madaclim.info</span> <span class="kn">import</span> <span class="n">MadaclimLayers</span>

<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">import</span> <span class="nn">rasterio.errors</span>
<span class="kn">import</span> <span class="nn">rasterio.plot</span>
<span class="kn">import</span> <span class="nn">pyproj</span>
<span class="kn">from</span> <span class="nn">pyproj</span> <span class="kn">import</span> <span class="n">Transformer</span>
<span class="kn">import</span> <span class="nn">shapely</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Point</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Patch</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">ListedColormap</span><span class="p">,</span> <span class="n">BoundaryNorm</span>
<span class="kn">from</span> <span class="nn">matplotlib.lines</span> <span class="kn">import</span> <span class="n">Line2D</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>

<span class="k">class</span> <span class="nc">_PlotConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that handles the additional keyword arguments to pass to the LayerPlotter instances.</span>

<span class="sd">    This class provides properties that filter a dictionary of arguments based on specified prefixes.</span>
<span class="sd">    The properties return a dictionary that consists of only the key-value pairs where the key starts with the specified prefix, </span>
<span class="sd">    with the prefix removed from the keys.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        POSSIBLE_PREFIXES (list[str]): The list of prefixes that can be used in the plot_element_args dictionary.</span>
<span class="sd">        _plot_element_args (dict): The original dictionary passed during the object initialization.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; arg_dict = {</span>
<span class="sd">            &quot;imshow_data&quot;: 123,</span>
<span class="sd">            &quot;imshow_plot&quot;: True,</span>
<span class="sd">            &quot;cax_color&quot;: &quot;red&quot;,</span>
<span class="sd">            &quot;histplot_bins&quot;: 500,</span>
<span class="sd">        }</span>
<span class="sd">        &gt;&gt;&gt; pltcfg = _PlotConfig(arg_dict)</span>
<span class="sd">        &gt;&gt;&gt; imshow_args = pltcfg.imshow_args</span>
<span class="sd">        &gt;&gt;&gt; print(imshow_args)</span>
<span class="sd">        {&#39;data&#39;: 123, &#39;plot&#39;: True}</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">POSSIBLE_PREFIXES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;imshow_&quot;</span><span class="p">,</span> <span class="s2">&quot;cax_&quot;</span><span class="p">,</span> <span class="s2">&quot;histplot_&quot;</span><span class="p">,</span> <span class="s2">&quot;subplots_&quot;</span><span class="p">,</span> <span class="s2">&quot;rasterpoint_&quot;</span><span class="p">,</span> <span class="s2">&quot;vline_&quot;</span><span class="p">,</span> <span class="s2">&quot;barplot_&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_element_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            plot_element_args (dict, optional): The dictionary of plot element arguments. </span>
<span class="sd">                The keys should start with one of the prefixes in POSSIBLE_PREFIXES. </span>
<span class="sd">                If not provided, an empty dictionary will be used.</span>
<span class="sd">            imshow_args (dict): The dictionary of the imshow arguments stripped of the prefix.</span>
<span class="sd">            cax_args (dict): The dictionary of the cax arguments stripped of the prefix.</span>
<span class="sd">            histplot_args (dict): The dictionary of the histplot arguments stripped of the prefix.</span>
<span class="sd">            subplots_args (dict): The dictionary of the subplots arguments stripped of the prefix.</span>
<span class="sd">            rasterpoint_args (dict): The dictionary of the Geopandas.plot arguments stripped of the prefix.</span>
<span class="sd">            vline_args (dict): The dictionary of the axvline arguments stripped of the prefix.</span>
<span class="sd">            barplot_args (dict): The dictionary of the barplot arguments stripped of the prefix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_element_args</span> <span class="o">=</span> <span class="n">plot_element_args</span> <span class="k">if</span> <span class="n">plot_element_args</span> <span class="k">else</span> <span class="p">{}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_imshow_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classify_args</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;imshow_&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_plot_element_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cax_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classify_args</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;cax_&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_plot_element_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_histplot_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classify_args</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;histplot_&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_plot_element_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subplots_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classify_args</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;subplots_&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_plot_element_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rasterpoint_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classify_args</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;rasterpoint_&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_plot_element_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vline_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classify_args</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;vline_&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_plot_element_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_barplot_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classify_args</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;barplot_&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_plot_element_args</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">imshow_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the arguments for imshow, stripped of the &#39;imshow_&#39; prefix.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing the imshow arguments with &#39;imshow_&#39; prefix removed.</span>
<span class="sd">                Empty if no args with prefix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imshow_args</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cax_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the arguments for cax, stripped of the &#39;cax_&#39; prefix.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing the cax arguments with &#39;cax_&#39; prefix removed.</span>
<span class="sd">                Empty if no args with prefix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cax_args</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">histplot_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the arguments for histplot, stripped of the &#39;histplot_&#39; prefix.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing the histplot arguments with &#39;histplot_&#39; prefix removed.</span>
<span class="sd">                Empty if no args with prefix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_histplot_args</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subplots_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the arguments for histplot, stripped of the &#39;subplots_&#39; prefix.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing the histplot arguments with &#39;subplots_&#39; prefix removed.</span>
<span class="sd">                Empty if no args with prefix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subplots_args</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rasterpoint_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the arguments for the Geodataframe Point plotting on the raster representation.</span>
<span class="sd">        The arguments are stripped of the &#39;rasterpoint_&#39; prefix.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing the Geodataframe Point plotting arguments for the raster </span>
<span class="sd">                representation with the &#39;rasterpoint_&#39; prefix removed. Empty if no args with prefix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rasterpoint_args</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vline_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the arguments for the vertical line on the distribution plot.</span>
<span class="sd">        The arguments are stripped of the &#39;vline_&#39; prefix.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing the vertical line arguments for the histogram </span>
<span class="sd">                representation with the &#39;vline_&#39; prefix removed. Empty if no args with prefix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vline_args</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">barplot_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the arguments for the barplot of each sample/value.</span>
<span class="sd">        The arguments are stripped of the &#39;barplot_&#39; prefix.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing the barplot arguments for the barplot </span>
<span class="sd">                representation with the &#39;barplot_&#39; prefix removed. Empty if no args with prefix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_barplot_args</span>

    <span class="k">def</span> <span class="nf">_classify_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private helper method that classifies (filters and strips prefixes from) arguments.</span>

<span class="sd">        Args:</span>
<span class="sd">            prefix (str): The prefix to use for filtering and stripping.</span>
<span class="sd">            args (dict): The dictionary of arguments.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the prefix is not a string or if args is not a dictionary.</span>
<span class="sd">            ValueError: If the prefix is not in POSSIBLE_PREFIXES or if a key in args doesn&#39;t start with a prefix in POSSIBLE_PREFIXES.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing the arguments with the specified prefix removed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args_dict</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>    <span class="c1"># Copy to avoid inplace-changes outside method</span>
        
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;prefix&#39; must be a str.&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">POSSIBLE_PREFIXES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Specified &#39;prefix&#39; must be one of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">POSSIBLE_PREFIXES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;args&#39; must be a dictionary.&quot;</span><span class="p">)</span>

        <span class="n">classified_args</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c1"># Args with specified prefix container</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">args_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            
            <span class="c1"># Check if the key starts with the specified prefix</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\w+_&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;args&#39; must be prefixed by at least 1 alphanum char and an underscore (i.e. &#39;prefix_argument&#39;): </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="n">arg_prefix</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span>    <span class="c1"># First underscore encounter for args with native underscores</span>
                <span class="k">if</span> <span class="n">arg_prefix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">POSSIBLE_PREFIXES</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">arg_prefix</span><span class="si">}</span><span class="s2"> (derived from </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">) must be one of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">POSSIBLE_PREFIXES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">arg_prefix</span> <span class="o">==</span> <span class="n">prefix</span><span class="p">:</span>    <span class="c1"># Prefix elimination</span>
                    <span class="n">new_key</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">arg_prefix</span><span class="p">):]</span>    <span class="c1"># strip prefix by slicing the string</span>
                    <span class="n">classified_args</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        
        <span class="k">return</span> <span class="n">classified_args</span>


<span class="k">class</span> <span class="nc">_LayerPlotter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A helper class for the visualization of layers from the Madaclim database. This class handles the plotting </span>
<span class="sd">    of either categorical or continuous raster data, along with their respective distribution plots.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        layer_num (int): The number of the layer to be plotted.</span>
<span class="sd">        madaclim_layers (MadaclimLayers): An instance of the MadaclimLayers class, which contains layers&#39; information </span>
<span class="sd">            and their raster data.</span>
<span class="sd">        plot_args (dict): A dictionary containing optional arguments for the plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">madaclim_layers</span><span class="p">:</span> <span class="n">py_madaclim</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">MadaclimLayers</span><span class="p">,</span> <span class="n">plot_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize _LayerPlotter with a specific layer number, a MadaclimLayers object, and plot arguments.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            layer_num (int): The number of the layer to be plotted.</span>
<span class="sd">            madaclim_layers (MadaclimLayers): An instance of the MadaclimLayers class.</span>
<span class="sd">            plot_args (dict): A dictionary containing optional arguments for the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer_num</span> <span class="o">=</span> <span class="n">layer_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_madaclim_layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_madaclim_layers</span><span class="p">(</span><span class="n">madaclim_layers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_args</span> <span class="o">=</span> <span class="n">plot_args</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">madaclim_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">py_madaclim</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">MadaclimLayers</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets or sets for the &#39;_madaclim_layers&#39; attribute.</span>

<span class="sd">        Args:</span>
<span class="sd">            new_instance (MadaclimLayers): New instance of the MadaclimLayers class.</span>

<span class="sd">        Returns:</span>
<span class="sd">            MadaclimLayers: An instance of the MadaclimLayers class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_madaclim_layers</span>
    
    <span class="nd">@madaclim_layers</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">madaclim_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_instance</span><span class="p">:</span> <span class="n">py_madaclim</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">MadaclimLayers</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_madaclim_layers</span><span class="p">(</span><span class="n">madaclim_layers</span><span class="o">=</span><span class="n">new_instance</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_madaclim_layers</span> <span class="o">=</span> <span class="n">new_instance</span>

    <span class="k">def</span> <span class="nf">plot_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the raster map of the specified geoclimatic layer, along with a </span>
<span class="sd">        distribution histogram of the layer values. The distribution can be plotted </span>
<span class="sd">        as categorical or continuous based on the nature of the layer data.</span>

<span class="sd">        For a categorical layer, the function creates a bar plot displaying the</span>
<span class="sd">        frequency of each category in the layer. The raster map is plotted with </span>
<span class="sd">        different colors representing each category. A custom legend with categorical </span>
<span class="sd">        labels is also created.</span>

<span class="sd">        For a continuous layer, the function plots a histogram representing the </span>
<span class="sd">        frequency distribution of the layer&#39;s values. The raster map is plotted with</span>
<span class="sd">        a color gradient based on the range of the layer values. A colorbar is </span>
<span class="sd">        provided for reference.</span>

<span class="sd">        Both types of plots also include a histogram showing the distribution of </span>
<span class="sd">        raster values at 1km resolution, plotted as a bar graph for categorical </span>
<span class="sd">        data, and a histogram with optional kernel density estimation for continuous data.</span>

<span class="sd">        The appearance of the plots can be customized using the &#39;plot_args&#39; attribute (see _PlotConfig).</span>

<span class="sd">        Returns:</span>
<span class="sd">            fig (matplotlib.figure.Figure): The top-level container for all plot elements.</span>
<span class="sd">            axes (List[matplotlib.axes.Axes]): An array containing the Axes objects </span>
<span class="sd">                of the subplots.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If &#39;subplots_figsize&#39; is not a tuple.</span>
<span class="sd">            ValueError: If &#39;subplots_figsize&#39; does not contain 2 elements.</span>
<span class="sd">            TypeError: If elements of &#39;subplots_figsize&#39; are not integers.</span>
<span class="sd">            ValueError: If the keys from `get_categorical_combinations` do not match </span>
<span class="sd">                the raster values for categorical layer data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Create an instance of PlotConfig to separate categories of kwargs plot config</span>
        <span class="n">plot_cfg</span> <span class="o">=</span> <span class="n">_PlotConfig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_args</span><span class="p">)</span>
        
        <span class="c1"># Set defaults for subplots</span>
        <span class="n">subplots_figsize</span> <span class="o">=</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">subplots_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;figsize&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">subplots_nrows</span> <span class="o">=</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">subplots_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nrows&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">subplots_ncols</span> <span class="o">=</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">subplots_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;ncols&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">subplots_figsize</span><span class="p">:</span>    <span class="c1"># Better exception hints than matplotlib</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subplots_figsize</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;subplots_figsize&#39; must be a tuple.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">subplots_figsize</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;subplots_figsize&#39; must be a tuple of 2 elements.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">subplots_figsize</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ele</span><span class="si">}</span><span class="s2"> is not an int. &#39;subplots_figsize&#39; is a tuple of integers.&quot;</span><span class="p">)</span>    
        
        <span class="c1"># Set default for imshow</span>
        <span class="n">imshow_cmap</span> <span class="o">=</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">imshow_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;cmap&quot;</span><span class="p">,</span> <span class="s2">&quot;inferno&quot;</span><span class="p">)</span>

        <span class="c1"># Set defaults cbar</span>
        <span class="n">cax_position</span> <span class="o">=</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">cax_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;position&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">)</span>
        <span class="n">cax_size</span> <span class="o">=</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">cax_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="s2">&quot;5%&quot;</span><span class="p">)</span>
        <span class="n">cax_pad</span> <span class="o">=</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">cax_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;pad&quot;</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>

        <span class="c1"># Set defaults for histplot</span>
        <span class="n">histplot_color</span> <span class="o">=</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">histplot_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="s2">&quot;grey&quot;</span><span class="p">)</span>
        <span class="n">histplot_bins</span> <span class="o">=</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">histplot_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;bins&quot;</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span><span class="p">)</span>
        <span class="n">histplot_kde</span> <span class="o">=</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">histplot_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;kde&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">histplot_stat</span> <span class="o">=</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">histplot_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;stat&quot;</span><span class="p">,</span> <span class="s2">&quot;percent&quot;</span><span class="p">)</span>
        <span class="n">histplot_line_kws</span> <span class="o">=</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">histplot_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;line_kws&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;linestyle&quot;</span> <span class="p">:</span> <span class="s2">&quot;--&quot;</span><span class="p">})</span>
        
        <span class="c1"># Plotting the raster map with distribution data for the selected layer</span>
        <span class="n">band_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_madaclim_layers</span><span class="o">.</span><span class="n">get_bandnums_from_layers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer_num</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">layer_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_madaclim_layers</span><span class="o">.</span><span class="n">fetch_specific_layers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer_num</span><span class="p">,</span> <span class="s2">&quot;layer_description&quot;</span><span class="p">,</span> <span class="s2">&quot;is_categorical&quot;</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">)</span>
        <span class="n">layer_key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">layer_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">layer_info</span> <span class="o">=</span> <span class="n">layer_info</span><span class="p">[</span><span class="n">layer_key</span><span class="p">]</span>    <span class="c1"># Eliminate redundancy</span>

        <span class="n">layer_units</span> <span class="o">=</span> <span class="s2">&quot;Categorical values&quot;</span> <span class="k">if</span> <span class="n">layer_info</span><span class="p">[</span><span class="s2">&quot;is_categorical&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="n">layer_info</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span>    <span class="c1"># Simplify xlabel for categorical units</span>
        <span class="n">layer_description</span> <span class="o">=</span> <span class="n">layer_info</span><span class="p">[</span><span class="s2">&quot;layer_description&quot;</span><span class="p">]</span>

        <span class="c1"># Get geoclim type from layer_num for raster IO selection            </span>
        <span class="n">geoclim_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;clim&quot;</span><span class="p">,</span> <span class="s2">&quot;env&quot;</span><span class="p">]</span>
        <span class="n">geoclim_type</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">geotype</span> <span class="k">for</span> <span class="n">geotype</span> <span class="ow">in</span> <span class="n">geoclim_types</span> 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_num</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_madaclim_layers</span><span class="o">.</span><span class="n">select_geoclim_type_layers</span><span class="p">(</span><span class="n">geotype</span><span class="p">)[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">chosen_raster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_madaclim_layers</span><span class="o">.</span><span class="n">clim_raster</span> <span class="k">if</span> <span class="n">geoclim_type</span> <span class="o">==</span> <span class="s2">&quot;clim&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_madaclim_layers</span><span class="o">.</span><span class="n">env_raster</span>

        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">chosen_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">raster</span><span class="p">:</span>
            <span class="n">band_data</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">band_num</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Categorical data multi plots</span>
            <span class="k">if</span> <span class="n">layer_info</span><span class="p">[</span><span class="s2">&quot;is_categorical&quot;</span><span class="p">]:</span>
            
                <span class="n">subplots_figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="k">if</span> <span class="n">subplots_figsize</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">subplots_figsize</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">subplots_nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">subplots_ncols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">subplots_figsize</span><span class="p">)</span>

                <span class="c1"># Custom categorical palette for over 20 categories</span>
                <span class="n">categ_combinations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_madaclim_layers</span><span class="o">.</span><span class="n">get_categorical_combinations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer_num</span><span class="p">)</span>
                <span class="n">categ_combinations</span> <span class="o">=</span> <span class="n">categ_combinations</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_madaclim_layers</span><span class="o">.</span><span class="n">get_layers_labels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer_num</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">categ_combinations</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">categ_combinations</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>   <span class="c1"># Get categ dict {&lt;numerical_val&gt;:&lt;category&gt;}</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">categ_combinations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>    
                    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s2">&quot;#ff0000&quot;</span><span class="p">,</span> <span class="s2">&quot;#3cb44b&quot;</span><span class="p">,</span> <span class="s2">&quot;#ffe432&quot;</span><span class="p">,</span> <span class="s2">&quot;#4363d8&quot;</span><span class="p">,</span> <span class="s2">&quot;#f58231&quot;</span><span class="p">,</span> <span class="s2">&quot;#911eb4&quot;</span><span class="p">,</span> <span class="s2">&quot;#46f0f0&quot;</span><span class="p">,</span> <span class="s2">&quot;#f032e6&quot;</span><span class="p">,</span> 
                        <span class="s2">&quot;#bcf60c&quot;</span><span class="p">,</span> <span class="s2">&quot;#fabebe&quot;</span><span class="p">,</span> <span class="s2">&quot;#008080&quot;</span><span class="p">,</span> <span class="s2">&quot;#bbbbbb&quot;</span><span class="p">,</span> <span class="s2">&quot;#9a6324&quot;</span><span class="p">,</span> <span class="s2">&quot;#fffac8&quot;</span><span class="p">,</span> <span class="s2">&quot;#800000&quot;</span><span class="p">,</span> <span class="s2">&quot;#aaffc3&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;#808000&quot;</span><span class="p">,</span> <span class="s2">&quot;#ffd8b1&quot;</span><span class="p">,</span> <span class="s2">&quot;#000075&quot;</span><span class="p">,</span> <span class="s2">&quot;#e6beff&quot;</span><span class="p">,</span> <span class="s2">&quot;#ffffff&quot;</span><span class="p">,</span> <span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="s2">&quot;#bda400&quot;</span><span class="p">,</span> <span class="s2">&quot;#bd5447&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;#354555&quot;</span> 
                    <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">colors</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="n">palette</span><span class="o">=</span><span class="s2">&quot;tab20&quot;</span><span class="p">,</span> <span class="n">n_colors</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">categ_combinations</span><span class="p">))</span>

                <span class="c1"># Exclude masked values</span>
                <span class="n">unmasked_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">categ_combinations</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span><span class="p">]</span>
                <span class="n">unmasked_colors</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">unmasked_values</span><span class="p">)]</span>

                <span class="c1"># Make sure categories are sorted and mapped to colors accordingly</span>
                <span class="n">sorted_categ_combinations</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">unmasked_values</span><span class="p">,</span> <span class="n">unmasked_values</span><span class="p">)))</span>
                <span class="n">categ_colors</span> <span class="o">=</span> <span class="p">{</span><span class="n">category</span><span class="p">:</span> <span class="n">color</span> <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sorted_categ_combinations</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">unmasked_colors</span><span class="p">)}</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="n">ListedColormap</span><span class="p">(</span><span class="n">categ_colors</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

                <span class="c1"># Create boundaries based on your categories</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sorted_categ_combinations</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>

                <span class="c1"># Calculate extent of raster</span>
                <span class="n">left</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">bounds</span>

                <span class="c1"># Plot the raster map</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">band_data</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">],</span> <span class="o">**</span><span class="n">plot_cfg</span><span class="o">.</span><span class="n">imshow_args</span><span class="p">)</span>
                
                <span class="c1"># Create the legend with categorical labels</span>
                <span class="n">categ_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">categ_combinations</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span> <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">sorted_categ_combinations</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
                <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> 
                                        <span class="n">label</span><span class="o">=</span><span class="n">category</span><span class="p">)</span> <span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">category</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">categ_colors</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">categ_labels</span><span class="p">)]</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
                                
                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Madagascar </span><span class="si">{</span><span class="n">geoclim_type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> Raster Map (band=</span><span class="si">{</span><span class="n">band_num</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>    <span class="c1"># Raster map interface cleanup</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
                
                <span class="c1"># Compute categories counts, normalize and map colors</span>
                <span class="n">categ</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">band_data</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">counts_percent</span> <span class="o">=</span> <span class="p">(</span><span class="n">counts</span> <span class="o">/</span> <span class="n">counts</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">*</span> <span class="mi">100</span>
                <span class="n">categ</span> <span class="o">=</span> <span class="n">categ</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">categ</span><span class="p">)</span>
                <span class="n">categ</span> <span class="o">=</span> <span class="n">categ</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">]</span>
                <span class="n">counts_percent</span> <span class="o">=</span> <span class="n">counts_percent</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">]</span>

                <span class="n">mapped_categ_combinations</span> <span class="o">=</span> <span class="p">[</span><span class="n">sorted_categ_combinations</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sorted_categ_combinations</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">categ</span><span class="p">]</span>
                <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">mapped_categ_combinations</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Keys from `get_categorical_combinations` does not match raster values&quot;</span><span class="p">)</span>

                <span class="c1"># Normalize counts to freq percent</span>
                <span class="n">df_cat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;category&quot;</span><span class="p">:</span><span class="n">categ</span><span class="p">,</span> <span class="s2">&quot;mapped_category&quot;</span><span class="p">:</span> <span class="n">mapped_categ_combinations</span><span class="p">,</span> <span class="s2">&quot;counts_percent&quot;</span><span class="p">:</span> <span class="n">counts_percent</span><span class="p">})</span>

                <span class="c1"># Categorical bar plot</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df_cat</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">],</span> <span class="n">df_cat</span><span class="p">[</span><span class="s2">&quot;counts_percent&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">categ_colors</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Distribution of raster values at 1km resolution&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">xticks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df_cat</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">xticks</span><span class="p">))</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">layer_units</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Percent (%)&quot;</span><span class="p">)</span>

            <span class="c1"># Continous data for multi plots</span>
            <span class="k">else</span><span class="p">:</span>                  
                <span class="n">subplots_figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="k">if</span> <span class="n">subplots_figsize</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">subplots_figsize</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">subplots_nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">subplots_ncols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">subplots_figsize</span><span class="p">)</span>

                <span class="c1"># Calculate extent of raster</span>
                <span class="n">left</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">bounds</span>
                <span class="c1"># Raster map with cbar</span>
                <span class="n">imshow_vmin</span> <span class="o">=</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">imshow_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;vmin&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">band_data</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()))</span>
                <span class="n">imshow_vmax</span> <span class="o">=</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">imshow_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;vmax&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">band_data</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()))</span>
                <span class="n">rasterio</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">band_data</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">imshow_cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">imshow_vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">imshow_vmax</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">],</span> <span class="o">**</span><span class="n">plot_cfg</span><span class="o">.</span><span class="n">imshow_args</span><span class="p">)</span>    <span class="c1"># Use rasterio.plot.show() instead                </span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_images</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># get the first image</span>
                
                <span class="c1"># Colorbar customization</span>
                <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="n">cax_position</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">cax_size</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="n">cax_pad</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_cfg</span><span class="o">.</span><span class="n">cax_args</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>

                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Madagascar </span><span class="si">{</span><span class="n">geoclim_type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> Raster Map (band=</span><span class="si">{</span><span class="n">band_num</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
                
                <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>    <span class="c1"># Add units to raster map</span>
                    <span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">y0</span> <span class="o">-</span> <span class="mf">0.05</span><span class="p">,</span> 
                    <span class="n">s</span><span class="o">=</span><span class="n">layer_units</span><span class="p">,</span> 
                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> 
                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span>
                <span class="p">)</span>
                
                <span class="c1"># Plot histogram of raster vals</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">band_data</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span>
                    <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                    <span class="n">color</span><span class="o">=</span><span class="n">histplot_color</span><span class="p">,</span> 
                    <span class="n">bins</span><span class="o">=</span><span class="n">histplot_bins</span><span class="p">,</span> 
                    <span class="n">kde</span><span class="o">=</span><span class="n">histplot_kde</span><span class="p">,</span> 
                    <span class="n">stat</span><span class="o">=</span><span class="n">histplot_stat</span><span class="p">,</span>
                    <span class="n">line_kws</span><span class="o">=</span><span class="n">histplot_line_kws</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">plot_cfg</span><span class="o">.</span><span class="n">histplot_args</span>
                <span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Distribution of raster values at 1km resolution&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">layer_units</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Layer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">layer_num</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">layer_description</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span>
            <span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span>

    <span class="k">def</span> <span class="nf">_validate_madaclim_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">madaclim_layers</span><span class="p">:</span> <span class="n">py_madaclim</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">MadaclimLayers</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">py_madaclim</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">MadaclimLayers</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">madaclim_layers</span><span class="p">,</span> <span class="n">py_madaclim</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">MadaclimLayers</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;madaclim_layers&#39; must be of an instance of py_madaclim.info.MadaclimLayers&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">madaclim_layers</span><span class="o">.</span><span class="n">clim_raster</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">madaclim_layers</span><span class="o">.</span><span class="n">env_raster</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The MadaclimLayers instance must have defined &#39;clim_raster&#39; and &#39;env_raster attributes.&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">madaclim_layers</span>


<div class="viewcode-block" id="MadaclimRasters"><a class="viewcode-back" href="../../py_madaclim.html#py_madaclim.raster_manipulation.MadaclimRasters">[docs]</a><span class="k">class</span> <span class="nc">MadaclimRasters</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles operations on Madaclim climate and environmental raster files. </span>
<span class="sd">    Also provides a method to visualize the raster layers (map) and distribution of the raster values.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        clim_raster (pathlib.Path): Path to the climate raster file.</span>
<span class="sd">        clim_crs (pyproj.crs.crs.CRS): The CRS derived of the climate raster file.</span>
<span class="sd">        clim_nodata_val (float): The nodata value from the climate raster file</span>
<span class="sd">        clim_bounds (tuple): The bounds of the climate raster in order of (left, bottom, right, top)</span>
<span class="sd">        env_raster (pathlib.Path): Path to the environmental raster file.</span>
<span class="sd">        env_crs (pyproj.crs.crs.CRS): The CRS derived of the environmental raster file.</span>
<span class="sd">        env_nodata_val (float): The nodata value from the environmental raster file</span>
<span class="sd">        env_bounds (tuple): The bounds of the environmental raster in order of (left, bottom, right, top)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clim_raster</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span> <span class="n">env_raster</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a MadaclimRasters object with climate and environmental raster files.</span>

<span class="sd">        Args:</span>
<span class="sd">            clim_raster (pathlib.Path): Path to the climate raster file.</span>
<span class="sd">            env_raster (pathlib.Path): Path to the environmental raster file.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; from py_madaclim.raster_manipulation import MadaclimRasters</span>
<span class="sd">            &gt;&gt;&gt; mada_rasters = MadaclimRasters(clim_raster=&quot;madaclim_current.tif&quot;, env_raster=&quot;madaclim_enviro.tif&quot;)</span>
<span class="sd">            &gt;&gt;&gt; mada_rasters.clim_crs</span>
<span class="sd">            &lt;Derived Projected CRS: EPSG:32738&gt;</span>
<span class="sd">            Name: WGS 84 / UTM zone 38S</span>
<span class="sd">            Axis Info [cartesian]:</span>
<span class="sd">            - E[east]: Easting (metre)</span>
<span class="sd">            - N[north]: Northing (metre)</span>
<span class="sd">            Area of Use:</span>
<span class="sd">            - name: Between 42E and 48E, southern hemisphere between 80S and equator, onshore and offshore. Madagascar.</span>
<span class="sd">            - bounds: (42.0, -80.0, 48.0, 0.0)</span>
<span class="sd">            Coordinate Operation:</span>
<span class="sd">            - name: UTM zone 38S</span>
<span class="sd">            - method: Transverse Mercator</span>
<span class="sd">            Datum: World Geodetic System 1984 ensemble</span>
<span class="sd">            - Ellipsoid: WGS 84</span>
<span class="sd">            - Prime Meridian: Greenwich</span>
<span class="sd">       </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clim_raster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_raster</span><span class="p">(</span><span class="n">clim_raster</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env_raster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_raster</span><span class="p">(</span><span class="n">env_raster</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">clim_raster</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves or sets the climate raster file path.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (pathlib.Path): The new climate raster file path.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pathlib.Path: The climate raster file path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clim_raster</span>
    
    <span class="nd">@clim_raster</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">clim_raster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clim_raster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_raster</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">env_raster</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves or sets the environmental raster file path.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (pathlib.Path): The new environmental raster file path.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pathlib.Path: The environmental raster file path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_raster</span>
    
    <span class="nd">@env_raster</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">env_raster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env_raster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_raster</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">clim_crs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">CRS</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the Coordinate Reference System (CRS) from the Madaclim climate raster.</span>

<span class="sd">        This property opens the raster file and retrieves the CRS in EPSG format. The EPSG code is used to </span>
<span class="sd">        create and return a pyproj CRS object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pyproj.crs.crs.CRS: The CRS derived of the climate raster file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get epsg from clim_raster</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clim_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">clim_raster</span><span class="p">:</span>
            <span class="n">clim_epsg</span> <span class="o">=</span> <span class="n">clim_raster</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">to_epsg</span><span class="p">()</span>  <span class="c1"># Get the EPSG code of the CRS</span>
            <span class="n">clim_crs</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="o">.</span><span class="n">from_epsg</span><span class="p">(</span><span class="n">clim_epsg</span><span class="p">)</span>  <span class="c1"># Create a pyproj CRS object</span>
        <span class="k">return</span> <span class="n">clim_crs</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">clim_nodata_val</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the nodata value from the Madaclim climate raster.</span>

<span class="sd">        This property opens the raster file and retrieves nodata value from the raster.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The nodata value from the climate raster file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clim_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">clim_raster</span><span class="p">:</span>
            <span class="n">clim_nodata</span> <span class="o">=</span> <span class="n">clim_raster</span><span class="o">.</span><span class="n">nodata</span>
        <span class="k">return</span> <span class="n">clim_nodata</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">clim_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the bounds of the climate raster.</span>

<span class="sd">        This property opens the raster file and retrieves bounds values (left, bottom, right, top) from the raster.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[float]: The bounds values in order (left, bottom, right, top)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clim_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">clim_raster</span><span class="p">:</span>
            <span class="n">clim_bounds</span> <span class="o">=</span> <span class="n">clim_raster</span><span class="o">.</span><span class="n">bounds</span>
        <span class="k">return</span> <span class="n">clim_bounds</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">env_crs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">CRS</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the Coordinate Reference System (CRS) from the Madaclim environmental raster.</span>

<span class="sd">        This property opens the raster file and retrieves the CRS in EPSG format. The EPSG code is used to </span>
<span class="sd">        create and return a pyproj CRS object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pyproj.crs.crs.CRS: The CRS derived of the environmental raster file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get epsg from clim_raster</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_env_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">env_raster</span><span class="p">:</span>
            <span class="n">env_epsg</span> <span class="o">=</span> <span class="n">env_raster</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">to_epsg</span><span class="p">()</span>  <span class="c1"># Get the EPSG code of the CRS</span>
            <span class="n">env_crs</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="o">.</span><span class="n">from_epsg</span><span class="p">(</span><span class="n">env_epsg</span><span class="p">)</span>  <span class="c1"># Create a pyproj CRS object</span>
        <span class="k">return</span> <span class="n">env_crs</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">env_nodata_val</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the nodata value from the Madaclim environmental raster.</span>

<span class="sd">        This property opens the raster file and retrieves nodata value from the raster.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The nodata value from the environmental raster file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_env_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">env_raster</span><span class="p">:</span>
            <span class="n">env_nodata</span> <span class="o">=</span> <span class="n">env_raster</span><span class="o">.</span><span class="n">nodata</span>
        <span class="k">return</span> <span class="n">env_nodata</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">env_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the bounds of the climate raster.</span>

<span class="sd">        This property opens the raster file and retrieves bounds values (left, bottom, right, top) from the raster.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[float]: The bounds values in order (left, bottom, right, top)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_env_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">env_raster</span><span class="p">:</span>
            <span class="n">env_bounds</span> <span class="o">=</span> <span class="n">env_raster</span><span class="o">.</span><span class="n">bounds</span>
        <span class="k">return</span> <span class="n">env_bounds</span>
        
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;MadaclimRasters(</span><span class="se">\n\t</span><span class="s2">clim_raster = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_clim_raster</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">,&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">clim_crs = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">clim_crs</span><span class="si">}</span><span class="s2">,&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">clim_nodata_val = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">clim_nodata_val</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">env_raster = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_env_raster</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">,&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">env_crs = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env_crs</span><span class="si">}</span><span class="s2">,&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">env_nodata_val = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env_nodata_val</span><span class="si">}</span><span class="se">\n</span><span class="s2">)&quot;</span>
    <span class="p">)</span>
        <span class="k">return</span> <span class="n">info</span>
    
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>
    
<div class="viewcode-block" id="MadaclimRasters.plot_layer"><a class="viewcode-back" href="../../py_madaclim.html#py_madaclim.raster_manipulation.MadaclimRasters.plot_layer">[docs]</a>    <span class="k">def</span> <span class="nf">plot_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to plot a specific layer from the Madagascan climate/environmental raster datasets. The layer </span>
<span class="sd">        is displayed as a raster map and its distribution is plotted in a histogram. </span>

<span class="sd">        It accepts layer labels in the following formats: `layer_&lt;num&gt;` (e.g. &quot;layer_1&quot;) and `&lt;descriptive_layer_label&gt;` </span>
<span class="sd">        (e.g. &quot;annual_mean_temperature&quot;). Alternatively, the layer number can be supplied directly as an integer.</span>
<span class="sd">        </span>
<span class="sd">        Depending on whether the layer is categorical or continuous, the visualization will be different. For categorical </span>
<span class="sd">        layers, it will display a map using different colors for each category and a legend mapping categories to colors. </span>
<span class="sd">        For continuous layers, it will display a color gradient map with a color bar.</span>
<span class="sd">        </span>

<span class="sd">        Args:</span>
<span class="sd">            layer (Union[str, int]): Layer to plot. Accepts layer numbers as integers, or layer labels in </span>
<span class="sd">                                    descriptive or `layer_&lt;num&gt;` format.</span>
<span class="sd">            **kwargs: Additional arguments to customize the subplots, imshow, colorbar and histplot from matplotlib. </span>
<span class="sd">                    Use &quot;subplots_&lt;arg&gt;&quot;, &quot;imshow_&lt;arg&gt;&quot;, &quot;cax_&lt;arg&gt;&quot;, and &quot;histplot_&lt;arg&gt;&quot; formats to customize corresponding </span>
<span class="sd">                    matplotlib/sns arguments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            fig (matplotlib.figure.Figure): The top-level container for all plot elements.</span>
<span class="sd">            axes (List[matplotlib.axes.Axes]): An array containing the Axes objects </span>
<span class="sd">                of the subplots.</span>
<span class="sd">        </span>
<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If &#39;layer&#39; is not a str or an int.</span>
<span class="sd">            ValueError: If &#39;layer&#39; is not found within the range of layers.</span>
<span class="sd">        </span>
<span class="sd">        Note:</span>
<span class="sd">            This method returns the fig and axes object for further customization when used by other classes.</span>
<span class="sd">            It uses the private _PlotConfig and _LayerPlotter utility classes for the checks and vizualisation.</span>

<span class="sd">        Example:</span>
<span class="sd">            Visualization of the raster maps</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; from py_madaclim.info import MadaclimLayers</span>
<span class="sd">            &gt;&gt;&gt; # Extract environmental layers labels</span>
<span class="sd">            &gt;&gt;&gt; mada_info = MadaclimLayers(clim_raster=&quot;madaclim_current.tif&quot;, env_raster=&quot;madaclim_enviro.tif&quot;)</span>
<span class="sd">            &gt;&gt;&gt; env_labels = mada_info.get_layers_labels(&quot;env&quot;, as_descriptive_labels=True)</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; # Default visualization of the raster map</span>
<span class="sd">            &gt;&gt;&gt; from py_madaclim.raster_manipulation import MadaclimRasters</span>
<span class="sd">            &gt;&gt;&gt; mada_rasters = MadaclimRasters(clim_raster=mada_info.clim_raster, env_raster=mada_info.env_raster)    # Using common attr btw the instances</span>
<span class="sd">            &gt;&gt;&gt; mada_rasters.plot_layer(env_layers_labels[0])</span>

<span class="sd">            &gt;&gt;&gt; # Pass in any number of kwargs to the imshow or cax (raster + colorbarax) or histplot for customization</span>
<span class="sd">            &gt;&gt;&gt; mada_rasters.plot_layer(env_labels[0], imshow_cmap=&quot;terrain&quot;, histplot_binwidth=100, histplot_stat=&quot;count&quot;)</span>

<span class="sd">            &gt;&gt;&gt; # Some layers are categorical data so the figure formatting will change (no cbar)</span>
<span class="sd">            &gt;&gt;&gt; geo_rock_label = next(label for label in env_labels if &quot;geo&quot; in label)</span>
<span class="sd">            &gt;&gt;&gt; mada_rasters.plot_layer(geo_rock_label, subplots_figsize=(12, 8))</span>

<span class="sd">            &gt;&gt;&gt; # For numerical features with highly skewed distribution, specify vmin or vmax for the raster map</span>
<span class="sd">            &gt;&gt;&gt; mada_rasters.plot_layer(env_labels[3], imshow_vmin=6000)</span>

<span class="sd">            &gt;&gt;&gt; # To know which are the categorical data, use the MadaclimLayers utilities</span>
<span class="sd">            &gt;&gt;&gt; mada_info.categorical_layers    # as df</span>
<span class="sd">            &gt;&gt;&gt; mada_info.get_categorical_combinations()    # As dict, default selects all possibilities</span>
<span class="sd">        &quot;&quot;&quot;</span>
    
        <span class="c1"># Fetch metadata and layer nums with a MadaclimLayers instance</span>
        <span class="n">madaclim_info</span> <span class="o">=</span> <span class="n">MadaclimLayers</span><span class="p">(</span><span class="n">clim_raster</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clim_raster</span><span class="p">,</span> <span class="n">env_raster</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env_raster</span><span class="p">)</span>
        <span class="n">all_layers_df</span> <span class="o">=</span> <span class="n">madaclim_info</span><span class="o">.</span><span class="n">all_layers</span>
        
        <span class="c1"># Validate layers to sample</span>
        <span class="n">possible_layers_num_format</span> <span class="o">=</span> <span class="n">madaclim_info</span><span class="o">.</span><span class="n">get_layers_labels</span><span class="p">()</span>
        <span class="n">possible_layers_desc_format</span> <span class="o">=</span> <span class="n">madaclim_info</span><span class="o">.</span><span class="n">get_layers_labels</span><span class="p">(</span><span class="n">as_descriptive_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;layer&#39; must be a str or an int.&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">possible_layers_num_format</span> <span class="ow">or</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">possible_layers_desc_format</span><span class="p">:</span>    <span class="c1"># Check layer_&lt;num&gt; or descriptive format</span>
            <span class="n">layer_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">layer_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>    <span class="c1"># As single item int list</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;layer must be either a single int value or a string that can be converted to an int&quot;</span><span class="p">)</span>
  
        <span class="c1"># Validate layer number range for layer_numbers as in</span>
        <span class="n">min_layer</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">all_layers_df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">])</span>
        <span class="n">max_layer</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">all_layers_df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">min_layer</span> <span class="o">&lt;=</span> <span class="n">layer_num</span> <span class="o">&lt;=</span> <span class="n">max_layer</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;layer_number must fall between </span><span class="si">{</span><span class="n">min_layer</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">max_layer</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">layer_num</span><span class="si">=}</span><span class="s2"> is not valid.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Use LayerPlotter instance helper class to handle customization + plot layer</span>
        <span class="n">plotter</span> <span class="o">=</span> <span class="n">_LayerPlotter</span><span class="p">(</span><span class="n">layer_num</span><span class="o">=</span><span class="n">layer_num</span><span class="p">,</span> <span class="n">madaclim_layers</span><span class="o">=</span><span class="n">madaclim_info</span><span class="p">,</span> <span class="n">plot_args</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">plot_layer</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span></div>

    <span class="k">def</span> <span class="nf">_validate_raster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raster</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates given the raster file.</span>

<span class="sd">        Args:</span>
<span class="sd">            raster (Union[str, pathlib.Path]): The raster file name or path to validate</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            pathlib.Path: The path to the validated raster file.</span>
<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the input value is not a pathlib.Path or str.</span>
<span class="sd">            ValueError: If a pathlib.Path object could not be created from the input value.</span>
<span class="sd">            FileExistsError: If the file does not exist.</span>
<span class="sd">            RasterioIOError: If the raster file could not be opened.</span>
<span class="sd">            NotGeoreferencedWarning: If the raster file is not georeferenced.</span>

<span class="sd">        &quot;&quot;&quot;</span>
            <span class="c1"># Validate type</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span> <span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;env_raster&#39; must be a pathlib.Path object or str.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Validate path and file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">raster</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not create a pathlib.Path object from </span><span class="si">{</span><span class="n">raster</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="c1"># Check if raster file exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">raster</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find raster file: </span><span class="si">{</span><span class="n">raster</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Save current warning filters</span>
        <span class="n">original_filters</span> <span class="o">=</span> <span class="n">warnings</span><span class="o">.</span><span class="n">filters</span><span class="p">[:]</span>
        
        <span class="c1"># Convert NotGeoreferencedWarning to an error</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">NotGeoreferencedWarning</span><span class="p">)</span>
        <span class="c1"># Catch any RasterIO errors</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">raster_file</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">raster</span>
        <span class="k">except</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">RasterioIOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not open file: </span><span class="si">{</span><span class="n">raster</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">NotGeoreferencedWarning</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">UserWarning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Raster file </span><span class="si">{</span><span class="n">raster</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is not georeferenced: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Restore original warning filters</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">original_filters</span></div>
        

<div class="viewcode-block" id="MadaclimPoint"><a class="viewcode-back" href="../../py_madaclim.html#py_madaclim.raster_manipulation.MadaclimPoint">[docs]</a><span class="k">class</span> <span class="nc">MadaclimPoint</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class representing a specimen as a geographic point with a specific coordinate reference system (CRS)</span>
<span class="sd">    and additional attributes. The class provides methods for validating the point&#39;s coordinates</span>
<span class="sd">    and CRS, as well as sampling values from climate and environmental rasters of the Madaclim database.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        specimen_id (str): An identifier for the point.</span>
<span class="sd">        latitude (float): The latitude of the point.</span>
<span class="sd">        longitude (float): The longitude of the point.</span>
<span class="sd">        source_crs (pyproj.crs.crs.CRS): The coordinate reference system of the point.</span>
<span class="sd">        mada_geom_point (shapely.geometry.point.Point): A Shapely Point object representing the point projected </span>
<span class="sd">            in the Madaclim rasters&#39; CRS.</span>
<span class="sd">        sampled_layers (Optional[Dict[str, int]]): A dictionary containing the layers labels as keys </span>
<span class="sd">            and their values from the sampled raster at the Point&#39;s position as int.</span>
<span class="sd">            None if data has not been sampled yet.</span>
<span class="sd">        nodata_layers (Optional[List[str]]): A list containing the layers labels.</span>
<span class="sd">            None if data has not been sampled yet or no layers sampled containined `nodata` values.</span>
<span class="sd">        is_categorical_encoded (bool): The state of the `binary_encode_categorical` method. If True, the method has been called </span>
<span class="sd">            and a new set of binary features has been generated.</span>
<span class="sd">            Otherwise, either the layers have not been sampled or the categorical features not been encoded.</span>
<span class="sd">        encoded_categ</span>
<span class="sd">        encoded_categ_layers (Optional[Dict[str, int]]): A dictionary containing the set of </span>
<span class="sd">            binary encoded categorical features.</span>
<span class="sd">        gdf (gpd.GeoDataFrame): A Geopandas GeoDataFrame generated from instance attributes </span>
<span class="sd">            and mada_geom_point geometry. Updates along any changes to the instance&#39;s attributes.</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">specimen_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
            <span class="n">longitude</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
            <span class="n">latitude</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
            <span class="n">source_crs</span><span class="p">:</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">CRS</span><span class="o">=</span><span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="o">.</span><span class="n">from_epsg</span><span class="p">(</span><span class="mi">4326</span><span class="p">),</span> 
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a MadaclimPoint object with the given `specimen_id`, `latitude`, `longitude`, and `source_crs`.</span>
<span class="sd">        The coordinates provided should respect the nature of the given source CRS native units&#39; (i.e. degrees WGS84 or meters for EPSG:3857).</span>
<span class="sd">        Upon instantiation, a `mada_geom_point` is created in the projection of the rasters of Madaclim db if `source_crs` differs.</span>
<span class="sd">        Optionally, provide additional keyword arguments to store as instance attributes.</span>
<span class="sd">        A GeoDataFrame is also created and updated taking the object&#39;s attribute and using the `mada_geom_point` for geometry.</span>

<span class="sd">        Args:</span>
<span class="sd">            specimen_id (str): An identifier for the point.</span>
<span class="sd">            latitude (float): The latitude of the point.</span>
<span class="sd">            longitude (float): The longitude of the point.</span>
<span class="sd">            source_crs (pyproj.crs.crs.CRS, optional): The coordinate reference system of the point. Defaults to WGS84 (EPSG:4326).</span>
<span class="sd">            **kwargs: Additional keyword arguments to store as instance attributes.</span>
<span class="sd">            </span>
<span class="sd">        Examples:</span>
<span class="sd">            Create a MadaclimPoint instance with required parameters `specimen_id`, `longitude`, `latitude`</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; from py_madaclim.raster_manipulation import MadaclimPoint</span>
<span class="sd">            &gt;&gt;&gt; specimen_1 = MadaclimPoint(specimen_id=&quot;spe1_aren&quot;, latitude=-18.9333, longitude=48.2)    # Default CRS of EPSG:4326</span>
<span class="sd">            &gt;&gt;&gt; print(specimen_1)</span>
<span class="sd">            MadaclimPoint(</span>
<span class="sd">                specimen_id = spe1_aren,</span>
<span class="sd">                source_crs = 4326,</span>
<span class="sd">                longitude = 48.2,</span>
<span class="sd">                latitude = -18.9333,</span>
<span class="sd">                mada_geom_point = POINT (837072.9150244407 7903496.320897499),</span>
<span class="sd">                sampled_layers = None (Not sampled yet),</span>
<span class="sd">                nodata_layers = None (Not sampled yet),</span>
<span class="sd">                is_categorical_encoded = False,</span>
<span class="sd">                gdf.shape = (1, 8)</span>
<span class="sd">            )</span>

<span class="sd">            Also accepts any other kwargs and saves them as attributes with specific typing</span>

<span class="sd">            &gt;&gt;&gt; specimen_1 = MadaclimPoint(specimen_id=&quot;spe1_aren&quot;, latitude=-18.9333, longitude=48.2, genus=&quot;Coffea&quot;, species=&quot;arenesiana&quot;, has_sequencing=True)</span>
<span class="sd">            &gt;&gt;&gt; print(specimen_1)</span>
<span class="sd">            MadaclimPoint(</span>
<span class="sd">                specimen_id = spe1_aren,</span>
<span class="sd">                source_crs = 4326,</span>
<span class="sd">                longitude = 48.2,</span>
<span class="sd">                latitude = -18.9333,</span>
<span class="sd">                mada_geom_point = POINT (837072.9150244407 7903496.320897499),</span>
<span class="sd">                sampled_layers = None (Not sampled yet),</span>
<span class="sd">                nodata_layers = None (Not sampled yet),</span>
<span class="sd">                is_categorical_encoded = False,</span>
<span class="sd">                genus = Coffea,</span>
<span class="sd">                species = arenesiana,</span>
<span class="sd">                has_sequencing = 1.0,</span>
<span class="sd">                gdf.shape = (1, 11)</span>
<span class="sd">            )</span>
<span class="sd">            Core and additionnal attributes are save to a GeoDataFrame with `mada_geom_point` for geometry</span>

<span class="sd">            &gt;&gt;&gt; specimen1.gdf</span>
<span class="sd">            specimen_id	source_crs	longitude	latitude	mada_geom_point	sampled_layers	nodata_layers	is_categorical_encoded	genus	species	has_sequencing</span>
<span class="sd">            0	spe1_aren	4326	48.2	-18.9333	POINT (837072.915 7903496.321)	None	None	False	Coffea	arenesiana	1.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specimen_id</span> <span class="o">=</span> <span class="n">specimen_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_source_crs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_crs</span><span class="p">(</span><span class="n">source_crs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_longitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_lonlat</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mada_geom_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_point</span><span class="p">(</span>
            <span class="n">latitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> 
            <span class="n">longitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
            <span class="n">source_crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_crs</span>
        <span class="p">)</span>
        
        <span class="c1"># Store base attributes names/vals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__base_attr</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="c1"># Sampled/encoding states and values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nodata_layers</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Rasters updated post-sampling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__clim_raster</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__env_raster</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_categorical_encoded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoded_categ_layers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoded_categ_labels</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Store any additional keyword arguments as instance attributes</span>
        <span class="n">base_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_args_names</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_args_names</span><span class="p">()[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">additional_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base_args</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">additional_args</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="c1"># type conversion especially for csv/json data used on construction</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">value</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># Construct the GeoPandas DataFrame with all attrs and `mada_geom_point` for geometry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_geodataframe</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initial_attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>    <span class="c1"># For dealing with newly set attr post-instantiation</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">specimen_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or sets the specimen_id attribute.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (str): The new identifier for the MadaclimPoint.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The identifier for the MadaclimPoint.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_specimen_id</span>
    
    <span class="nd">@specimen_id</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">specimen_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specimen_id</span> <span class="o">=</span> <span class="n">value</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">source_crs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">CRS</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get or sets the source_crs attribute.</span>
<span class="sd">       </span>
<span class="sd">         Args:</span>
<span class="sd">            value (pyproj.crs.CRS): The coordinate reference system for the point.</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            pyproj.crs.CRS: The coordinate reference system of the point.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_crs</span>
    
    <span class="nd">@source_crs</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">source_crs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">CRS</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_source_crs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_crs</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_mada_geom_point</span><span class="p">()</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">longitude</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets or sets the longitude attribute.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (float): The longitude value of the point.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The current longitude value of the point.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_longitude</span>
    
    <span class="nd">@longitude</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">longitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_longitude&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_latitude&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_longitude</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_lonlat</span><span class="p">(</span><span class="n">longitude</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">latitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_latitude</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_mada_geom_point</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">latitude</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets or sets the latitude attribute.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (float): The latitude value of the point.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The current latitude value of the point.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latitude</span>
    
    <span class="nd">@latitude</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">latitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_longitude&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_latitude&quot;</span><span class="p">):</span>
            <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_lonlat</span><span class="p">(</span><span class="n">longitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_mada_geom_point</span><span class="p">()</span>
    

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mada_geom_point</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">Point</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mada_geom_point</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">base_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the base attributes when constructing the instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing the base attributes names as keys and their values as values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__base_attr</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sampled_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the instance&#39;s data obtained from the `sampled_from_rasters` method.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[Dict[str, int]]: A dictionary containing the layers labels as keys and their values as int.</span>
<span class="sd">                Returns None if data has not been sampled yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nodata_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the layers labels containing `nodata` values when calling the`sampled_from_rasters` method.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[List[str]]: A list containing the layers labels (either layer_&lt;num&gt; or more descriptive).</span>
<span class="sd">                Returns None if data has not been sampled yet or no layers sampled containined `nodata` values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodata_layers</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_categorical_encoded</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the state of the binary encoding of the categorical layers.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: The state of the `binary_encode_categorical` method. If True, the method has been called and a new set of binary features has been generated.</span>
<span class="sd">                Otherwise, either the layers have not been sampled or the categorical features have not been encoded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_categorical_encoded</span> 
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">encoded_categ_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the binary encoded categorical layers values.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[Dict[str, int]]: A dictionary containing the set of binary encoded categorical features.</span>
<span class="sd">                Keys are contain the layer number (or more description) and the categorical feature.</span>
<span class="sd">                Values are the binary encoded value for that given category.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encoded_categ_layers</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">encoded_categ_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the labels from the binary encoded categorical layers of the instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[List[str]]: A list containing the set of the labels from the binary encoding </span>
<span class="sd">                of categorical features. None if the categorical layers have not been encoded yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encoded_categ_labels</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">gdf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the GeoPandas DataFrame using `mada_geom_point` as geometry.</span>

<span class="sd">        Returns:</span>
<span class="sd">            gpd.GeoDataFrame: A Geopandas GeoDataFrame generated from instance attributes and Point geometry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gdf</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># Get the current state of all attributes (remove recursiveness of __base/initial attrs)</span>
        <span class="n">show_attributes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;_MadaclimPoint__base_attr&quot;</span><span class="p">,</span> 
                <span class="s2">&quot;_MadaclimPoint__initial_attributes&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_MadaclimPoint__clim_raster&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_MadaclimPoint__env_raster&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_encoded_categ_layers&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_encoded_categ_labels&quot;</span>
                <span class="p">]:</span>
                
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;_source_crs&quot;</span><span class="p">:</span>    <span class="c1"># Display EPSG code for readability</span>
                    <span class="n">show_attributes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">to_epsg</span><span class="p">()</span>
                
                <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;_sampled_layers&quot;</span><span class="p">:</span>    <span class="c1"># Display number of sampled layers or status of sampling</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span><span class="p">:</span>
                        <span class="n">show_attributes</span><span class="p">[</span><span class="s2">&quot;_len(sampled_layers)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2"> layer(s)&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">show_attributes</span><span class="p">[</span><span class="s2">&quot;_sampled_layers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;None (Not sampled yet)&quot;</span>

                <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;_nodata_layers&quot;</span><span class="p">:</span>    <span class="c1"># Display number of nodata layers or status of sampling</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span><span class="p">:</span>
                        <span class="n">show_attributes</span><span class="p">[</span><span class="s2">&quot;_len(nodata_layers)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2"> layer(s)&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodata_layers</span> <span class="k">else</span> <span class="s2">&quot;None (0 layers)&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">show_attributes</span><span class="p">[</span><span class="s2">&quot;_nodata_layers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;None (Not sampled yet)&quot;</span>

                <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;_gdf&quot;</span><span class="p">:</span>    <span class="c1"># gdf shape readability</span>
                    <span class="n">show_attributes</span><span class="p">[</span><span class="s2">&quot;_gdf.shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gdf</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">show_attributes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="c1"># Pretty format</span>
        <span class="n">show_attr_list</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">show_attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">show_attr_str</span> <span class="o">=</span> <span class="s2">&quot;,</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">show_attr_list</span><span class="p">)</span>
        <span class="n">madapoint_obj</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;MadaclimPoint(</span><span class="se">\n\t</span><span class="si">{</span><span class="n">show_attr_str</span><span class="si">}</span><span class="se">\n</span><span class="s2">)&quot;</span>
        
        <span class="k">return</span> <span class="n">madapoint_obj</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overrides the __setattr__ method to update GeoDataFrame when attributes are set.</span>

<span class="sd">        This method overrides the standard `__setattr__` method. When an attribute </span>
<span class="sd">        is set on the instance, it checks if it&#39;s a new attribute (not one of </span>
<span class="sd">        the instance&#39;s initial attributes). If it&#39;s new, the GeoDataFrame </span>
<span class="sd">        (represented by the `_gdf` attribute) is updated to reflect the new attribute. </span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): The name of the attribute being set.</span>
<span class="sd">            value (Any): The value being assigned to the attribute.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AttributeError: If the attribute being set is &#39;_initial_attributes&#39;, </span>
<span class="sd">                as this attribute is meant to remain constant after object creation.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># Call the parent class&#39;s __setattr__ first</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_MadaclimPoint__initial_attributes&quot;</span><span class="p">)</span> <span class="ow">and</span> 
            <span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;_gdf&quot;</span><span class="p">):</span>
            <span class="c1"># Update the `gdf` attribute with the newly added attribute</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_gdf</span><span class="p">()</span>
    
<div class="viewcode-block" id="MadaclimPoint.get_args_names"><a class="viewcode-back" href="../../py_madaclim.html#py_madaclim.raster_manipulation.MadaclimPoint.get_args_names">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_args_names</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets the names of the required and default arguments of the MadaclimPoint constructor.</span>

<span class="sd">        This method uses the inspect module to introspect the MadaclimPoint constructor and extract the names of its arguments.</span>
<span class="sd">        It then separates these into required arguments (those that don&#39;t have default values) and default arguments (those that do).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[list, list]: A tuple containing two lists:</span>
<span class="sd">                - The first list contains the names of the required arguments.</span>
<span class="sd">                - The second list contains the names of the default arguments.</span>
<span class="sd">                </span>
<span class="sd">        Note:</span>
<span class="sd">            - &#39;self&#39; is excluded from the returned lists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">argspec</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">MadaclimPoint</span><span class="p">)</span>
        
        <span class="c1"># Get required args names</span>
        <span class="n">num_defaults</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">argspec</span><span class="o">.</span><span class="n">defaults</span><span class="p">)</span> <span class="k">if</span> <span class="n">argspec</span><span class="o">.</span><span class="n">defaults</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">num_required</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">argspec</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">-</span> <span class="n">num_defaults</span>
        <span class="n">required_args</span> <span class="o">=</span> <span class="n">argspec</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span> <span class="n">num_required</span><span class="p">]</span>    <span class="c1"># Exclude self</span>

        <span class="c1"># Get defaults args names</span>
        <span class="n">default_args</span> <span class="o">=</span> <span class="n">argspec</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="n">num_defaults</span><span class="p">]</span> <span class="k">if</span> <span class="n">argspec</span><span class="o">.</span><span class="n">defaults</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">required_args</span><span class="p">,</span> <span class="n">default_args</span></div>
    
<div class="viewcode-block" id="MadaclimPoint.get_default_source_crs"><a class="viewcode-back" href="../../py_madaclim.html#py_madaclim.raster_manipulation.MadaclimPoint.get_default_source_crs">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_default_source_crs</span><span class="p">(</span><span class="n">as_epsg</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pyproj</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">CRS</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extracts the default value of the source_crs attribute. By default, it will return the crs as the EPSG code.</span>

<span class="sd">        Args:</span>
<span class="sd">            as_epsg (bool, optional): The EPSG code of the source_CRS. Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[pyproj.crs.crs.CRS, int]: The default value for the source_crs attribute. If true, source_crs is returned as the EPSG code of the crs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source_crs_val</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">MadaclimPoint</span><span class="p">)</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>    <span class="c1"># only 1 default args</span>
        <span class="k">if</span> <span class="n">as_epsg</span><span class="p">:</span>
            <span class="n">source_crs_val</span> <span class="o">=</span> <span class="n">source_crs_val</span><span class="o">.</span><span class="n">to_epsg</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">source_crs_val</span></div>
    
<div class="viewcode-block" id="MadaclimPoint.sample_from_rasters"><a class="viewcode-back" href="../../py_madaclim.html#py_madaclim.raster_manipulation.MadaclimPoint.sample_from_rasters">[docs]</a>    <span class="k">def</span> <span class="nf">sample_from_rasters</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">clim_raster</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span> 
            <span class="n">env_raster</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span>
            <span class="n">layers_to_sample</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> 
            <span class="n">layer_info</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Samples geoclimatic data from raster files for specified layers at the location of the instances&#39;s </span>
<span class="sd">        lat/lon coordinates from the `mada_geom_point` attribute.</span>

<span class="sd">        Calling this method will also update the `sampled_layers` attributes with the data</span>
<span class="sd">        extracted from the layers_to_sample. If sampled data containing &#39;nodata&#39; values,</span>
<span class="sd">        the `nodata_layers` attribute will be updated with the name of the layers accordingly.</span>
<span class="sd">        Also, the `gdf` attribute GeoDataFrame will be updated with the `sampled_layers`.</span>

<span class="sd">        Args:</span>
<span class="sd">            clim_raster_path (pathlib.Path): Path to the climate raster file.</span>
<span class="sd">            env_raster_path (pathlib.Path): Path to the environment raster file.</span>
<span class="sd">            layers_to_sample (Union[int, str, List[Union[int, str]]], optional): The layer number(s) to sample from the raster files.</span>
<span class="sd">                Can be a single int, a single string in the format &#39;layer_&lt;num&gt;&#39;, or the descriptive label </span>
<span class="sd">                or a list of ints or such strings. Defaults to &#39;all&#39;.</span>
<span class="sd">            layer_info (bool, optional): Whether to use descriptive labels for the returned dictionary keys. Defaults to False.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the layers_to_sample is not valid, or if the `mada_geom_point` attribute is not a Point object.</span>
<span class="sd">            ValueError: If the layer_number is out of range or if the `mada_geom_point` object is empty.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Examples:</span>
<span class="sd">            Sample a set of layers</span>
<span class="sd">            &gt;&gt;&gt; from py_madaclim.info import MadaclimLayers</span>
<span class="sd">            &gt;&gt;&gt; madaclim_info = MadaclimLayers()</span>
<span class="sd">            &gt;&gt;&gt; bioclim_labels = [label for label in madaclim_info.get_layers_labels(as_descriptive_labels=True) if &quot;bio&quot; in label]</span>

<span class="sd">            &gt;&gt;&gt; specimen_1 = MadaclimPoint(specimen_id=&quot;spe1_aren&quot;, latitude=-18.9333, longitude=48.2, genus=&quot;Coffea&quot;, species=&quot;arenesiana&quot;, has_sequencing=True)</span>
<span class="sd">            &gt;&gt;&gt; spe1_bioclim = specimen_1.sample_from_rasters(</span>
<span class="sd">            ...     clim_raster=&quot;madaclim_current.tif&quot;,</span>
<span class="sd">            ...     env_raster=&quot;madaclim_enviro.tif&quot;,</span>
<span class="sd">            ...     layers_to_sample=bioclim_labels</span>
<span class="sd">            ... )</span>
<span class="sd">            &gt;&gt;&gt; spe1_bioclim[&quot;layer_37&quot;]</span>
<span class="sd">            196</span>
<span class="sd">            &gt;&gt;&gt; # layer_info key as more descriptive and informative</span>
<span class="sd">            &gt;&gt;&gt; spe1_bioclim = specimen_1.sample_from_rasters(</span>
<span class="sd">            ...     clim_raster=&quot;madaclim_current.tif&quot;,</span>
<span class="sd">            ...     env_raster=&quot;madaclim_enviro.tif&quot;,</span>
<span class="sd">            ...     layers_to_sample=bioclim_labels,</span>
<span class="sd">            ...     layer_info=True</span>
<span class="sd">            ... )</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; bio1_label = bioclim_labels[0]</span>
<span class="sd">            &#39;clim_37_bio1 (Annual mean temperature)&#39;</span>
<span class="sd">            &gt;&gt;&gt; spe1_bioclim[bio1_label]</span>
<span class="sd">            196</span>
<span class="sd">            </span>
<span class="sd">            Warning message for NaN in the data extracted</span>
<span class="sd">            &gt;&gt;&gt; # We can easily access the nodata layers (still sampled with the method regardless)</span>
<span class="sd">            &gt;&gt;&gt; spe2_all_layers, spe2_nodata_layers = specimen_2.sample_from_rasters(</span>
<span class="sd">            ...     clim_raster=&quot;madaclim_current.tif&quot;,</span>
<span class="sd">            ...     env_raster=&quot;madaclim_enviro.tif&quot;,</span>
<span class="sd">            ...     layer_info=True, </span>
<span class="sd">            ...     return_nodata_layers=True</span>
<span class="sd">            ... )</span>
<span class="sd">            &gt;&gt;&gt; len(spe2_nodata_layers)</span>
<span class="sd">            5</span>
<span class="sd">            &gt;&gt;&gt; spe2_nodata_layers[0]    # Example of a categorical feature description with raster-value/description associations</span>
<span class="sd">            &#39;env_75_geology (1=Alluvial_&amp;_Lake_deposits, 2=Unconsolidated_Sands, 4=Mangrove_Swamp, 5=Tertiary_Limestones_+_Marls_&amp;_Chalks, 6=Sandstones, 7=Mesozoic_Limestones_+_Marls_(inc._&quot;Tsingy&quot;), 9=Lavas_(including_Basalts_&amp;_Gabbros), 10=Basement_Rocks_(Ign_&amp;_Met), 11=Ultrabasics, 12=Quartzites, 13=Marble_(Cipolin))&#39;</span>

<span class="sd">            Updated attributes post-sampling</span>
<span class="sd">            &gt;&gt;&gt; specimen_2.sample_from_rasters(</span>
<span class="sd">            ...     clim_raster=&quot;madaclim_current.tif&quot;,</span>
<span class="sd">            ...     env_raster=&quot;madaclim_enviro.tif&quot;,</span>
<span class="sd">            ...     layers_to_sample=[37, 75]</span>
<span class="sd">            ... )</span>
<span class="sd">            MadaclimPoint(</span>
<span class="sd">                    specimen_id = spe2_humb,</span>
<span class="sd">                    source_crs = 4326,</span>
<span class="sd">                    latitude = -12.716667,</span>
<span class="sd">                    longitude = 45.066667,</span>
<span class="sd">                    mada_geom_point = POINT (507237.57495924993 8594195.741515966),</span>
<span class="sd">                    len(sampled_layers) = 2 layer(s),</span>
<span class="sd">                    len(nodata_layers) = 1 layer(s),</span>
<span class="sd">                    is_categorical_encoded = False</span>
<span class="sd">                    genus = Coffea,</span>
<span class="sd">                    species = humblotiana,</span>
<span class="sd">                    has_sequencing = True,</span>
<span class="sd">                    gdf.shape = (1, 10)</span>
<span class="sd">            )</span>
<span class="sd">            &gt;&gt;&gt; specimen_2.sampled_layers</span>
<span class="sd">            {&#39;layer_37&#39;: 238, &#39;layer_75&#39;: -32768}</span>
<span class="sd">            &gt;&gt;&gt; specimen_2.nodata_layers</span>
<span class="sd">            [&#39;layer_75&#39;]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Reset rasters attributes bound to sampled_state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_MadaclimPoint__clim_raster</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_MadaclimPoint__env_raster</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Create a MadaclimRasters to validate both rasters</span>
        <span class="n">mada_rasters</span> <span class="o">=</span> <span class="n">MadaclimRasters</span><span class="p">(</span><span class="n">clim_raster</span><span class="o">=</span><span class="n">clim_raster</span><span class="p">,</span> <span class="n">env_raster</span><span class="o">=</span><span class="n">env_raster</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mada_rasters</span><span class="o">.</span><span class="n">clim_crs</span> <span class="o">!=</span> <span class="n">Constants</span><span class="o">.</span><span class="n">MADACLIM_CRS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The provided clim_raster&#39;s CRS does not corresponds to Madaclim db&#39;s expected crs: </span><span class="si">{</span><span class="n">Constants</span><span class="o">.</span><span class="n">MADACLIM_CRS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mada_rasters</span><span class="o">.</span><span class="n">env_crs</span> <span class="o">!=</span> <span class="n">Constants</span><span class="o">.</span><span class="n">MADACLIM_CRS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The provided env_raster&#39;s CRS does not corresponds to Madaclim db&#39;s expected crs: </span><span class="si">{</span><span class="n">Constants</span><span class="o">.</span><span class="n">MADACLIM_CRS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Create a MadaclimLayers instance to get layers labels and validate layers to sample</span>
        <span class="n">madaclim_info</span> <span class="o">=</span> <span class="n">MadaclimLayers</span><span class="p">(</span><span class="n">clim_raster</span><span class="o">=</span><span class="n">mada_rasters</span><span class="o">.</span><span class="n">clim_raster</span><span class="p">,</span> <span class="n">env_raster</span><span class="o">=</span><span class="n">mada_rasters</span><span class="o">.</span><span class="n">env_raster</span><span class="p">)</span>
        <span class="n">all_layers_df</span> <span class="o">=</span> <span class="n">madaclim_info</span><span class="o">.</span><span class="n">all_layers</span>
        
        <span class="c1"># Validate layers to sample</span>
        <span class="n">possible_layers_num_format</span> <span class="o">=</span> <span class="n">madaclim_info</span><span class="o">.</span><span class="n">get_layers_labels</span><span class="p">()</span>
        <span class="n">possible_layers_desc_format</span> <span class="o">=</span> <span class="n">madaclim_info</span><span class="o">.</span><span class="n">get_layers_labels</span><span class="p">(</span><span class="n">as_descriptive_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers_to_sample</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># Check if all elements are in layer_&lt;num&gt; format</span>
            <span class="n">layers_num_format</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">layer_label</span> <span class="ow">in</span> <span class="n">possible_layers_num_format</span> <span class="k">for</span> <span class="n">layer_label</span> <span class="ow">in</span> <span class="n">layers_to_sample</span><span class="p">])</span>
            <span class="n">layers_desc_format</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">layer_label</span> <span class="ow">in</span> <span class="n">possible_layers_desc_format</span> <span class="k">for</span> <span class="n">layer_label</span> <span class="ow">in</span> <span class="n">layers_to_sample</span><span class="p">])</span>

            
            <span class="k">if</span> <span class="n">layers_num_format</span> <span class="ow">or</span> <span class="n">layers_desc_format</span><span class="p">:</span>
                <span class="c1"># Save as list of ints after check</span>
                <span class="n">layers_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">layer_label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">layer_label</span> <span class="ow">in</span> <span class="n">layers_to_sample</span><span class="p">]</span>

            <span class="c1"># layers_to_sample as list of ints</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">layers_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers_to_sample</span><span class="p">]</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;layers_to_sample must be either a single int value or a string that can be converted to an int, or a list of int values or strings that can be converted to int values&quot;</span><span class="p">)</span>
        
        <span class="c1"># Single layers_to_sample type check </span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">layers_to_sample</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>    <span class="c1"># Get all layers as default</span>
                <span class="n">layers_numbers</span> <span class="o">=</span> <span class="n">all_layers_df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            
            <span class="k">elif</span> <span class="n">layers_to_sample</span> <span class="ow">in</span> <span class="n">possible_layers_num_format</span> <span class="ow">or</span> <span class="n">layers_to_sample</span> <span class="ow">in</span> <span class="n">possible_layers_desc_format</span><span class="p">:</span>    <span class="c1"># Check layer_&lt;num&gt; or desc str format</span>
                <span class="n">layers_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">layers_to_sample</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">layers_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">layers_to_sample</span><span class="p">)]</span>    <span class="c1"># As single item int list</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;layers_to_sample must be either a single int value or a string that can be converted to an int&quot;</span><span class="p">)</span>
  
        <span class="c1"># Validate layer number range for layer_numbers as in</span>
        <span class="n">min_layer</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">all_layers_df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">])</span>
        <span class="n">max_layer</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">all_layers_df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">layer_number</span> <span class="ow">in</span> <span class="n">layers_numbers</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">min_layer</span> <span class="o">&lt;=</span> <span class="n">layer_number</span> <span class="o">&lt;=</span> <span class="n">max_layer</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;layer_number must fall between </span><span class="si">{</span><span class="n">min_layer</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">max_layer</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">layer_number</span><span class="si">=}</span><span class="s2"> is not valid.&quot;</span><span class="p">)</span>
            
        <span class="c1"># Save layers and band numbers to sample for each raster</span>
        <span class="n">clim_raster_sample_info</span><span class="p">,</span> <span class="n">env_raster_sample_info</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>

        <span class="n">geoclim_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;clim&quot;</span><span class="p">,</span> <span class="s2">&quot;env&quot;</span><span class="p">]</span>
        <span class="n">geoclim_layer_ranges</span> <span class="o">=</span> <span class="p">{</span><span class="n">geoclim_type</span><span class="p">:</span> <span class="n">madaclim_info</span><span class="o">.</span><span class="n">select_geoclim_type_layers</span><span class="p">(</span><span class="n">geoclim_type</span><span class="p">)[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="k">for</span> <span class="n">geoclim_type</span> <span class="ow">in</span> <span class="n">geoclim_types</span><span class="p">}</span>

        <span class="n">clim_raster_sample_info</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">layer_num</span> <span class="k">for</span> <span class="n">layer_num</span> <span class="ow">in</span> <span class="n">layers_numbers</span> <span class="k">if</span> <span class="n">layer_num</span> <span class="ow">in</span> <span class="n">geoclim_layer_ranges</span><span class="p">[</span><span class="s2">&quot;clim&quot;</span><span class="p">]]</span>
        <span class="n">clim_raster_sample_info</span><span class="p">[</span><span class="s2">&quot;bands&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">madaclim_info</span><span class="o">.</span><span class="n">get_bandnums_from_layers</span><span class="p">(</span><span class="n">clim_raster_sample_info</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">])</span>
        <span class="n">has_clim_data</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">clim_raster_sample_info</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">False</span>

        <span class="n">env_raster_sample_info</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">layer_num</span> <span class="k">for</span> <span class="n">layer_num</span> <span class="ow">in</span> <span class="n">layers_numbers</span> <span class="k">if</span> <span class="n">layer_num</span> <span class="ow">in</span> <span class="n">geoclim_layer_ranges</span><span class="p">[</span><span class="s2">&quot;env&quot;</span><span class="p">]]</span>
        <span class="n">env_raster_sample_info</span><span class="p">[</span><span class="s2">&quot;bands&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">madaclim_info</span><span class="o">.</span><span class="n">get_bandnums_from_layers</span><span class="p">(</span><span class="n">env_raster_sample_info</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">])</span>
        <span class="n">has_env_data</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">env_raster_sample_info</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">False</span>

        <span class="c1"># # Validate if mada_geom_point attribute is of Point geom and not empty</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mada_geom_point</span><span class="p">,</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">Point</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The &#39;mada_geom_point&#39; attribute must be a shapely.geometry.point.Point object.&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mada_geom_point</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The &#39;mada_geom_point&#39; object cannot be empty.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Sample climate and env raster on demand</span>
        <span class="n">sampled_layers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">nodata_layers</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;#&quot;</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="se">\033</span><span class="s2">[1mExtracting data for: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_specimen_id</span><span class="si">}</span><span class="se">\033</span><span class="s2">[0m &quot;</span> <span class="o">+</span><span class="s2">&quot;#&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">clim_raster_sample_info</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">]:</span>
            <span class="n">total_clim_layers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">clim_raster_sample_info</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">])</span>
            
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mada_rasters</span><span class="o">.</span><span class="n">clim_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">clim_raster</span><span class="p">:</span>
                <span class="c1"># Initialize reference and container to check for layers with nodata values</span>
                <span class="n">nodata_clim</span> <span class="o">=</span> <span class="n">clim_raster</span><span class="o">.</span><span class="n">nodata</span>
                
                <span class="c1"># Status bar to display when sampling the raster</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sampling </span><span class="si">{</span><span class="n">total_clim_layers</span><span class="si">}</span><span class="s2"> layer(s) from </span><span class="si">{</span><span class="n">clim_raster</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> (geoclim_type=</span><span class="si">{</span><span class="n">geoclim_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">)...&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span>
                    <span class="n">total</span><span class="o">=</span><span class="n">total_clim_layers</span><span class="p">,</span> 
                    <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;layer&quot;</span><span class="p">,</span>
                    <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{desc}</span><span class="s2"> </span><span class="si">{percentage:.0f}</span><span class="s2">%|</span><span class="si">{bar}</span><span class="s2">| layer </span><span class="si">{n_fmt}</span><span class="s2">/</span><span class="si">{total_fmt}</span><span class="s2"> [Time remaining: </span><span class="si">{remaining}</span><span class="s2">]&quot;</span><span class="p">,</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span> <span class="p">:</span>
                    
                    <span class="c1"># Sample selected layers according to the coordinate</span>
                    <span class="k">for</span> <span class="n">layer_num</span><span class="p">,</span> <span class="n">band_num</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">clim_raster_sample_info</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">],</span> <span class="n">clim_raster_sample_info</span><span class="p">[</span><span class="s2">&quot;bands&quot;</span><span class="p">]):</span>
                        <span class="c1"># Get layer metadata for pbar display and label key for sampled_layers</span>
                        <span class="n">layer_metadata</span> <span class="o">=</span> <span class="n">madaclim_info</span><span class="o">.</span><span class="n">fetch_specific_layers</span><span class="p">(</span><span class="n">layer_num</span><span class="p">)</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracting layer </span><span class="si">{</span><span class="n">layer_num</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">layer_metadata</span><span class="p">[</span><span class="s1">&#39;layer_description&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
                        
                        <span class="c1"># Sample using the `mada_geom_point`` attributes coordinates for the current layer</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">clim_raster</span><span class="o">.</span><span class="n">sample</span><span class="p">([(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mada_geom_point</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mada_geom_point</span><span class="o">.</span><span class="n">y</span><span class="p">)],</span> <span class="n">indexes</span><span class="o">=</span><span class="n">band_num</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                        
                        <span class="c1"># Save extracted data with specified layer info/name</span>
                        <span class="n">layer_label</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">madaclim_info</span><span class="o">.</span><span class="n">get_layers_labels</span><span class="p">(</span><span class="n">layer_num</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> 
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">layer_info</span> 
                            <span class="k">else</span> <span class="n">madaclim_info</span><span class="o">.</span><span class="n">get_layers_labels</span><span class="p">(</span><span class="n">layer_num</span><span class="p">,</span> <span class="n">as_descriptive_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">sampled_layers</span><span class="p">[</span><span class="n">layer_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nodata_clim</span><span class="p">:</span>    <span class="c1"># Save layers where nodata at specimen location</span>
                            <span class="n">nodata_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer_label</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">env_raster_sample_info</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">]:</span>
            <span class="n">total_env_layers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">env_raster_sample_info</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">])</span>
            
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mada_rasters</span><span class="o">.</span><span class="n">env_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">env_raster</span><span class="p">:</span>
                <span class="c1"># Initialize reference and container to check for layers with nodata values</span>
                <span class="n">nodata_env</span> <span class="o">=</span> <span class="n">env_raster</span><span class="o">.</span><span class="n">nodata</span>
                
                <span class="c1"># Status bar to display when sampling the raster</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sampling </span><span class="si">{</span><span class="n">total_env_layers</span><span class="si">}</span><span class="s2"> layer(s) from </span><span class="si">{</span><span class="n">env_raster</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> (geoclim_type=</span><span class="si">{</span><span class="n">geoclim_types</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)...&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span>
                    <span class="n">total</span><span class="o">=</span><span class="n">total_env_layers</span><span class="p">,</span> 
                    <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;layer&quot;</span><span class="p">,</span>
                    <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{desc}</span><span class="s2"> </span><span class="si">{percentage:.0f}</span><span class="s2">%|</span><span class="si">{bar}</span><span class="s2">| layer </span><span class="si">{n_fmt}</span><span class="s2">/</span><span class="si">{total_fmt}</span><span class="s2"> [Time remaining: </span><span class="si">{remaining}</span><span class="s2">]&quot;</span><span class="p">,</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span> <span class="p">:</span>
                    
                    <span class="c1"># Sample selected layers according to the coordinate</span>
                    <span class="k">for</span> <span class="n">layer_num</span><span class="p">,</span> <span class="n">band_num</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">env_raster_sample_info</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">],</span> <span class="n">env_raster_sample_info</span><span class="p">[</span><span class="s2">&quot;bands&quot;</span><span class="p">]):</span>
                        <span class="c1"># Get layer metadata for pbar display and label key for sampled_layers</span>
                        <span class="n">layer_metadata</span> <span class="o">=</span> <span class="n">madaclim_info</span><span class="o">.</span><span class="n">fetch_specific_layers</span><span class="p">(</span><span class="n">layer_num</span><span class="p">)</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracting layer </span><span class="si">{</span><span class="n">layer_num</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">layer_metadata</span><span class="p">[</span><span class="s1">&#39;layer_description&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
                        
                        <span class="c1"># Sample using the `mada_geom_point`` attributes coordinates for the current layer</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">env_raster</span><span class="o">.</span><span class="n">sample</span><span class="p">([(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mada_geom_point</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mada_geom_point</span><span class="o">.</span><span class="n">y</span><span class="p">)],</span> <span class="n">indexes</span><span class="o">=</span><span class="n">band_num</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                        
                        <span class="c1"># Save extracted data with specified layer info/name</span>
                        <span class="n">layer_label</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">madaclim_info</span><span class="o">.</span><span class="n">get_layers_labels</span><span class="p">(</span><span class="n">layer_num</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> 
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">layer_info</span> 
                            <span class="k">else</span> <span class="n">madaclim_info</span><span class="o">.</span><span class="n">get_layers_labels</span><span class="p">(</span><span class="n">layer_num</span><span class="p">,</span> <span class="n">as_descriptive_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">sampled_layers</span><span class="p">[</span><span class="n">layer_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nodata_env</span><span class="p">:</span>    <span class="c1"># Save layers where nodata at specimen location</span>
                            <span class="n">nodata_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer_label</span><span class="p">)</span>
                                    

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodata_layers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>    <span class="c1"># No raising exception, just warning print</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BEWARE! </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">nodata_layers</span><span class="p">)</span><span class="si">}</span><span class="s2"> layer(s) contain a nodata value at the specimen location&quot;</span><span class="p">)</span>

        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>    <span class="c1"># Total raster sampling time</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Finished raster sampling operation in </span><span class="si">{</span><span class="n">elapsed_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Reset categorical encoding attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_categorical_encoded</span> <span class="o">=</span> <span class="kc">False</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoded_categ_layers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoded_categ_labels</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Update private rasters attributes for plot_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_MadaclimPoint__clim_raster</span> <span class="o">=</span> <span class="n">mada_rasters</span><span class="o">.</span><span class="n">clim_raster</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_MadaclimPoint__env_raster</span> <span class="o">=</span> <span class="n">mada_rasters</span><span class="o">.</span><span class="n">env_raster</span>
        
        <span class="c1"># Update related-instance attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nodata_layers</span> <span class="o">=</span> <span class="n">nodata_layers</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodata_layers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">nodata_val</span> <span class="o">=</span> <span class="n">nodata_clim</span> <span class="k">if</span> <span class="n">has_clim_data</span> <span class="k">else</span> <span class="n">nodata_env</span>    <span class="c1"># OK because clim_nodata == env_nodata</span>
        
        <span class="n">converted_nan_sampled_layers</span> <span class="o">=</span> <span class="p">{</span>    <span class="c1"># Replace nodata int with NaN</span>
            <span class="n">layer_label</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="n">nodata_val</span> <span class="k">else</span> <span class="n">val</span> <span class="k">for</span> <span class="n">layer_label</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">sampled_layers</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span> <span class="o">=</span> <span class="n">converted_nan_sampled_layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_gdf</span><span class="p">()</span></div>

            
<div class="viewcode-block" id="MadaclimPoint.binary_encode_categorical"><a class="viewcode-back" href="../../py_madaclim.html#py_madaclim.raster_manipulation.MadaclimPoint.binary_encode_categorical">[docs]</a>    <span class="k">def</span> <span class="nf">binary_encode_categorical</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Binary encodes the categorical layers contained in the `sampled_layers` attribute.</span>

<span class="sd">        This function performs binary encoding of categorical layers</span>
<span class="sd">        found in the raster data. It uses the `MadaclimLayers` object </span>
<span class="sd">        to get information about possible categorical layers. If no</span>
<span class="sd">        categorical layers are found in the data, a ValueError is raised.</span>
<span class="sd">        After the encoding, the function updates the respective instance</span>
<span class="sd">        attributes for the categorical encoding status, the encoded</span>
<span class="sd">        layers and the gdf replacing the categorical columns by the binary encoded features.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If no categorical layers are found in the raster</span>
<span class="sd">            data or if the raster data has not been sampled yet.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Raster data have not been sampled yet. Use `sample_from_rasters` method prior.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Check if sampled_layers contains categorical data</span>
        <span class="n">madaclim_info</span> <span class="o">=</span> <span class="n">MadaclimLayers</span><span class="p">()</span>
        <span class="n">possible_categ_labels</span> <span class="o">=</span> <span class="n">madaclim_info</span><span class="o">.</span><span class="n">get_categorical_combinations</span><span class="p">()</span>
        <span class="n">possible_descriptive_categ_labels</span> <span class="o">=</span> <span class="n">madaclim_info</span><span class="o">.</span><span class="n">get_categorical_combinations</span><span class="p">(</span><span class="n">as_descriptive_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">sampled_layers_labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">categ_layers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">possible_categ_labels</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">possible_descriptive_categ_labels</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">intersect_layers</span> <span class="o">=</span> <span class="n">sampled_layers_labels</span> <span class="o">&amp;</span> <span class="n">categ_layers</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">intersect_layers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No categorical data to encode in &#39;sampled_layers&#39;. It must contain at least one categorical layer.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Either one of:</span><span class="se">\n</span><span class="si">{</span><span class="n">possible_categ_labels</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2"> Or one of:</span><span class="se">\n</span><span class="si">{</span><span class="n">possible_descriptive_categ_labels</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;See `get_categorical_combinations` from `MadaclimLayers`&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Extract categorical data from sampled_layers and encode them into binary features</span>
        <span class="n">encoded_categ</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">intersect_layers</span><span class="p">):</span>
            <span class="c1"># Remove the category units from the descriptive label</span>
            <span class="n">layer_label</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(categ_vals:.*?\)&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span>
            <span class="n">layer_label</span> <span class="o">=</span> <span class="n">layer_label</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>    
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span>
            <span class="n">categories_dict</span> <span class="o">=</span> <span class="n">possible_categ_labels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="n">possible_descriptive_categ_labels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="p">{})</span>
            
            <span class="k">for</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">categories_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">encoded_categ</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer_label</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">dummy</span> <span class="o">==</span> <span class="n">value</span> <span class="k">else</span> <span class="mi">0</span>
                
            <span class="c1"># Create an additional &#39;nodata&#39; category for layers with missing vals</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodata_layers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodata_layers</span><span class="p">:</span>
                    <span class="n">encoded_categ</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer_label</span><span class="si">}</span><span class="s2">__nodata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>   
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">encoded_categ</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer_label</span><span class="si">}</span><span class="s2">__nodata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">encoded_categ</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer_label</span><span class="si">}</span><span class="s2">__nodata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">encoded_categ</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">encoded_categ</span><span class="o">.</span><span class="n">items</span><span class="p">())}</span>

        <span class="c1"># Update categorical layers-related attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_categorical_encoded</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoded_categ_layers</span> <span class="o">=</span> <span class="n">encoded_categ</span>    <span class="c1"># Overridden `settr` will update `gdf`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoded_categ_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">encoded_categ</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>

<div class="viewcode-block" id="MadaclimPoint.plot_on_layer"><a class="viewcode-back" href="../../py_madaclim.html#py_madaclim.raster_manipulation.MadaclimPoint.plot_on_layer">[docs]</a>    <span class="k">def</span> <span class="nf">plot_on_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a layer as a raster map and distribution plot with a focus on the MadaclimPoint object.</span>
<span class="sd">        </span>
<span class="sd">        Based on the Madaclim&#39;s CRS, the MadaclimPoint&#39;s geometry (`mada_geom_point`) is plotted</span>
<span class="sd">        on the raster map and the sampled value is displayed against a distribution of all</span>
<span class="sd">        possible values for that layer in Madaclim db. Pass addition kwargs to customize each</span>
<span class="sd">        subplots (See **kwargs, _LayerPlotter and _LayerConfig for more details).</span>
<span class="sd">        </span>
<span class="sd">        Parameters:</span>
<span class="sd">            layer (Union[str, int]): Layer to plot. Accepts layer numbers as integers, or layer labels in </span>
<span class="sd">                descriptive or `layer_&lt;num&gt;` format.</span>
<span class="sd">            **kwargs: Additional arguments to customize the subplots, imshow, colorbar, histplot and Point objects from matplotlib. </span>
<span class="sd">                Use &quot;subplots_&lt;arg&gt;&quot;, &quot;imshow_&lt;arg&gt;&quot;, &quot;cax_&lt;arg&gt;&quot;, and &quot;histplot_&lt;arg&gt;&quot; formats to customize corresponding </span>
<span class="sd">                the base Raster and histogram plots as matplotlib/sns arguments. </span>
<span class="sd">                Use &quot;point_&lt;arg&gt;&quot; to customize the Point objects on the raster.</span>
<span class="sd">                Use &quot;vline_&lt;arg&gt;&quot; to customize the vertical line on the distribution plot.</span>
<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the specified layer to plot is not has not been sampled yet.</span>
<span class="sd">            ValueError: If the layer label cannot be found within the sampled layers.</span>
<span class="sd">                    </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">layer_name_range_validation</span><span class="p">(</span>
                <span class="n">clim_raster</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">],</span>
                <span class="n">env_raster</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">],</span>
                <span class="n">layer</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">py_madaclim</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">MadaclimLayers</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Validates the input layer before the visualization. Checks for valid types and values</span>
<span class="sd">            based on the MadaclimLayers properties.</span>

<span class="sd">            Args:</span>
<span class="sd">                clim_raster (Union[str, pathlib.Path]): Path to the climate raster file.</span>
<span class="sd">                env_raster (Union[str, pathlib.Path]): Path to the environmental raster file.</span>
<span class="sd">                layer (Union[str, int]): Layer to validate. Accepts layer numbers as integers, or layer labels in </span>
<span class="sd">                    descriptive or `layer_&lt;num&gt;` format.descriptive or `layer_&lt;num&gt;` format.</span>

<span class="sd">            Raises:</span>
<span class="sd">                TypeError: If &#39;layer&#39; is not a str or an int.</span>
<span class="sd">                TypeError: If &#39;layer&#39; is a number and cannot be converted to an int.</span>
<span class="sd">                ValueError: If &#39;layer&#39; is not found within the range of layers.</span>

<span class="sd">            Returns:</span>
<span class="sd">                py_madaclim.info.MadaclimLayers: An &#39;MadaclimLayers&#39; instance if layer is valid.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            
            <span class="c1"># Fetch metadata and layer nums with a MadaclimLayers instance</span>
            <span class="n">mada_info</span> <span class="o">=</span> <span class="n">MadaclimLayers</span><span class="p">(</span><span class="n">clim_raster</span><span class="o">=</span><span class="n">clim_raster</span><span class="p">,</span> <span class="n">env_raster</span><span class="o">=</span><span class="n">env_raster</span><span class="p">)</span>
            <span class="n">all_layers_df</span> <span class="o">=</span> <span class="n">mada_info</span><span class="o">.</span><span class="n">all_layers</span>
            
            <span class="c1"># Validate layers to sample</span>
            <span class="n">possible_layers_num_format</span> <span class="o">=</span> <span class="n">mada_info</span><span class="o">.</span><span class="n">get_layers_labels</span><span class="p">()</span>
            <span class="n">possible_layers_desc_format</span> <span class="o">=</span> <span class="n">mada_info</span><span class="o">.</span><span class="n">get_layers_labels</span><span class="p">(</span><span class="n">as_descriptive_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;layer&#39; must be a str or an int.&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">possible_layers_num_format</span> <span class="ow">or</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">possible_layers_desc_format</span><span class="p">:</span>    <span class="c1"># Check layer_&lt;num&gt; or descriptive format</span>
                <span class="n">layer_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">layer_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>    <span class="c1"># As single item int list</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;layer must be either a single int value or a string that can be converted to an int&quot;</span><span class="p">)</span>
    
            <span class="c1"># Validate layer number range for layer_numbers as in</span>
            <span class="n">min_layer</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">all_layers_df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">])</span>
            <span class="n">max_layer</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">all_layers_df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">min_layer</span> <span class="o">&lt;=</span> <span class="n">layer_num</span> <span class="o">&lt;=</span> <span class="n">max_layer</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;layer_number must fall between </span><span class="si">{</span><span class="n">min_layer</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">max_layer</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">layer_num</span><span class="si">=}</span><span class="s2"> is not valid.&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">mada_info</span>

        <span class="c1"># Validate object&#39;s raster-sampled state</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MadaclimPoint__clim_raster</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_MadaclimPoint__env_raster</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;No &#39;clim_raster&#39; and &#39;env_raster&#39; found, use &#39;sample_from_rasters&#39; prior to setup a reference to the raster files location.&quot;</span>
            <span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No sampled layers to plot.&quot;</span><span class="p">)</span>

        <span class="c1"># Layer validation pre-plotting</span>
        <span class="n">mada_rasters</span> <span class="o">=</span> <span class="n">MadaclimRasters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MadaclimPoint__clim_raster</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MadaclimPoint__env_raster</span><span class="p">)</span>
        <span class="n">mada_info</span> <span class="o">=</span> <span class="n">layer_name_range_validation</span><span class="p">(</span><span class="n">mada_rasters</span><span class="o">.</span><span class="n">clim_raster</span><span class="p">,</span> <span class="n">mada_rasters</span><span class="o">.</span><span class="n">env_raster</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span>

        <span class="n">layer_number</span> <span class="o">=</span> <span class="n">mada_info</span><span class="o">.</span><span class="n">fetch_specific_layers</span><span class="p">(</span><span class="n">layer</span><span class="p">)[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">simple_layer_label</span> <span class="o">=</span> <span class="n">mada_info</span><span class="o">.</span><span class="n">get_layers_labels</span><span class="p">(</span><span class="n">layer_number</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">detailed_layer_label</span> <span class="o">=</span> <span class="n">mada_info</span><span class="o">.</span><span class="n">get_layers_labels</span><span class="p">(</span><span class="n">layer_number</span><span class="p">,</span> <span class="n">as_descriptive_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">simple_layer_label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span> <span class="ow">or</span>
            <span class="n">detailed_layer_label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Input layer &#39;</span><span class="si">{</span><span class="n">simple_layer_label</span><span class="si">}</span><span class="s2">&#39; or &#39;</span><span class="si">{</span><span class="n">detailed_layer_label</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;cannot be found within the &#39;sampled_layers&#39; at this current state. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Use the &#39;sample_from_rasters&#39; method to address that prior to &#39;plot_on_layer&#39;.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Extract gdf Point plotting configs + defaults</span>
        <span class="n">plot_cfg</span> <span class="o">=</span> <span class="n">_PlotConfig</span><span class="p">(</span><span class="n">plot_element_args</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">rasterpoint_args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">rasterpoint_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">),</span>
            <span class="s2">&quot;markersize&quot;</span><span class="p">:</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">rasterpoint_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;markersize&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
            <span class="s2">&quot;marker&quot;</span><span class="p">:</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">rasterpoint_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;marker&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">),</span>
            <span class="s2">&quot;edgecolor&quot;</span><span class="p">:</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">rasterpoint_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;edgecolor&quot;</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">),</span>
            <span class="s2">&quot;linestyle&quot;</span><span class="p">:</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">rasterpoint_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;linestyle&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span>
            <span class="s2">&quot;legend&quot;</span><span class="p">:</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">rasterpoint_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;legend&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="s2">&quot;legend_kwds&quot;</span><span class="p">:</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">rasterpoint_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;legend_kwds&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)}),</span>
            <span class="s2">&quot;customlabel&quot;</span><span class="p">:</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">rasterpoint_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;customlabel&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_specimen_id</span><span class="p">)</span>

        <span class="p">}</span>

        <span class="c1"># Plot base raster and distribution histograms</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">mada_rasters</span><span class="o">.</span><span class="n">plot_layer</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">raster_legend</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span>
        
        <span class="c1"># Overlay with mada_geom_point</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gdf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
            <span class="n">color</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">],</span> 
            <span class="n">markersize</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;markersize&quot;</span><span class="p">],</span> 
            <span class="n">marker</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;marker&quot;</span><span class="p">],</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;edgecolor&quot;</span><span class="p">],</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;linestyle&quot;</span><span class="p">],</span>
            <span class="n">legend</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">],</span> 
            <span class="n">legend_kwds</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;legend_kwds&quot;</span><span class="p">],</span>
            <span class="o">**</span><span class="n">plot_cfg</span><span class="o">.</span><span class="n">rasterpoint_args</span>
        <span class="p">)</span>

        <span class="c1"># Create a custom legend based on the rasterpoint_args</span>
        <span class="k">if</span> <span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">]:</span>
            <span class="n">legend_handle</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">(</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                <span class="n">marker</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;marker&quot;</span><span class="p">],</span>
                <span class="n">markersize</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;markersize&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">20</span><span class="p">,</span>
                <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;edgecolor&quot;</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">],</span> 
                <span class="n">linestyle</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;linestyle&quot;</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;customlabel&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">legend_handle</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;legend_kwds&quot;</span><span class="p">][</span><span class="s2">&quot;loc&quot;</span><span class="p">])</span>

        <span class="c1"># Add the raster legend back to the plot in a different location</span>
        <span class="k">if</span> <span class="n">raster_legend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">raster_legend</span><span class="p">)</span>
            <span class="n">raster_legend</span><span class="o">.</span><span class="n">set_bbox_to_anchor</span><span class="p">((</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Extract value to plot vline on dist plot        </span>
        <span class="k">if</span> <span class="n">simple_layer_label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span><span class="p">:</span>
            <span class="n">sampled_layer_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span><span class="p">[</span><span class="n">simple_layer_label</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">detailed_layer_label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span><span class="p">:</span>
            <span class="n">sampled_layer_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span><span class="p">[</span><span class="n">detailed_layer_label</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>    <span class="c1"># Failsafe</span>
                <span class="sa">f</span><span class="s2">&quot;Could not find </span><span class="si">{</span><span class="n">simple_layer_label</span><span class="si">}</span><span class="s2"> or </span><span class="si">{</span><span class="n">detailed_layer_label</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            
        <span class="c1"># default kwargs for vline</span>
        <span class="n">vline_args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">vline_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;linestyle&quot;</span><span class="p">:</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">vline_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;linestyle&quot;</span><span class="p">,</span> <span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;linestyle&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">vline_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;linewidth&quot;</span><span class="p">,</span> <span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;markersize&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">25</span><span class="p">),</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">vline_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_specimen_id</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">sampled_layer_val</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">vline_args</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">],</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="n">vline_args</span><span class="p">[</span><span class="s2">&quot;linestyle&quot;</span><span class="p">],</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="n">vline_args</span><span class="p">[</span><span class="s2">&quot;linewidth&quot;</span><span class="p">],</span>
            <span class="n">label</span><span class="o">=</span><span class="n">vline_args</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">],</span>
            <span class="o">**</span><span class="n">plot_cfg</span><span class="o">.</span><span class="n">vline_args</span>
        <span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span></div>
                

    <span class="k">def</span> <span class="nf">_validate_crs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">CRS</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate the input CRS and return a valid CRS object.</span>

<span class="sd">        Args:</span>
<span class="sd">            crs (pyproj.crs.CRS): The input CRS to validate.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pyproj.crs.CRS: A valid CRS object.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the input CRS is invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">valid_crs</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">CRSError</span><span class="p">:</span>
            <span class="n">crs_error</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid CRS: </span><span class="si">{</span><span class="n">crs</span><span class="si">}</span><span class="s2">. For simplicy, validate your crs if using EPSG codes by using:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&gt;&gt;&gt; your_crs in [int(code) for code in pyproj.get_codes(&#39;EPSG&#39;, &#39;CRS&#39;)]</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Or check the PyProj documentation: https://pyproj4.github.io/pyproj/&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">crs_error</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">valid_crs</span>
    
    <span class="k">def</span> <span class="nf">_validate_lonlat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">longitude</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">latitude</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate if the given longitude and latitude fall within the bounds of the Madaclim rasters.</span>

<span class="sd">        If the source CRS differs from the Madaclim rasters&#39; CRS, the provided longitude and latitude are </span>
<span class="sd">        reprojected to the Madaclim rasters&#39; CRS for validation. If the source CRS and the rasters&#39; CRS are the same, </span>
<span class="sd">        the provided coordinates are directly validated against the rasters&#39; bounds.</span>

<span class="sd">        Args:</span>
<span class="sd">            longitude (float): The longitude to validate.</span>
<span class="sd">            latitude (float): The latitude to validate.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[float]: T original longitude and latitude values if valid.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the provided longitude or latitude can&#39;t be converted to float.</span>
<span class="sd">            ValueError: If the reprojected or original longitude or latitude don&#39;t fall within the bounds of the Madaclim rasters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">longitude</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">longitude</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not convert </span><span class="si">{</span><span class="n">longitude</span><span class="si">}</span><span class="s2"> to float. Longitude must be a float.&quot;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">latitude</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">latitude</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not convert </span><span class="si">{</span><span class="n">latitude</span><span class="si">}</span><span class="s2"> to float. Latitude must be a float.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Define Madaclim rasters&#39; crs and native units bounds</span>
        <span class="n">madarasters_crs</span> <span class="o">=</span> <span class="n">Constants</span><span class="o">.</span><span class="n">MADACLIM_CRS</span>
        <span class="n">madarasters_native_bounds</span> <span class="o">=</span> <span class="n">Constants</span><span class="o">.</span><span class="n">MADACLIM_RASTERS_BOUNDS</span>    <span class="c1"># (298000.0, 7155000.0, 1101000.0, 8683000.0)</span>
        <span class="n">raster_min_x</span><span class="p">,</span> <span class="n">raster_max_x</span> <span class="o">=</span> <span class="n">madarasters_native_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">madarasters_native_bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">raster_min_y</span><span class="p">,</span> <span class="n">raster_max_y</span> <span class="o">=</span> <span class="n">madarasters_native_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">madarasters_native_bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_crs</span> <span class="o">!=</span> <span class="n">madarasters_crs</span><span class="p">:</span>
            
            <span class="c1"># Reproject the lonlat coords to the Madaclim rasters&#39; crs</span>
            <span class="n">mada_transformer</span> <span class="o">=</span> <span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_crs</span><span class="p">,</span> <span class="n">madarasters_crs</span><span class="p">,</span> <span class="n">always_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">reproj_lon</span><span class="p">,</span> <span class="n">reproj_lat</span> <span class="o">=</span> <span class="n">mada_transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">)</span>

            <span class="c1"># Get madarasters&#39; bounds in the source_crs&#39; projection</span>
            <span class="n">mada_bounds_reproj_source_crs</span> <span class="o">=</span> <span class="n">mada_transformer</span><span class="o">.</span><span class="n">transform_bounds</span><span class="p">(</span><span class="o">*</span><span class="n">madarasters_native_bounds</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;INVERSE&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">raster_min_x</span> <span class="o">&lt;=</span> <span class="n">reproj_lon</span> <span class="o">&lt;=</span> <span class="n">raster_max_x</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">longitude</span><span class="si">=}</span><span class="s2"> is out of bounds of the Madaclim rasters&#39; for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_specimen_id</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Longitude must fall between </span><span class="si">{</span><span class="n">mada_bounds_reproj_source_crs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;and </span><span class="si">{</span><span class="n">mada_bounds_reproj_source_crs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> (according to `source_crs`).&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">raster_min_y</span> <span class="o">&lt;=</span> <span class="n">reproj_lat</span> <span class="o">&lt;=</span> <span class="n">raster_max_y</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">latitude</span><span class="si">=}</span><span class="s2"> is out of bounds of the Madaclim rasters&#39; for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_specimen_id</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Latitude must fall between </span><span class="si">{</span><span class="n">mada_bounds_reproj_source_crs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;and </span><span class="si">{</span><span class="n">mada_bounds_reproj_source_crs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> (according to `source_crs`).&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">raster_min_x</span> <span class="o">&lt;=</span> <span class="n">longitude</span> <span class="o">&lt;=</span> <span class="n">raster_max_x</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">longitude</span><span class="si">=}</span><span class="s2"> is out of bounds of the Madaclim rasters&#39; for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_specimen_id</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Longitude must fall between </span><span class="si">{</span><span class="n">raster_min_x</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">raster_max_x</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">raster_min_y</span> <span class="o">&lt;=</span> <span class="n">latitude</span> <span class="o">&lt;=</span> <span class="n">raster_max_y</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">latitude</span><span class="si">=}</span><span class="s2"> is out of bounds of the Madaclim rasters&#39; for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_specimen_id</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Latitude must fall between </span><span class="si">{</span><span class="n">raster_min_y</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">raster_max_y</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span>
    
    <span class="c1">#!DEPRECATED METHOD</span>
    <span class="k">def</span> <span class="nf">_validate_lat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latitude</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate the input latitude value and return a valid latitude.</span>

<span class="sd">        Args:</span>
<span class="sd">            latitude (float): The input latitude value.</span>
<span class="sd">            crs (pyproj.crs.CRS): The coordinate reference system of the point.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: A valid latitude value.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the input latitude value cannot be converted to a float.</span>
<span class="sd">            ValueError: If the input latitude value is out of bounds for the given CRS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate float type</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">latitude</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">latitude</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not convert </span><span class="si">{</span><span class="n">latitude</span><span class="si">}</span><span class="s2"> to float. latitude must be a float.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Validate max lon according to crs bounds</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_crs</span><span class="o">.</span><span class="n">is_geographic</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_crs</span><span class="o">.</span><span class="n">area_of_use</span><span class="o">.</span><span class="n">bounds</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Extract bounds in native units of projection</span>
            <span class="n">transformer</span> <span class="o">=</span> <span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_source_crs</span><span class="o">.</span><span class="n">geodetic_crs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_crs</span><span class="p">,</span> <span class="n">always_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform_bounds</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_source_crs</span><span class="o">.</span><span class="n">area_of_use</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">min_lat</span><span class="p">,</span> <span class="n">max_lat</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_lat</span><span class="p">,</span> <span class="n">min_lat</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">min_lat</span> <span class="o">&lt;=</span> <span class="n">latitude</span> <span class="o">&lt;=</span> <span class="n">max_lat</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">latitude</span><span class="si">=}</span><span class="s2"> is out of bounds for the crs=EPSG:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_source_crs</span><span class="o">.</span><span class="n">to_epsg</span><span class="p">()</span><span class="si">}</span><span class="s2">. latitude must be between </span><span class="si">{</span><span class="n">min_lat</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">max_lat</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">latitude</span>
    
    <span class="c1">#!DEPRECATED METHOD</span>
    <span class="k">def</span> <span class="nf">_validate_lon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">longitude</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate the input longitude value and return a valid longitude.</span>

<span class="sd">        Args:</span>
<span class="sd">            longitude (float): The input longitude value.</span>
<span class="sd">            crs (pyproj.crs.CRS): The coordinate reference system of the point.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: A valid longitude value.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the input longitude value cannot be converted to a float.</span>
<span class="sd">            ValueError: If the input longitude value is out of bounds for the given CRS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate float type</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">longitude</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">longitude</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not convert </span><span class="si">{</span><span class="n">longitude</span><span class="si">}</span><span class="s2"> to float. longitude must be a float.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Validate max lon according to crs bounds</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_crs</span><span class="o">.</span><span class="n">is_geographic</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_crs</span><span class="o">.</span><span class="n">area_of_use</span><span class="o">.</span><span class="n">bounds</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Extract bounds in native units of projection</span>
            <span class="n">transformer</span> <span class="o">=</span> <span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_source_crs</span><span class="o">.</span><span class="n">geodetic_crs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_crs</span><span class="p">,</span> <span class="n">always_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform_bounds</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_source_crs</span><span class="o">.</span><span class="n">area_of_use</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">min_lon</span><span class="p">,</span> <span class="n">max_lon</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_lon</span><span class="p">,</span> <span class="n">min_lon</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">min_lon</span> <span class="o">&lt;=</span> <span class="n">longitude</span> <span class="o">&lt;=</span> <span class="n">max_lon</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">longitude</span><span class="si">=}</span><span class="s2"> is out of bounds for the crs=EPSG:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_source_crs</span><span class="o">.</span><span class="n">to_epsg</span><span class="p">()</span><span class="si">}</span><span class="s2">. Longitude must be between </span><span class="si">{</span><span class="n">min_lon</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">max_lon</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">longitude</span>
        
    
    <span class="k">def</span> <span class="nf">_get_additional_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get additional attributes of the instance.</span>

<span class="sd">        This method retrieves any attributes that were added to the instance </span>
<span class="sd">        after initialization, i.e., attributes that are not part of the base attributes.</span>

<span class="sd">        Note: This is a private method, indicated by the underscore prefix. </span>
<span class="sd">        It&#39;s intended for internal use within the class, not for use by external code.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing the names and values of the additional attributes.</span>
<span class="sd">                The dictionary keys are attribute names and the dictionary values are attribute values.</span>
<span class="sd">                If there are no additional attributes, an empty dictionary is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;_MadaclimPoint__base_attr&quot;</span><span class="p">}</span>    <span class="c1"># Remove the recursiveness of __base_attr</span>
        <span class="n">additional_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">current_attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__base_attr</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">additional_attributes</span>

    
    <span class="k">def</span> <span class="nf">_construct_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latitude</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">longitude</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">source_crs</span><span class="p">:</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">CRS</span><span class="p">)</span><span class="o">-&gt;</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">Point</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a Shapely Point object in the given source_crs, reprojecting the point if necessary.</span>

<span class="sd">        Args:</span>
<span class="sd">            latitude (float): The latitude of the point.</span>
<span class="sd">            longitude (float): The longitude of the point.</span>
<span class="sd">            source_crs (pyproj.crs.crs.CRS): The coordinate reference system of the point.</span>

<span class="sd">        Returns:</span>
<span class="sd">            shapely.geometry.point.Point: A Shapely Point object representing the point in the appropriate CRS.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the climate and environmental rasters have different CRS, which is unexpected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">madaclim_crs</span> <span class="o">=</span> <span class="n">Constants</span><span class="o">.</span><span class="n">MADACLIM_CRS</span>
        
        <span class="c1"># Create a Point object in the source CRS</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">source_crs</span> <span class="o">==</span> <span class="n">madaclim_crs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">point</span>

        <span class="c1"># Create a transformer object for converting coordinates between the two CRS</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">transformer</span> <span class="o">=</span> <span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="n">source_crs</span><span class="p">,</span> <span class="n">madaclim_crs</span><span class="p">,</span> <span class="n">always_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">point</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="n">reprojected_point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">reprojected_point</span>
    
    <span class="k">def</span> <span class="nf">_update_mada_geom_point</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the `mada_geom_point` attribute by reconstructing the point </span>
<span class="sd">        with the current latitude, longitude, and source_crs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_latitude&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_longitude&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mada_geom_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_point</span><span class="p">(</span>
                <span class="n">latitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_latitude</span><span class="p">,</span>
                <span class="n">longitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_longitude</span><span class="p">,</span>
                <span class="n">source_crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_source_crs</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_geodataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">geopandas</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs a GeoPandas DataFrame using the instance&#39;s attributes.</span>

<span class="sd">        This method constructs a GeoPandas DataFrame using the attributes of </span>
<span class="sd">        the instance, excluding base attributes and initial attributes. The </span>
<span class="sd">        DataFrame uses `mada_geom_point` as its geometry. </span>
<span class="sd">        </span>
<span class="sd">        Some of the object&#39;s attributes will be modified or ommitted completely</span>
<span class="sd">        to improve readability and increase relevancy of the data saved to</span>
<span class="sd">        the GeoDataFrame.</span>

<span class="sd">        Note:</span>
<span class="sd">            This is a private method, indicated by the underscore prefix. </span>
<span class="sd">            It&#39;s intended for internal use within the class, not for use </span>
<span class="sd">            by external code.</span>

<span class="sd">        Returns:</span>
<span class="sd">            gpd.geopandas: A GeoPandas DataFrame constructed using the </span>
<span class="sd">                instance&#39;s attributes.</span>

<span class="sd">        &quot;&quot;&quot;</span>
         <span class="c1"># Get the current state of all attributes (remove recursiveness of __base/initial attrs)</span>
        <span class="n">point_attributes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;_gdf&quot;</span><span class="p">,</span> 
                <span class="s2">&quot;_encoded_categ_layers&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_encoded_categ_labels&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_MadaclimPoint__base_attr&quot;</span><span class="p">,</span> 
                <span class="s2">&quot;_MadaclimPoint__initial_attributes&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_MadaclimPoint__clim_raster&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_MadaclimPoint__env_raster&quot;</span>
            <span class="p">]:</span>      
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;_source_crs&quot;</span><span class="p">:</span>    <span class="c1"># Display EPSG code for readability</span>
                    <span class="n">point_attributes</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">to_epsg</span><span class="p">()]</span>
                
                <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;_sampled_layers&quot;</span><span class="p">:</span>    <span class="c1"># Display number of sampled layers or None if not sampled yet</span>
                    <span class="n">point_attributes</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span> <span class="k">else</span> <span class="n">v</span><span class="p">]</span>    

                <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;_nodata_layers&quot;</span><span class="p">:</span>    <span class="c1"># Display number of nodata layers or status of sampling</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span><span class="p">:</span>
                        <span class="n">point_attributes</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodata_layers</span> <span class="k">else</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">point_attributes</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>    <span class="c1"># Remaining custom defined attributes at construction</span>
                    <span class="n">point_attributes</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span>
        
        <span class="c1"># Construct gdf with raster sampling state/len</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">point_attributes</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s2">&quot;mada_geom_point&quot;</span><span class="p">)</span>

        <span class="c1"># Add separate cols for sampled layers in gdf</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">layer</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">gdf</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        
        <span class="c1"># Replace categorical layers with binary encoding</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_categorical_encoded</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encoded_categ_layers</span><span class="p">:</span>
            <span class="c1"># Find categorical layers within the `sampled_layers`</span>
            <span class="n">madaclim_info</span> <span class="o">=</span> <span class="n">MadaclimLayers</span><span class="p">()</span>
            <span class="n">possible_categ_labels</span> <span class="o">=</span> <span class="n">madaclim_info</span><span class="o">.</span><span class="n">get_categorical_combinations</span><span class="p">()</span>
            <span class="n">possible_descriptive_categ_labels</span> <span class="o">=</span> <span class="n">madaclim_info</span><span class="o">.</span><span class="n">get_categorical_combinations</span><span class="p">(</span><span class="n">as_descriptive_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="n">sampled_layers_labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">categ_layers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">possible_categ_labels</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">possible_descriptive_categ_labels</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">intersect_layers</span> <span class="o">=</span> <span class="n">sampled_layers_labels</span> <span class="o">&amp;</span> <span class="n">categ_layers</span>
            
            <span class="c1"># Replace sampled_layers with binary encoded layers in categ-only</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">intersect_layers</span><span class="p">)</span>
            <span class="n">categ_encoded_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoded_categ_layers</span><span class="p">])</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">gdf</span><span class="p">,</span> <span class="n">categ_encoded_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
           
        <span class="k">return</span> <span class="n">gdf</span>
    
    <span class="k">def</span> <span class="nf">_update_gdf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the instance&#39;s `_gdf` attribute using `_construct_geodataframe`.</span>

<span class="sd">        This method updates the _gdf attribute of the instance by calling </span>
<span class="sd">        the `_construct_geodataframe` method, which constructs a new </span>
<span class="sd">        GeoPandas DataFrame using the instance&#39;s attributes.</span>

<span class="sd">        Note:</span>
<span class="sd">            This is a private method, indicated by the underscore prefix. </span>
<span class="sd">            It&#39;s intended for internal use within the class, not for use </span>
<span class="sd">            by external code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_geodataframe</span><span class="p">()</span></div>
    
    
<div class="viewcode-block" id="MadaclimCollection"><a class="viewcode-back" href="../../py_madaclim.html#py_madaclim.raster_manipulation.MadaclimCollection">[docs]</a><span class="k">class</span> <span class="nc">MadaclimCollection</span><span class="p">:</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">madaclim_points</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">MadaclimPoint</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">MadaclimPoint</span><span class="p">]]]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instantiate a collection of MadaclimPoint objects. By default, the MadaclimCollection is empty.</span>
<span class="sd">        It will populate the collection with a single instance or a list of MadaclimPoint instances by calling the add_points method with the given madaclim_points.</span>

<span class="sd">        Args:</span>
<span class="sd">            madaclim_points (Optional[Union[MadaclimPoint, List[MadaclimPoint]]], optional): A single MadaclimPoint object or a list of MadaclimPoint objects to be added to the MadaclimCollection. Initialize an empty MadaclimCollection by default (None).</span>
<span class="sd">        Examples:</span>
<span class="sd">            Multiple construction approaches</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; from py_madaclim.raster_manipulation import MadaclimPoint, MadaclimCollection</span>
<span class="sd">            &gt;&gt;&gt; specimen_1 = MadaclimPoint(specimen_id=&quot;spe1&quot;, latitude=-23.574583, longitude=46.419806, source_crs=&quot;epsg:4326&quot;)</span>
<span class="sd">            &gt;&gt;&gt; specimen_2 = MadaclimPoint(specimen_id=&quot;spe2&quot;, latitude=-2622095.832726487, longitude=5048512.906023483, source_crs=3857)</span>
<span class="sd">            &gt;&gt;&gt; collection = MadaclimCollection([specimen_1, specimen_2])</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; # Init from empty collection</span>
<span class="sd">            &gt;&gt;&gt; collection = MadaclimCollection()</span>
<span class="sd">            &gt;&gt;&gt; collection</span>
<span class="sd">            No MadaclimPoint inside the collection.</span>
<span class="sd">            &gt;&gt;&gt; collection.add_points(specimen_1)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">madaclim_points</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_points</span><span class="p">(</span><span class="n">madaclim_points</span><span class="p">)</span>
        
        <span class="c1"># Sampled states and values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nodata_layers</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Rasters updated post-sampling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__clim_raster</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__env_raster</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Categ encoding state and vals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_categorical_encoded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoded_categ_layers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoded_categ_labels</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># GeoDataframe construction and updating</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_geodataframe</span><span class="p">()</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_points</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the `all_points` attribute.</span>

<span class="sd">        Corresponds to a list of each object in the collection.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of all the MadaclimPoint objects in the MadaclimCollection.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; # MadaclimPoints are stored in the .all_points attributes in a list</span>
<span class="sd">            &gt;&gt;&gt; collection.all_points[0]</span>
<span class="sd">            MadaclimPoint(</span>
<span class="sd">                specimen_id = sample_A,</span>
<span class="sd">                source_crs = 4326,</span>
<span class="sd">                latitude = -18.9333,</span>
<span class="sd">                longitude = 48.2,</span>
<span class="sd">                mada_geom_point = POINT (837072.9150244407 7903496.320897499),</span>
<span class="sd">                sampled_layers = None,</span>
<span class="sd">                nodata_layers = None</span>
<span class="sd">            )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sampled_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the sampled_layers attribute of the collection generated from the `sampled_from_rasters` method.</span>

<span class="sd">        This attribute is a nested dictionary. The outer dictionary uses the MadaclimPoint.specimen_id as keys. </span>
<span class="sd">        The corresponding value for each key is another dictionary, which uses layer_names as keys and sampled values from rasters as values.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[Dict[str, Dict[str, int]]]: A dictionary with MadaclimPoint.specimen_id as keys and a dictionary of layer_names (str) and sampled values (int) as values.</span>
<span class="sd">                None if Collection has not been sampled yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nodata_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the nodata_layers attribute of the collection generated from the `sampled_from_rasters` method.</span>

<span class="sd">        This attribute is a dictionary that contains the MadaclimPoint.specimen_id as keys and the values as the &#39;nodata_layers&#39; as str or list of str.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Optional[Dict[str, Union[str, List[str]]]]: A dictionary with MadaclimPoint.specimen_id as keys and values of str or list of str of the layers_name with nodata values.</span>
<span class="sd">                None if Collection has not been sampled yet or all layers sampled contained valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodata_layers</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_categorical_encoded</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the state of the binary encoding of the categorical layers of the collection.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: The state of the `binary_encode_categorical` method. If True, the method has been called </span>
<span class="sd">                and a new set of binary features has been generated for the whole collection.</span>
<span class="sd">                Otherwise, either the layers have not been sampled or the categorical features havenot been encoded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_categorical_encoded</span> 
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">encoded_categ_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the binary encoded categorical layers values.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[Dict[str, int]]: A nested dictionary containing the set of binary encoded categorical features.</span>
<span class="sd">                The outer dictionary uses the MadaclimPoint.specimen_id as keys. </span>
<span class="sd">                The corresponding value for each key is another dictionary where the keys are layer number</span>
<span class="sd">                (or a more descriptive label) with the categorical feature.</span>
<span class="sd">                Values correspond to the binary encoded value for that given category</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encoded_categ_layers</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">encoded_categ_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the labels from the binary encoded categorical layers for the whole collection.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[List[str]]: A list containing the set of the labels from the binary encoding </span>
<span class="sd">                of categorical features from the whole collection.</span>
<span class="sd">                None if the categorical layers have not been encoded yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encoded_categ_labels</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">gdf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the GeoPandas DataFrame of the collection (concat of all points&#39; gdfs).</span>

<span class="sd">        Returns:</span>
<span class="sd">            gpd.GeoDataFrame: A Geopandas GeoDataFrame generated from instance attributes and Point geometry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_gdf</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gdf</span>
    
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;No MadaclimPoint inside the collection.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_points_short</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">:</span>
                <span class="n">point_info</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;MadaclimPoint(specimen_id=</span><span class="si">{</span><span class="n">point</span><span class="o">.</span><span class="n">specimen_id</span><span class="si">}</span><span class="s2">, lat=</span><span class="si">{</span><span class="n">point</span><span class="o">.</span><span class="n">latitude</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, lon=</span><span class="si">{</span><span class="n">point</span><span class="o">.</span><span class="n">longitude</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;sampled_layers=</span><span class="si">{</span><span class="kc">True</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">point</span><span class="o">.</span><span class="n">sampled_layers</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">False</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;categ_encoded=</span><span class="si">{</span><span class="n">point</span><span class="o">.</span><span class="n">is_categorical_encoded</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
                <span class="n">all_points_short</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point_info</span><span class="p">)</span>

            <span class="k">return</span> <span class="s2">&quot;MadaclimCollection = [</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;,</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">all_points_short</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">]&quot;</span>
        
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>
    
    <span class="c1"># def __setattr__(self, name, value):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Overrides the __setattr__ method to update GeoDataFrame when attributes are set.</span>

    <span class="c1">#     This method overrides the standard `__setattr__` method. When an attribute </span>
    <span class="c1">#     is set on the instance, it checks if it&#39;s a new attribute (not one of </span>
    <span class="c1">#     the instance&#39;s initial attributes). If it&#39;s new, the GeoDataFrame </span>
    <span class="c1">#     (represented by the `_gdf` attribute) is updated to reflect the new attribute. </span>

    <span class="c1">#     Args:</span>
    <span class="c1">#         name (str): The name of the attribute being set.</span>
    <span class="c1">#         value (Any): The value being assigned to the attribute.</span>

    <span class="c1">#     Raises:</span>
    <span class="c1">#         AttributeError: If the attribute being set is &#39;_initial_attributes&#39;, </span>
    <span class="c1">#             as this attribute is meant to remain constant after object creation.</span>

    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     super().__setattr__(name, value)  # Call the parent class&#39;s __setattr__ first</span>
    <span class="c1">#     if hasattr(self, &quot;_MadaclimCollection__initial_attributes&quot;) and name != &quot;_gdf&quot;:</span>
    <span class="c1">#         # Update the `gdf` attribute with the newly added attribute</span>
    <span class="c1">#         self._update_gdf()</span>


<div class="viewcode-block" id="MadaclimCollection.populate_from_csv"><a class="viewcode-back" href="../../py_madaclim.html#py_madaclim.raster_manipulation.MadaclimCollection.populate_from_csv">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">populate_from_csv</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">csv_file</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;MadaclimCollection&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a new MadaclimCollection from a CSV file.</span>
<span class="sd">        </span>
<span class="sd">        Each row of the CSV file should represent a MadaclimPoint. The CSV file</span>
<span class="sd">        must have columns that correspond to the arguments of the MadaclimPoint</span>
<span class="sd">        constructor. If a &#39;source_crs&#39; column is not provided, the method uses</span>
<span class="sd">        the default CRS value.</span>

<span class="sd">        Args:</span>
<span class="sd">            csv_file (Union[str, pathlib.Path]): The path to the CSV file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            MadaclimCollection: A new MadaclimCollection instance with MadaclimPoint</span>
<span class="sd">            objects created from the rows of the CSV file.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If &#39;csv_file&#39; is not a str or pathlib.Path object.</span>
<span class="sd">            FileNotFoundError: If the file specified by &#39;csv_file&#39; does not exist.</span>
<span class="sd">            ValueError: If the CSV file headers are missing required arguments for</span>
<span class="sd">            constructing MadaclimPoint objects.</span>
<span class="sd">        Examples:</span>
<span class="sd">            CSV requirements for construction</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; # header must contain req. positional args for MadaclimPoint</span>
<span class="sd">            &gt;&gt;&gt; # When no source_crs header is found, defaults to EPSG:4326</span>
<span class="sd">            specimen_id,latitude,longitude</span>
<span class="sd">            sample_A,-18.9333,48.2</span>
<span class="sd">            sample_B,-16.295741,46.826763</span>
<span class="sd">            sample_C,-21.223,47.5204</span>
<span class="sd">            sample_D,-17.9869,49.2966</span>
<span class="sd">            sample_E,-21.5166,47.4833</span>

<span class="sd">            &gt;&gt;&gt; collection = MadaclimCollection.populate_from_csv(&quot;some_samples.csv&quot;)</span>
<span class="sd">            Warning! No source_crs column in the csv. Using the default value of EPSG:4326...</span>
<span class="sd">            Created new MadaclimCollection with 5 samples.</span>

<span class="sd">            &gt;&gt;&gt; # Can accept other non-required data for MadaclimPoint instantiation</span>
<span class="sd">            specimen_id,latitude,longitude,source_crs,has_sequencing,specie</span>
<span class="sd">            sample_F,-19.9333,47.2,4326,True,bojeri</span>
<span class="sd">            sample_G,-18.295741,45.826763,4326,False,periwinkle</span>
<span class="sd">            sample_H,-21.223,44.5204,4326,False,spectabilis</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; other_collection = MadaclimCollection.populate_from_csv(&quot;other_samples.csv&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Convert str to pathlib.Path</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">csv_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>
        
        <span class="c1"># Type and IO validation</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;csv_file&#39; must be a valid pathlib.Path object.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">csv_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find </span><span class="si">{</span><span class="n">csv_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Get the required + default args to use to construct the MadaclimPoint objects</span>
        <span class="n">madapoint_required_args</span><span class="p">,</span> <span class="n">madapoint_default_crs_arg</span> <span class="o">=</span> <span class="n">MadaclimPoint</span><span class="o">.</span><span class="n">get_args_names</span><span class="p">()</span>
        <span class="n">madapoint_default_crs_val</span> <span class="o">=</span> <span class="n">MadaclimPoint</span><span class="o">.</span><span class="n">get_default_source_crs</span><span class="p">()</span>

        <span class="c1"># Populate the collection from the input csv</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">csv_data</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            
            <span class="c1"># Check if all required_args in csv</span>
            <span class="n">col_names</span> <span class="o">=</span> <span class="n">csv_data</span><span class="o">.</span><span class="n">fieldnames</span>
            <span class="n">missing_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">req_arg</span> <span class="k">for</span> <span class="n">req_arg</span> <span class="ow">in</span> <span class="n">madapoint_required_args</span> <span class="k">if</span> <span class="n">req_arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col_names</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;csv file headers are missing the following required args to construct the MadaclimPoint objects:</span><span class="se">\n</span><span class="si">{</span><span class="n">missing_args</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Warn for default EPSG if not provided</span>
            <span class="k">if</span> <span class="n">madapoint_default_crs_arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col_names</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning! No </span><span class="si">{</span><span class="n">madapoint_default_crs_arg</span><span class="si">}</span><span class="s2"> column in the csv. Using the default value of EPSG:</span><span class="si">{</span><span class="n">madapoint_default_crs_val</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

            <span class="c1"># Replace incompatible attribute names</span>
            <span class="n">sanitized_col_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">MadaclimCollection</span><span class="o">.</span><span class="n">sanitize_attr_name</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">col_names</span><span class="p">]</span>
            <span class="n">csv_data</span><span class="o">.</span><span class="n">fieldnames</span> <span class="o">=</span> <span class="n">sanitized_col_names</span>


            <span class="c1"># Contruct points with all req+opt attributes from sanitized headers</span>
            <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_data</span><span class="p">:</span>
                                
                <span class="c1"># If source_crs not in row use default val</span>
                <span class="k">if</span> <span class="n">madapoint_default_crs_arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">row</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="n">madapoint_default_crs_arg</span><span class="p">]:</span>
                    <span class="n">row</span><span class="p">[</span><span class="n">madapoint_default_crs_arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">madapoint_default_crs_val</span>

                <span class="c1"># Create a MadaclimPoint using the values of the row</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating MadaclimPoint(specimen_id=</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;specimen_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">...)&quot;</span><span class="p">)</span>
                <span class="n">point</span> <span class="o">=</span> <span class="n">MadaclimPoint</span><span class="p">(</span><span class="o">**</span><span class="n">row</span><span class="p">)</span>
                <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
        
        <span class="n">new_collection</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created new MadaclimCollection with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_collection</span></div>
    
<div class="viewcode-block" id="MadaclimCollection.populate_from_df"><a class="viewcode-back" href="../../py_madaclim.html#py_madaclim.raster_manipulation.MadaclimCollection.populate_from_df">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">populate_from_df</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MadaclimCollection&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class method to populate a MadaclimCollection from a pandas DataFrame.</span>

<span class="sd">        This method takes a DataFrame where each row represents a MadaclimPoint and its </span>
<span class="sd">        attributes. If the &#39;source_crs&#39; column is not provided in the DataFrame, the default </span>
<span class="sd">        CRS will be used. </span>

<span class="sd">        Args:</span>
<span class="sd">            df (pd.DataFrame): DataFrame where each row represents a MadaclimPoint. Expected</span>
<span class="sd">                            columns are the same as the required arguments for the </span>
<span class="sd">                            MadaclimPoint constructor.</span>

<span class="sd">        Returns:</span>
<span class="sd">            MadaclimCollection: A new MadaclimCollection instance populated with MadaclimPoints</span>
<span class="sd">                                created from the DataFrame.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If &#39;df&#39; is not a pd.DataFrame.</span>
<span class="sd">            ValueError: If the DataFrame is missing any of the required arguments to construct </span>
<span class="sd">                        a MadaclimPoint.</span>
<span class="sd">        Example:</span>
<span class="sd">            Respect requirements for MadaclimPoint construction in df columns</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; import pandas as pd</span>
<span class="sd">            &gt;&gt;&gt; sample_df</span>
<span class="sd">            specimen_id    latitude  longitude</span>
<span class="sd">            0    sample_W  -16.295741  46.826763</span>
<span class="sd">            1    sample_X    -17.9869    49.2966</span>
<span class="sd">            2    sample_Y    -18.9333    48.2166</span>
<span class="sd">            3    sample_Z      -13.28      49.95</span>

<span class="sd">            &gt;&gt;&gt; collection = MadaclimCollection.populate_from_df(sample_df)</span>
<span class="sd">            Warning! No source_crs column in the df. Using the default value of EPSG:4326...</span>
<span class="sd">            Creating MadaclimPoint(specimen_id=sample_W...)</span>
<span class="sd">            Creating MadaclimPoint(specimen_id=sample_X...)</span>
<span class="sd">            Creating MadaclimPoint(specimen_id=sample_Y...)</span>
<span class="sd">            Creating MadaclimPoint(specimen_id=sample_Z...)</span>
<span class="sd">            Created new MadaclimCollection with 4 samples.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_copy</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df_copy</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;df&#39; is not a pd.DataFrame.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Get the required + default args to use to construct the MadaclimPoint objects</span>
        <span class="n">madapoint_required_args</span><span class="p">,</span> <span class="n">madapoint_default_crs_arg</span> <span class="o">=</span> <span class="n">MadaclimPoint</span><span class="o">.</span><span class="n">get_args_names</span><span class="p">()</span>
        <span class="n">madapoint_default_crs_val</span> <span class="o">=</span> <span class="n">MadaclimPoint</span><span class="o">.</span><span class="n">get_default_source_crs</span><span class="p">()</span>

        <span class="c1"># Check for required args present in df</span>
        <span class="n">missing_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">req_arg</span> <span class="k">for</span> <span class="n">req_arg</span> <span class="ow">in</span> <span class="n">madapoint_required_args</span> <span class="k">if</span> <span class="n">req_arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_copy</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df is missing the following required args to construct the MadaclimPoint objects:</span><span class="se">\n</span><span class="si">{</span><span class="n">missing_args</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Warn for default EPSG if not provided</span>
        <span class="k">if</span> <span class="n">madapoint_default_crs_arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_copy</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning! No </span><span class="si">{</span><span class="n">madapoint_default_crs_arg</span><span class="si">}</span><span class="s2"> column in the df. Using the default value of EPSG:</span><span class="si">{</span><span class="n">madapoint_default_crs_val</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

        <span class="c1"># Sanitize col names for attrs + construct points to add to collection</span>
        <span class="n">df_copy</span> <span class="o">=</span> <span class="n">df_copy</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">MadaclimCollection</span><span class="o">.</span><span class="n">sanitize_attr_name</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_copy</span><span class="o">.</span><span class="n">columns</span><span class="p">})</span>
        <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_copy</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="c1"># If source_crs not in row use default val</span>
            <span class="k">if</span> <span class="n">madapoint_default_crs_arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">row</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="n">madapoint_default_crs_arg</span><span class="p">]:</span>
                <span class="n">row</span><span class="p">[</span><span class="n">madapoint_default_crs_arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">madapoint_default_crs_val</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating MadaclimPoint(specimen_id=</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;specimen_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">...)&quot;</span><span class="p">)</span>
            <span class="n">point</span> <span class="o">=</span> <span class="n">MadaclimPoint</span><span class="p">(</span><span class="o">**</span><span class="n">row</span><span class="p">)</span>
            <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
        
        <span class="n">new_collection</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created new MadaclimCollection with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_collection</span></div>
    
<div class="viewcode-block" id="MadaclimCollection.sanitize_attr_name"><a class="viewcode-back" href="../../py_madaclim.html#py_madaclim.raster_manipulation.MadaclimCollection.sanitize_attr_name">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">sanitize_attr_name</span><span class="p">(</span><span class="n">attribute</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Strips incompatible char from attribute names</span>

<span class="sd">            Args:</span>
<span class="sd">                attribute (str): The attribute header from the csv file</span>

<span class="sd">            Returns:</span>
<span class="sd">                str: The compatible attribute name.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">attribute</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MadaclimCollection.add_points"><a class="viewcode-back" href="../../py_madaclim.html#py_madaclim.raster_manipulation.MadaclimCollection.add_points">[docs]</a>    <span class="k">def</span> <span class="nf">add_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">madaclim_points</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">MadaclimPoint</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">MadaclimPoint</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds one or more MadaclimPoint objects to the MadaclimCollection.</span>

<span class="sd">        Args:</span>
<span class="sd">            madaclim_points (Union[MadaclimPoint, List[MadaclimPoint]]): A single MadaclimPoint object or a list of MadaclimPoint objects to be added to the MadaclimCollection.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the input is not a MadaclimPoint object or a list of MadaclimPoint objects.</span>
<span class="sd">            ValueError: If the input MadaclimPoint(s) is/are already in the MadaclimCollection or if their specimen_id(s) are not unique.</span>
<span class="sd">        Examples:</span>
<span class="sd">            Add a single point</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; from py_madaclim.geoclim.raster_manipulation import MadaclimPoint, MadaclimCollection</span>

<span class="sd">            &gt;&gt;&gt; specimen_1 = MadaclimPoint(specimen_id=&quot;spe1&quot;, latitude=-23.574583, longitude=46.419806, source_crs=&quot;epsg:4326&quot;)</span>
<span class="sd">            &gt;&gt;&gt; collection = MadaclimCollection()</span>
<span class="sd">            &gt;&gt;&gt; collection</span>
<span class="sd">            No MadaclimPoint inside the collection.</span>

<span class="sd">            &gt;&gt;&gt; collection.add_points(specimen_1)</span>
<span class="sd">            &gt;&gt;&gt; collection</span>
<span class="sd">            MadaclimCollection = [</span>
<span class="sd">                MadaclimPoint(specimen_id=spe1, mada_geom_point=POINT (644890.8921103649 7392153.658976035), sampled=False)</span>
<span class="sd">            ]</span>

<span class="sd">            Add multiple points</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; specimen_2 = MadaclimPoint(specimen_id=&quot;spe2&quot;, latitude=-20.138470, longitude=46.054688, family=&quot;Rubiaceae&quot;, has_sequencing=True, num_samples=1)            </span>
<span class="sd">            &gt;&gt;&gt; other_collection.add_points([specimen_1, specimen_2])</span>
<span class="sd">            &gt;&gt;&gt; print(other_collection)</span>
<span class="sd">            MadaclimCollection = [</span>
<span class="sd">                MadaclimPoint(specimen_id=spe1, mada_geom_point=POINT (644890.8921103649 7392153.658976035), sampled=False),</span>
<span class="sd">                MadaclimPoint(specimen_id=spe2, mada_geom_point=POINT (610233.867750987 7772846.143786541), sampled=False)</span>
<span class="sd">            ]</span>

<span class="sd">            No duplicates allowed</span>
<span class="sd">            &gt;&gt;&gt; other_collection.add_points(specimen_1)</span>
<span class="sd">            Traceback (most recent call last):</span>
<span class="sd">            File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span>
<span class="sd">            File &quot;.../src/py_madaclim/geoclim/raster_manipulation.py&quot;, line 1013, in add_points</span>
<span class="sd">                MadaclimPoint(specimen_id=spe2, mada_geom_point=POINT (610233.867750987 7772846.143786541))</span>
<span class="sd">                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
<span class="sd">            ValueError: MadaclimPoint(</span>
<span class="sd">                specimen_id = spe1,</span>
<span class="sd">                source_crs = 4326,</span>
<span class="sd">                latitude = -23.574583,</span>
<span class="sd">                longitude = 46.419806,</span>
<span class="sd">                mada_geom_point = POINT (644890.8921103649 7392153.658976035),</span>
<span class="sd">                sampled_layers = None,</span>
<span class="sd">                nodata_layers = None</span>
<span class="sd">            ) is already in the current MadaclimCollection instance.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Add multiple MadaclimPoint objects</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">madaclim_points</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">madaclim_points</span><span class="p">:</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">MadaclimPoint</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">point</span><span class="si">}</span><span class="s2"> is not a MadaclimPoint object. Accepted types are a single MadaclimPoint and a list of MadaclimPoint objects.&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">point</span><span class="si">}</span><span class="s2"> is already in the current MadaclimCollection instance.&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">specimen_id</span> <span class="ow">in</span> <span class="p">[</span><span class="n">mada_pt</span><span class="o">.</span><span class="n">specimen_id</span> <span class="k">for</span> <span class="n">mada_pt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">]:</span>    <span class="c1"># specimen_id unique id validation</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;specimen_id=</span><span class="si">{</span><span class="n">point</span><span class="o">.</span><span class="n">specimen_id</span><span class="si">}</span><span class="s2"> already exists inside current MadaclimCollection. Every MadaclimPoint must have a unique id.&quot;</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Add single MadaclimPoint object</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">madaclim_points</span><span class="p">,</span> <span class="n">MadaclimPoint</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The madaclim_point to add is not a MadaclimPoint object.&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">madaclim_points</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">madaclim_points</span><span class="si">}</span><span class="s2"> is already in the current MadaclimCollection instance.&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">madaclim_points</span><span class="o">.</span><span class="n">specimen_id</span> <span class="ow">in</span> <span class="p">[</span><span class="n">mada_pt</span><span class="o">.</span><span class="n">specimen_id</span> <span class="k">for</span> <span class="n">mada_pt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">]:</span>    <span class="c1"># specimen_id unique id validation</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;specimen_id=</span><span class="si">{</span><span class="n">madaclim_points</span><span class="o">.</span><span class="n">specimen_id</span><span class="si">}</span><span class="s2"> already exists inside current MadaclimCollection. Every MadaclimPoint must have a unique id.&quot;</span><span class="p">)</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">madaclim_points</span><span class="p">)</span>
        <span class="c1"># Update collection gdf after point addition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_gdf</span><span class="p">()</span></div>

<div class="viewcode-block" id="MadaclimCollection.remove_points"><a class="viewcode-back" href="../../py_madaclim.html#py_madaclim.raster_manipulation.MadaclimCollection.remove_points">[docs]</a>    <span class="k">def</span> <span class="nf">remove_points</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> 
            <span class="n">madaclim_points</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">MadaclimPoint</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">MadaclimPoint</span><span class="p">]]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">indices</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">clear</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes MadaclimPoint objects from the MadaclimCollection based on specified criteria.</span>

<span class="sd">        This method allows removing MadaclimPoint objects from the collection by providing either</span>
<span class="sd">        MadaclimPoint instance(s), index/indices, or by clearing the whole collection.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            madaclim_points (Optional[Union[MadaclimPoint, List[MadaclimPoint]]], optional): A single MadaclimPoint</span>
<span class="sd">                object or a list of MadaclimPoint objects to be removed from the collection. Defaults to None.</span>
<span class="sd">            indices (Optional[Union[int, List[int]]], optional): A single index or a list of indices of the MadaclimPoint</span>
<span class="sd">                objects to be removed from the collection. Defaults to None.</span>
<span class="sd">            clear (bool, optional): If set to True, removes all MadaclimPoint objects from the collection. When using</span>
<span class="sd">                this option, &#39;madaclim_points&#39; and &#39;indices&#39; must not be provided. Defaults to False.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the MadaclimCollection is empty or if none of the input options are provided.</span>
<span class="sd">            ValueError: If &#39;madaclim_points&#39; and &#39;indices&#39; are both provided.</span>
<span class="sd">            ValueError: If &#39;clear&#39; is set to True and either &#39;madaclim_points&#39; or &#39;indices&#39; are provided.</span>
<span class="sd">            TypeError: If an invalid type is provided for &#39;madaclim_points&#39; or &#39;indices&#39;.</span>
<span class="sd">            ValueError: If a provided MadaclimPoint object is not in the collection or if an index is out of bounds.</span>
<span class="sd">            IndexError: If an index is out of range.</span>

<span class="sd">        Examples:</span>

<span class="sd">            Remove points by passing in the &#39;MadaclimPoint&#39; instances, the index or the &#39;specimen_id&#39;</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; sample_W = collection.all_points[0]</span>
<span class="sd">            &gt;&gt;&gt; collection.remove_points(madaclim_points=sample_W)</span>

<span class="sd">            &gt;&gt;&gt; # Using the position index of the instance</span>
<span class="sd">            &gt;&gt;&gt; collection.remove_points(indices=-1)    # Removes last point of the collection</span>

<span class="sd">            &gt;&gt;&gt; # Using the specimen.id attribute</span>
<span class="sd">            &gt;&gt;&gt; collection.remove_points(madaclim_points=&quot;sample_Y&quot;)</span>

<span class="sd">            Remove multiple points</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; # A list of str or MadaclimPoint or mixed types are accepted for the madaclim_points argument.</span>
<span class="sd">            &gt;&gt;&gt; sample_w = collection.all_points[0]</span>
<span class="sd">            &gt;&gt;&gt; to_remove = [sample_w, &quot;sample_X&quot;]</span>
<span class="sd">            &gt;&gt;&gt; collection.remove_points(madaclim_points=to_remove)</span>

<span class="sd">            &gt;&gt;&gt; # Or pass in a list of indices to the indices argument.</span>
<span class="sd">            &gt;&gt;&gt; collection.remove_points(indices=[0, -1])    # Remove first and last point</span>

<span class="sd">            &gt;&gt;&gt; # Finaly we can clear the collection of all instances.</span>
<span class="sd">            &gt;&gt;&gt; collection.remove_points(clear=True)</span>
<span class="sd">            No MadaclimPoint inside the collection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Handle empty MadaclimCollection</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No points to delete since the MadaclimCollection is empty.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Drop all points</span>
        <span class="k">if</span> <span class="n">clear</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">madaclim_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;When using &#39;clear&#39;, do not provide &#39;madaclim_points&#39; or &#39;indices&#39;.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_gdf</span><span class="p">()</span>    <span class="c1"># Return string when empty points</span>
                <span class="k">return</span>
        <span class="k">if</span> <span class="n">madaclim_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either provide &#39;madaclim_points&#39; or &#39;indices&#39;, not both.&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">madaclim_points</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;At least one of madaclim_points or indices must be provided.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Remove single/multiple points by MadaclimPoint instance(s)</span>
        <span class="k">if</span> <span class="n">madaclim_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Containers for objects (MadaclimPoint) or specimen_id (str) to remove</span>
            <span class="n">madaclim_points_objects</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">madaclim_points_ids</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="c1"># Multiple objects removal (list arg)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">madaclim_points</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">point_to_rm</span> <span class="ow">in</span> <span class="n">madaclim_points</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_to_rm</span><span class="p">,</span> <span class="p">(</span><span class="n">MadaclimPoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">point_to_rm</span><span class="si">}</span><span class="s2"> is not a MadaclimPoint object or str. Accepted types are a single MadaclimPoint, a str, a list of MadaclimPoint objects or a list of str.&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_to_rm</span><span class="p">,</span> <span class="n">MadaclimPoint</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">point_to_rm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">point_to_rm</span><span class="si">}</span><span class="s2"> does not exists in the current MadaclimCollection instance.&quot;</span><span class="p">)</span>
                        <span class="n">madaclim_points_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point_to_rm</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">point_to_rm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">point</span><span class="o">.</span><span class="n">specimen_id</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">]:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">point_to_rm</span><span class="si">}</span><span class="s2"> is not a valid MadaclimPoint.specimen_id for all points of the collection.&quot;</span><span class="p">)</span>
                        <span class="n">madaclim_points_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point_to_rm</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">point</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span> <span class="k">if</span> <span class="n">point</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">madaclim_points_objects</span> <span class="ow">and</span> <span class="n">point</span><span class="o">.</span><span class="n">specimen_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">madaclim_points_ids</span><span class="p">]</span>

            <span class="c1"># Single object removal</span>
            <span class="k">else</span><span class="p">:</span>    
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">madaclim_points</span><span class="p">,</span> <span class="p">(</span><span class="n">MadaclimPoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">madaclim_points</span><span class="si">}</span><span class="s2"> is not a MadaclimPoint object or str. Accepted types are a single MadaclimPoint, a str, a list of MadaclimPoint objects or a list of str.&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">madaclim_points</span><span class="p">,</span> <span class="n">MadaclimPoint</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">madaclim_points</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">madaclim_points</span><span class="si">}</span><span class="s2"> does not exists in the current MadaclimCollection instance.&quot;</span><span class="p">)</span>
                    <span class="n">madaclim_points_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">madaclim_points</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">madaclim_points</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">point</span><span class="o">.</span><span class="n">specimen_id</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">]:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">madaclim_points</span><span class="si">}</span><span class="s2"> is not a valid MadaclimPoint.specimen_id for all points of the collection.&quot;</span><span class="p">)</span>
                    <span class="n">madaclim_points_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">madaclim_points</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">point</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span> <span class="k">if</span> <span class="n">point</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">madaclim_points_objects</span> <span class="ow">and</span> <span class="n">point</span><span class="o">.</span><span class="n">specimen_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">madaclim_points_ids</span><span class="p">]</span>

        
        
        <span class="c1"># Remove multiple points from an indices list</span>
        <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Indices should be integers.&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> is out of bounds.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">point</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>    <span class="c1"># Remove single point</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="k">if</span> <span class="n">indices</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Single index must be an integer.&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Index out of range.&quot;</span><span class="p">)</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_gdf</span><span class="p">()</span>    <span class="c1"># Update collection geodataframe with removed points</span></div>


<div class="viewcode-block" id="MadaclimCollection.sample_from_rasters"><a class="viewcode-back" href="../../py_madaclim.html#py_madaclim.raster_manipulation.MadaclimCollection.sample_from_rasters">[docs]</a>    <span class="k">def</span> <span class="nf">sample_from_rasters</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">clim_raster</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span> 
            <span class="n">env_raster</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span>
            <span class="n">layers_to_sample</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> 
            <span class="n">layer_info</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Samples geoclimatic data from raster files for specified layers at the location </span>
<span class="sd">        of each point belonging to the MadaclimCollection&#39;s instance.</span>

<span class="sd">        Calling this method will also update the `sampled_layers` attributes with the data</span>
<span class="sd">        extracted from the layers_to_sample for every point in the collection. </span>
<span class="sd">        If sampled data containing &#39;nodata&#39; values, the `nodata_layers` attribute </span>
<span class="sd">        will be updated with the name of the layers accordingly.</span>
<span class="sd">        Also, the `gdf` attribute GeoDataFrame will be updated with the `sampled_layers`.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            clim_raster_path (pathlib.Path): Path to the climate raster file.</span>
<span class="sd">            env_raster_path (pathlib.Path): Path to the environment raster file.</span>
<span class="sd">            layers_to_sample (Union[int, str, List[Union[int, str]]], optional): The layer number(s) to sample from the raster files.</span>
<span class="sd">                Can be a single int, a single string in the format &#39;layer_&lt;num&gt;&#39;, or a list of ints or such strings. Defaults to &#39;all&#39;.</span>
<span class="sd">            layer_info (bool, optional): Whether to use descriptive labels for the returned dictionary keys. Defaults to False.</span>
<span class="sd">            </span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">            </span>
<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the MadaclimCollection doesn&#39;t contain any MadaclimPoints.</span>

<span class="sd">        Notes:</span>
<span class="sd">            This method also updates the &#39;sampled_layers&#39; and &#39;nodata_layers&#39; attributes of the MadaclimCollection instance.</span>

<span class="sd">        Examples:</span>
<span class="sd">            Sample the value for each point in the collection according to their location</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; from py_madaclim.geoclim.raster_manipulation import MadaclimPoint, MadaclimCollection</span>
<span class="sd">            &gt;&gt;&gt; specimen_1 = MadaclimPoint(specimen_id=&quot;spe1_aren&quot;, latitude=-18.9333, longitude=48.2, genus=&quot;Coffea&quot;, species=&quot;arenesiana&quot;, has_sequencing=True)</span>
<span class="sd">            &gt;&gt;&gt; specimen_2 = MadaclimPoint(specimen_id=&quot;spe2_humb&quot;, latitude=-12.716667, longitude=45.066667, source_crs=4326, genus=&quot;Coffea&quot;, species=&quot;humblotiana&quot;, has_sequencing=True)</span>
<span class="sd">            &gt;&gt;&gt; collection = MadaclimCollection()</span>
<span class="sd">            &gt;&gt;&gt; collection.add_points([specimen_1, specimen_2])</span>

<span class="sd">            &gt;&gt;&gt; from py_madaclim.info import MadaclimLayers</span>
<span class="sd">            &gt;&gt;&gt; madaclim_info = MadaclimLayers()</span>
<span class="sd">            &gt;&gt;&gt; bioclim_labels = [label for label in madaclim_info.get_layers_labels(as_descriptive_labels=True) if &quot;bio&quot; in label]</span>

<span class="sd">            &gt;&gt;&gt; # Validating the rasters</span>
<span class="sd">            mada_rasters = MadaclimRasters(clim_raster=&quot;madaclim_current.tif&quot;, env_raster=&quot;madaclim_enviro.tif&quot;)</span>
<span class="sd">            &gt;&gt;&gt; collection.sample_from_rasters(</span>
<span class="sd">                    mada_rasters.clim_raster, </span>
<span class="sd">                    mada_rasters.env_raster,</span>
<span class="sd">                    layers_to_sample=bioclim_labels</span>
<span class="sd">                )</span>

<span class="sd">            Attribute state updating</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; collection    # sampled status updated</span>
<span class="sd">            MadaclimCollection = [</span>
<span class="sd">                    MadaclimPoint(specimen_id=spe1_aren, mada_geom_point=POINT (837072.9150244407 7903496.320897499),sampled=True),</span>
<span class="sd">                    MadaclimPoint(specimen_id=spe2_humb, mada_geom_point=POINT (507237.57495924993 8594195.741515966),sampled=True)</span>
<span class="sd">            ]</span>
<span class="sd">            &gt;&gt;&gt; # Results also stored in the `sampled_layers` attribute</span>
<span class="sd">            &gt;&gt;&gt; collection.sampled_layers[&quot;spe2_humb&quot;][&quot;layer_55&quot;]</span>
<span class="sd">            66</span>

<span class="sd">            &gt;&gt;&gt; # layers_to_sample also accepts a single layer, or multiple layers as the output from the `get_layers_labels` method in MadaclimLayers</span>
<span class="sd">            &gt;&gt;&gt; collection.sample_from_rasters(37)</span>
<span class="sd">            {&#39;spe1_aren&#39;: {&#39;layer_37&#39;: 196}, &#39;spe2_humb&#39;: {&#39;layer_37&#39;: 238}}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Reset raster properties before sampling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__MadaclimCollection_clim_raster</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__MadaclimCollection_env_raster</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No MadaclimPoint to sample from in the Collection.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Use MadaclimRasters built-in validation for raster files</span>
        <span class="n">mada_rasters</span> <span class="o">=</span> <span class="n">MadaclimRasters</span><span class="p">(</span><span class="n">clim_raster</span><span class="o">=</span><span class="n">clim_raster</span><span class="p">,</span> <span class="n">env_raster</span><span class="o">=</span><span class="n">env_raster</span><span class="p">)</span>

        <span class="c1"># Sample rasters for whole collection</span>
        <span class="n">sampled_layers</span><span class="p">,</span> <span class="n">nodata_layers</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">:</span>
            <span class="n">point</span><span class="o">.</span><span class="n">sample_from_rasters</span><span class="p">(</span>
                <span class="n">clim_raster</span><span class="o">=</span><span class="n">mada_rasters</span><span class="o">.</span><span class="n">clim_raster</span><span class="p">,</span>
                <span class="n">env_raster</span><span class="o">=</span><span class="n">mada_rasters</span><span class="o">.</span><span class="n">env_raster</span><span class="p">,</span>
                <span class="n">layers_to_sample</span><span class="o">=</span><span class="n">layers_to_sample</span><span class="p">,</span>
                <span class="n">layer_info</span><span class="o">=</span><span class="n">layer_info</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Save sampled raster data (nested dicts)</span>
            <span class="n">sampled_layers</span><span class="p">[</span><span class="n">point</span><span class="o">.</span><span class="n">specimen_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">sampled_layers</span>

            <span class="c1"># Save layers name only when val is nodata</span>
            <span class="n">nodata_layers</span><span class="p">[</span><span class="n">point</span><span class="o">.</span><span class="n">specimen_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">nodata_layers</span> <span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">nodata_layers</span> <span class="k">else</span> <span class="kc">None</span>
                
        <span class="c1"># Reset categorical encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_categorical_encoded</span> <span class="o">=</span> <span class="kc">False</span>    
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoded_categ_layers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoded_categ_labels</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Update instance attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span> <span class="o">=</span> <span class="n">sampled_layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nodata_layers</span> <span class="o">=</span> <span class="n">nodata_layers</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodata_layers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_MadaclimCollection__clim_raster</span> <span class="o">=</span> <span class="n">mada_rasters</span><span class="o">.</span><span class="n">clim_raster</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_MadaclimCollection__env_raster</span> <span class="o">=</span> <span class="n">mada_rasters</span><span class="o">.</span><span class="n">env_raster</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_gdf</span><span class="p">()</span></div>

<div class="viewcode-block" id="MadaclimCollection.binary_encode_categorical"><a class="viewcode-back" href="../../py_madaclim.html#py_madaclim.raster_manipulation.MadaclimCollection.binary_encode_categorical">[docs]</a>    <span class="k">def</span> <span class="nf">binary_encode_categorical</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Binary encodes the categorical layers contained in the `sampled_layers` attribute.</span>

<span class="sd">        This function performs binary encoding of categorical layers</span>
<span class="sd">        found in the raster data for each of the Point in the collection.</span>
<span class="sd">        After the encoding, the function updates the Collection instance&#39;s</span>
<span class="sd">        attributes for the categorical encoding status, the encoded</span>
<span class="sd">        layers and the gdf replacing the categorical columns by the binary encoded features.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the MadaclimCollection doesn&#39;t contain any MadaclimPoints</span>
<span class="sd">                or if the raster data has not been sampled yet.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Notes:</span>
<span class="sd">            See the `binary_encode_categorical` method for logic and possible raised exceptions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No MadaclimPoint to sample from in the Collection.&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Raster data for each point of the collection have not been sampled yet&quot;</span>
                <span class="s2">&quot;Use `sample_from_rasters` method prior to `binary_encode_categorical`.&quot;</span>
            <span class="p">)</span>
        
        <span class="n">encoded_categ</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">encoded_labels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">:</span>
            <span class="n">point</span><span class="o">.</span><span class="n">binary_encode_categorical</span><span class="p">()</span>
            <span class="n">encoded_categ</span><span class="p">[</span><span class="n">point</span><span class="o">.</span><span class="n">specimen_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">encoded_categ_layers</span>   <span class="c1"># Extract label: value pairs</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">encoded_categ_layers</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">encoded_labels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">encoded_labels</span><span class="p">)</span>

        <span class="c1"># Update categorical layers-related attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_categorical_encoded</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoded_categ_layers</span> <span class="o">=</span> <span class="n">encoded_categ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoded_categ_labels</span> <span class="o">=</span> <span class="n">encoded_labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_gdf</span><span class="p">()</span></div>
        
    <span class="k">def</span> <span class="nf">_construct_geodataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs a GeoDataFrame from the MadaclimPoint objects stored in the MadaclimCollection.</span>

<span class="sd">        The method fills in missing columns across the collection to standardize the GeoDataFrame.</span>
<span class="sd">        It also reorders the columns based on the presence of sampled layers and their encoding states.</span>
<span class="sd">        The method aims to keep a logical display with sampled layers and/or encoded layers at the right end of the GeoDataFrame.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[str, gpd.GeoDataFrame]: A GeoDataFrame that contains all MadaclimPoint data in a standardized format.</span>
<span class="sd">            In case there are no MadaclimPoint objects in the collection, a string message is returned instead.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If there are no MadaclimPoint objects in the collection.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">collection_gdf</span> <span class="o">=</span> <span class="s2">&quot;No MadaclimPoint to sample from in the Collection.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get all unique and keep the order</span>
            <span class="n">all_points_gdf_cols</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">]</span>
            <span class="c1"># unique_cols_whole_collection = set().union(*all_points_gdf_cols)</span>
            <span class="n">unique_cols_whole_collection</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">all_points_gdf_cols</span><span class="p">,</span> <span class="p">[])))</span>

            <span class="c1"># Fill-in missing cols accross collection to standardize collection gdf</span>
            <span class="n">points_gdfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">:</span>
                <span class="n">point_df</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">gdf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">missing_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">unique_cols_whole_collection</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">point_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">missing_cols</span><span class="p">:</span> 
                    <span class="n">point_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">points_gdfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point_df</span><span class="p">)</span>

            <span class="n">collection_gdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">points_gdfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="c1"># Check in both collection an individual objects for presence sampled_layers and NO categ_encoding state</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_sampled_layers&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_nodata_layers&quot;</span><span class="p">):</span>    <span class="c1"># Avoid block-trigger when constructing with points</span>
                <span class="n">has_sampled_layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">([</span><span class="n">point</span><span class="o">.</span><span class="n">sampled_layers</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">])</span>
                <span class="n">has_not_encoded_layers</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_categorical_encoded</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">point</span><span class="o">.</span><span class="n">is_categorical_encoded</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">])</span>

                <span class="c1"># Reorder the cols to keep logical display + sampled_layers at right end</span>
                <span class="k">if</span> <span class="n">has_sampled_layers</span> <span class="ow">and</span> <span class="n">has_not_encoded_layers</span><span class="p">:</span>
                    <span class="n">all_sampled_layers_cols</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">sampled_layers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span> <span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">sampled_layers</span><span class="p">]</span>
                    <span class="n">unique_sampled_layers_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">all_sampled_layers_cols</span><span class="p">,</span> <span class="p">[])))</span>
                    <span class="n">unsampled_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">collection_gdf</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_sampled_layers_cols</span><span class="p">]</span>
                    <span class="n">new_cols_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unsampled_cols</span><span class="p">)</span> <span class="o">+</span> <span class="n">unique_sampled_layers_cols</span>
                    <span class="n">collection_gdf</span> <span class="o">=</span> <span class="n">collection_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">new_cols_order</span><span class="p">]</span>

            <span class="c1"># Check in both collection an individual objects for sampled_layers and categ_encoding state</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_is_categorical_encoded&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_encoded_categ_layers&quot;</span><span class="p">):</span>    <span class="c1"># Avoid block-trigger when constructing with points</span>
                <span class="n">has_sampled_layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">([</span><span class="n">point</span><span class="o">.</span><span class="n">sampled_layers</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">])</span>
                <span class="n">has_encoded_layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_categorical_encoded</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">([</span><span class="n">point</span><span class="o">.</span><span class="n">is_categorical_encoded</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span><span class="p">])</span>

                <span class="c1"># Reorder the cols to keep logical display + sampled_layers at right end</span>
                <span class="k">if</span> <span class="n">has_sampled_layers</span> <span class="ow">and</span> <span class="n">has_encoded_layers</span><span class="p">:</span>
                    <span class="c1"># Remove the categorical keys from the sampled_layers</span>
                    <span class="n">madaclim_info</span> <span class="o">=</span> <span class="n">MadaclimLayers</span><span class="p">()</span>
                    <span class="n">possible_categ_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">madaclim_info</span><span class="o">.</span><span class="n">get_categorical_combinations</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="n">possible_descriptive_categ_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">madaclim_info</span><span class="o">.</span><span class="n">get_categorical_combinations</span><span class="p">(</span><span class="n">as_descriptive_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    
                    <span class="n">all_sampled_layers_cols</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">sampled_layers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span> <span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">sampled_layers</span><span class="p">]</span>
                    <span class="n">noncateg_sampled_layers_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">ele</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">all_sampled_layers_cols</span> <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">sublist</span> <span class="k">if</span> <span class="n">ele</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">possible_categ_labels</span> <span class="o">+</span> <span class="n">possible_descriptive_categ_labels</span><span class="p">]</span>
                    <span class="n">all_categ_layers_cols</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">encoded_categ_layers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_points</span> <span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">is_categorical_encoded</span><span class="p">]</span>
                    
                    <span class="n">unique_sampled_layers_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">noncateg_sampled_layers_cols</span><span class="p">,</span> <span class="p">[]))</span>
                    <span class="n">unique_encoded_layers_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">all_categ_layers_cols</span><span class="p">,</span> <span class="p">[])))</span>
                    
                    <span class="n">non_sampled_categ_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">collection_gdf</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_sampled_layers_cols</span> <span class="o">+</span> <span class="n">unique_encoded_layers_cols</span><span class="p">]</span>
                    <span class="n">reordered_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">non_sampled_categ_cols</span><span class="p">)</span> <span class="o">+</span> <span class="n">unique_sampled_layers_cols</span> <span class="o">+</span> <span class="n">unique_encoded_layers_cols</span>
                    <span class="n">collection_gdf</span> <span class="o">=</span> <span class="n">collection_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">reordered_cols</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">collection_gdf</span>
    
<div class="viewcode-block" id="MadaclimCollection.plot_on_layer"><a class="viewcode-back" href="../../py_madaclim.html#py_madaclim.raster_manipulation.MadaclimCollection.plot_on_layer">[docs]</a>    <span class="k">def</span> <span class="nf">plot_on_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a layer as a raster map and distribution plot with a focus on the MadaclimPoint object.</span>
<span class="sd">        </span>
<span class="sd">        Based on the Madaclim&#39;s CRS, the MadaclimPoint&#39;s geometry (`mada_geom_point`) is plotted</span>
<span class="sd">        on the raster map and the sampled value is displayed against a distribution of all</span>
<span class="sd">        possible values for that layer in Madaclim db. Pass addition kwargs to customize each</span>
<span class="sd">        subplots (See **kwargs, _LayerPlotter and _LayerConfig for more details).</span>
<span class="sd">        </span>
<span class="sd">        Parameters:</span>
<span class="sd">            layer (Union[str, int]): Layer to plot. Accepts layer numbers as integers, or layer labels in </span>
<span class="sd">                descriptive or `layer_&lt;num&gt;` format.</span>
<span class="sd">            **kwargs: Additional arguments to customize the subplots, imshow, colorbar, histplot and Point objects from matplotlib. </span>
<span class="sd">                Use &quot;subplots_&lt;arg&gt;&quot;, &quot;imshow_&lt;arg&gt;&quot;, &quot;cax_&lt;arg&gt;&quot;, and &quot;barplot_&lt;arg&gt;&quot; formats to customize corresponding </span>
<span class="sd">                the base Raster and barplot plots as matplotlib/sns arguments. </span>
<span class="sd">                Use &quot;point_&lt;arg&gt;&quot; to customize the Point objects on the raster.</span>
<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the specified layer to plot is not has not been sampled yet.</span>
<span class="sd">            ValueError: If the layer label cannot be found within the sampled layers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        #TODO REFACTOR layer_name_range_val and further validation in MadaPoint/Collection as a single class</span>
<span class="sd">        #TODO TO AVOID BAD COPY PRACTICES</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">layer_name_range_validation</span><span class="p">(</span>
                <span class="n">clim_raster</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">],</span>
                <span class="n">env_raster</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">],</span>
                <span class="n">layer</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">py_madaclim</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">MadaclimLayers</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Validates the input layer before the visualization. Checks for valid types and values</span>
<span class="sd">            based on the MadaclimLayers properties.</span>

<span class="sd">            Args:</span>
<span class="sd">                clim_raster (Union[str, pathlib.Path]): Path to the climate raster file.</span>
<span class="sd">                env_raster (Union[str, pathlib.Path]): Path to the environmental raster file.</span>
<span class="sd">                layer (Union[str, int]): Layer to validate. Accepts layer numbers as integers, or layer labels in </span>
<span class="sd">                    descriptive or `layer_&lt;num&gt;` format.descriptive or `layer_&lt;num&gt;` format.</span>

<span class="sd">            Raises:</span>
<span class="sd">                TypeError: If &#39;layer&#39; is not a str or an int.</span>
<span class="sd">                TypeError: If &#39;layer&#39; is a number and cannot be converted to an int.</span>
<span class="sd">                ValueError: If &#39;layer&#39; is not found within the range of layers.</span>

<span class="sd">            Returns:</span>
<span class="sd">                py_madaclim.info.MadaclimLayers: An &#39;MadaclimLayers&#39; instance if layer is valid.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            
            <span class="c1"># Fetch metadata and layer nums with a MadaclimLayers instance</span>
            <span class="n">mada_info</span> <span class="o">=</span> <span class="n">MadaclimLayers</span><span class="p">(</span><span class="n">clim_raster</span><span class="o">=</span><span class="n">clim_raster</span><span class="p">,</span> <span class="n">env_raster</span><span class="o">=</span><span class="n">env_raster</span><span class="p">)</span>
            <span class="n">all_layers_df</span> <span class="o">=</span> <span class="n">mada_info</span><span class="o">.</span><span class="n">all_layers</span>
            
            <span class="c1"># Validate layers to sample</span>
            <span class="n">possible_layers_num_format</span> <span class="o">=</span> <span class="n">mada_info</span><span class="o">.</span><span class="n">get_layers_labels</span><span class="p">()</span>
            <span class="n">possible_layers_desc_format</span> <span class="o">=</span> <span class="n">mada_info</span><span class="o">.</span><span class="n">get_layers_labels</span><span class="p">(</span><span class="n">as_descriptive_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;layer&#39; must be a str or an int.&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">possible_layers_num_format</span> <span class="ow">or</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">possible_layers_desc_format</span><span class="p">:</span>    <span class="c1"># Check layer_&lt;num&gt; or descriptive format</span>
                <span class="n">layer_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">layer_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>    <span class="c1"># As single item int list</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;layer must be either a single int value or a string that can be converted to an int&quot;</span><span class="p">)</span>
    
            <span class="c1"># Validate layer number range for layer_numbers as in</span>
            <span class="n">min_layer</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">all_layers_df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">])</span>
            <span class="n">max_layer</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">all_layers_df</span><span class="p">[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">min_layer</span> <span class="o">&lt;=</span> <span class="n">layer_num</span> <span class="o">&lt;=</span> <span class="n">max_layer</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;layer_number must fall between </span><span class="si">{</span><span class="n">min_layer</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">max_layer</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">layer_num</span><span class="si">=}</span><span class="s2"> is not valid.&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">mada_info</span>

        <span class="c1"># Validate object&#39;s raster-sampled state</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MadaclimCollection__clim_raster</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_MadaclimCollection__env_raster</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;No &#39;clim_raster&#39; and &#39;env_raster&#39; found, use &#39;sample_from_rasters&#39; prior to setup a reference to the raster files location.&quot;</span>
            <span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No sampled layers to plot.&quot;</span><span class="p">)</span>

        <span class="c1"># Layer validation pre-plotting and helper MadaclimLayers instance</span>
        <span class="n">mada_rasters</span> <span class="o">=</span> <span class="n">MadaclimRasters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MadaclimCollection__clim_raster</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MadaclimCollection__env_raster</span><span class="p">)</span>
        <span class="n">mada_info</span> <span class="o">=</span> <span class="n">layer_name_range_validation</span><span class="p">(</span><span class="n">mada_rasters</span><span class="o">.</span><span class="n">clim_raster</span><span class="p">,</span> <span class="n">mada_rasters</span><span class="o">.</span><span class="n">env_raster</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span>

        <span class="c1"># Possible labels for layer to plot</span>
        <span class="n">layer_number</span> <span class="o">=</span> <span class="n">mada_info</span><span class="o">.</span><span class="n">fetch_specific_layers</span><span class="p">(</span><span class="n">layer</span><span class="p">)[</span><span class="s2">&quot;layer_number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">layer_possible_labels</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">mada_info</span><span class="o">.</span><span class="n">get_layers_labels</span><span class="p">(</span><span class="n">layer_number</span><span class="p">)</span> <span class="o">+</span> 
            <span class="n">mada_info</span><span class="o">.</span><span class="n">get_layers_labels</span><span class="p">(</span><span class="n">layer_number</span><span class="p">,</span> <span class="n">as_descriptive_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="c1"># Check for sampling state on instance</span>
        <span class="n">sampled_layers_labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">sampled_layers_dicts</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampled_layers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">sampled_layer</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">sampled_layers_dicts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">sampled_layers_labels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sampled_layer</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">layer_to_plot</span> <span class="ow">in</span> <span class="n">sampled_layers_labels</span> <span class="k">for</span> <span class="n">layer_to_plot</span> <span class="ow">in</span> <span class="n">layer_possible_labels</span><span class="p">]):</span>                
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;At this current state input layer &#39;</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">&#39; (possible labels=</span><span class="si">{</span><span class="n">layer_possible_labels</span><span class="si">}</span><span class="s2">) &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;has not been sampled yet (sampled_layers=</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">sampled_layers_labels</span><span class="p">)</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Use the &#39;sample_from_rasters&#39; method to address that prior to &#39;plot_on_layer&#39;.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Extract gdf Point plotting configs + defaults</span>
        <span class="n">plot_cfg</span> <span class="o">=</span> <span class="n">_PlotConfig</span><span class="p">(</span><span class="n">plot_element_args</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="s2">&quot;palette&quot;</span> <span class="ow">in</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">rasterpoint_args</span> <span class="ow">and</span> <span class="s2">&quot;palette&quot;</span> <span class="ow">in</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">barplot_args</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only set a palette for &#39;rasterpoint_palette&#39; or &#39;barplot_palette&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;palette&quot;</span> <span class="ow">in</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">rasterpoint_args</span><span class="p">:</span>
            <span class="n">common_palette</span> <span class="o">=</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">rasterpoint_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;palette&quot;</span><span class="p">,</span> <span class="s2">&quot;husl&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;palette&quot;</span> <span class="ow">in</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">barplot_args</span><span class="p">:</span>
            <span class="n">common_palette</span> <span class="o">=</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">barplot_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;palette&quot;</span><span class="p">,</span> <span class="s2">&quot;husl&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">common_palette</span> <span class="o">=</span> <span class="s2">&quot;husl&quot;</span>
        
        <span class="n">rasterpoint_args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;palette&quot;</span><span class="p">:</span> <span class="n">common_palette</span><span class="p">,</span>
            <span class="s2">&quot;markersize&quot;</span><span class="p">:</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">rasterpoint_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;markersize&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
            <span class="s2">&quot;marker&quot;</span><span class="p">:</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">rasterpoint_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;marker&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">),</span>
            <span class="s2">&quot;edgecolor&quot;</span><span class="p">:</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">rasterpoint_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;edgecolor&quot;</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">),</span>
            <span class="s2">&quot;linestyle&quot;</span><span class="p">:</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">rasterpoint_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;linestyle&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span>
            <span class="s2">&quot;legend&quot;</span><span class="p">:</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">rasterpoint_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;legend&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="s2">&quot;legend_kwds&quot;</span><span class="p">:</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">rasterpoint_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;legend_kwds&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)}),</span>
            <span class="s2">&quot;customlabel&quot;</span><span class="p">:</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">rasterpoint_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;customlabel&quot;</span><span class="p">,</span> <span class="s2">&quot;Collection&quot;</span><span class="p">),</span>
            <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">rasterpoint_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="s2">&quot;white&quot;</span><span class="p">)</span>

        <span class="p">}</span>

        <span class="c1"># Plot base raster and distribution histograms</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">mada_rasters</span><span class="o">.</span><span class="n">plot_layer</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">raster_legend</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span>
        
        <span class="c1"># Generate a color palette for both raster and barplots</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gdf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">specimen_ids</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;specimen_id&quot;</span><span class="p">]</span>
        <span class="n">palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="n">common_palette</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">specimen_ids</span><span class="p">))</span>
        <span class="n">color_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">specimen_ids</span><span class="p">,</span> <span class="n">palette</span><span class="p">))</span>
        <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;_color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;specimen_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">color_map</span><span class="p">)</span>

        <span class="c1"># Overlay with mada_geom_point</span>
        <span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
            <span class="n">color</span><span class="o">=</span><span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;_color&quot;</span><span class="p">],</span> 
            <span class="n">markersize</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;markersize&quot;</span><span class="p">],</span> 
            <span class="n">marker</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;marker&quot;</span><span class="p">],</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;edgecolor&quot;</span><span class="p">],</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;linestyle&quot;</span><span class="p">],</span>
            <span class="n">legend</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">],</span> 
            <span class="n">legend_kwds</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;legend_kwds&quot;</span><span class="p">],</span>
            <span class="o">**</span><span class="n">plot_cfg</span><span class="o">.</span><span class="n">rasterpoint_args</span>
        <span class="p">)</span>

        <span class="c1"># Create a custom legend based on the rasterpoint_args</span>
        <span class="k">if</span> <span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">]:</span>
            <span class="n">legend_handle</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">(</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                <span class="n">marker</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;marker&quot;</span><span class="p">],</span>
                <span class="n">markersize</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;markersize&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">20</span><span class="p">,</span>
                <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;edgecolor&quot;</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">],</span> 
                <span class="n">linestyle</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;linestyle&quot;</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;customlabel&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">legend_handle</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="n">rasterpoint_args</span><span class="p">[</span><span class="s2">&quot;legend_kwds&quot;</span><span class="p">][</span><span class="s2">&quot;loc&quot;</span><span class="p">])</span>

        <span class="c1"># Add the raster legend back to the plot in a different location</span>
        <span class="k">if</span> <span class="n">raster_legend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">raster_legend</span><span class="p">)</span>
            <span class="n">raster_legend</span><span class="o">.</span><span class="n">set_bbox_to_anchor</span><span class="p">((</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        
        <span class="c1">#TODO refactor inside _LayerPlotter.plot_layer instead of plot/clear/replot cycle</span>
        <span class="c1"># Clear whole raster distribution and replace with collection data</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        
         <span class="c1"># Set defaults for barplot</span>
        <span class="n">actual_layer_label</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">layer_possible_labels</span> <span class="k">if</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">barplot_args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">barplot_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">actual_layer_label</span><span class="p">),</span>
            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">plot_cfg</span><span class="o">.</span><span class="n">barplot_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;specimen_id&quot;</span><span class="p">),</span>
        <span class="p">}</span>
        
        <span class="n">bar</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">gdf</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">barplot_args</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span>
            <span class="n">x</span><span class="o">=</span><span class="n">barplot_args</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">palette</span><span class="o">=</span><span class="n">color_map</span><span class="p">,</span>
            <span class="o">**</span><span class="n">plot_cfg</span><span class="o">.</span><span class="n">barplot_args</span>
        <span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Distribution of sampled raster values for specimens in the collection&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;specimen id&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Raster value&quot;</span><span class="p">)</span></div>
    
    <span class="k">def</span> <span class="nf">_update_gdf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the internal GeoDataFrame of the MadaclimCollection.</span>

<span class="sd">        The method sets the internal `_gdf` attribute to the GeoDataFrame constructed by the `_construct_geodataframe` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_geodataframe</span><span class="p">()</span></div>
        
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Tahiri Lab.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>